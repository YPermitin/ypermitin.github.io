<!DOCTYPE html><html lang="en" translate="no"><head><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1"/><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="google" content="notranslate"/><title>Надежная регистрация изменений. Версионирование объектов. Аудит. Все средствами SQL Server | Убежище инженера | YPermitin</title><meta name="robots" content="index,follow"/><meta name="description" content="Высший пилотаж с механизмом Change Data Capture от SQL Server в связке с платформой 1C."/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://ypermitin.github.io/blog/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C"/><meta property="og:title" content="Надежная регистрация изменений. Версионирование объектов. Аудит. Все средствами SQL Server | Убежище инженера | YPermitin"/><meta property="og:description" content="Высший пилотаж с механизмом Change Data Capture от SQL Server в связке с платформой 1C."/><meta property="og:url" content="https://ypermitin.github.io/blog/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C"/><meta property="og:type" content="website"/><meta property="og:image" content="https://ypermitin.github.io/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/logo.png"/><meta property="og:image:alt" content="Надежная регистрация изменений. Версионирование объектов. Аудит. Все средствами SQL Server | Убежище инженера | YPermitin"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:locale" content="en_IN"/><meta property="og:site_name" content="Убежище инженера"/><link rel="canonical" href="https://webexpe.com/"/><meta property="keywords" content="регистрация изменений, оптимизация, производительность, 1С:Предприятие, интеграция, SQL Server, CDC, аудит"/><meta property="al:web:url" content="https://ypermitin.github.io/blog/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C"/><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/8b3cba25ed5aab85.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8b3cba25ed5aab85.css" data-n-g=""/><link rel="preload" href="/_next/static/css/0eb3a85c2cff7e2b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0eb3a85c2cff7e2b.css"/><link rel="preload" href="/_next/static/css/4a9df9e795bce52b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4a9df9e795bce52b.css"/><link rel="preload" href="/_next/static/css/ee5420a43edabb61.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ee5420a43edabb61.css"/><link rel="preload" href="/_next/static/css/88381d5dde4793c2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/88381d5dde4793c2.css"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script defer="" src="/_next/static/chunks/fea29d9f.da8a8f09d3718005.js"></script><script defer="" src="/_next/static/chunks/3a17f596.d968b285fd30f253.js"></script><script defer="" src="/_next/static/chunks/1664-939297b106bd6802.js"></script><script defer="" src="/_next/static/chunks/8765.cad5003c27b9f0f8.js"></script><script defer="" src="/_next/static/chunks/3220.ec5fcfa981be0259.js"></script><script defer="" src="/_next/static/chunks/935.690ee438ec544a58.js"></script><script defer="" src="/_next/static/chunks/7355.94d3f9b1029286e4.js"></script><script defer="" src="/_next/static/chunks/7651.2742bb467d45fe42.js"></script><script src="/_next/static/chunks/webpack-451d3a1cddcb1b37.js" defer=""></script><script src="/_next/static/chunks/framework-0995a3e8436ddc4f.js" defer=""></script><script src="/_next/static/chunks/main-01bf6de1df60b879.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ce77bf80cc22a9a7.js" defer=""></script><script src="/_next/static/chunks/6443-e0562366e025b4bf.js" defer=""></script><script src="/_next/static/chunks/pages/blog/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C-3b68ebe6b97bf098.js" defer=""></script><script src="/_next/static/3OSMF01S1TFJk6CkfZ1cn/_buildManifest.js" defer=""></script><script src="/_next/static/3OSMF01S1TFJk6CkfZ1cn/_ssgManifest.js" defer=""></script></head><body class="bg-slate-100 dark:bg-slate-900 transition-all"><div id="__next"><div data-overlay-container="true"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><nav class="Navbar_navbar__W_ouQ bg-white  dark:bg-slate-900 dark:text-white text-black"><div class="container flex items-center justify-between px-2"><div class="flex items-center"><div class="Navbar_mobileBurgerToggle__Bj_52 mr-5  "><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="dark:text-white text-black text-2xl" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></div><a class="text-[22px] font-semibold" href="/">Убежище инженера</a></div><div class="flex items-center"><div class="text-[14px] font-normal items-center lg:flex hidden"><a class="cursor-pointer hover:text-blue-500 mx-2" href="/">Главная</a><div class="relative"><div class="flex items-center cursor-pointer mx-2"><p class="my-0">Блог</p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-[20px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path></svg></div><div class="overflow-auto absolute w-[180px] z-20 top-[30px] rounded-[4px] shadow-lg bg-white dark:bg-slate-800 border border-gray-300 dark:border-0 h-0 border-0"><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2" href="/blog/"><span>Все публикации</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=DevOps"><span style="text-transform:capitalize">DevOps</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=.NET"><span style="text-transform:capitalize">.NET</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=PostgreSQL"><span style="text-transform:capitalize">PostgreSQL</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=SQL%20Server"><span style="text-transform:capitalize">SQL Server</span></a></div></div><a class="cursor-pointer hover:text-blue-500 mx-2" href="/instruments/">Инструменты</a><a class="cursor-pointer hover:text-blue-500 mx-2" href="/about/">Обо мне</a><a class="cursor-pointer hover:text-blue-500 mx-2" href="/contact/">Контакты</a><div class="ml-5 pt-1"><a href="https://github.com/YPermitin/" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><a href="https://t.me/TinyDevVault" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"></path></svg></a><a href="mailto:i.need.ypermitin@yandex.ru" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0 0 68.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg></a><a href="https://boosty.to/ypermitin" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 21h9.62a3.995 3.995 0 0 0 3.037-1.397l5.102-5.952a1 1 0 0 0-.442-1.6l-1.968-.656a3.043 3.043 0 0 0-2.823.503l-3.185 2.547-.617-1.235A3.98 3.98 0 0 0 9.146 11H4c-1.103 0-2 .897-2 2v6c0 1.103.897 2 2 2zm0-8h5.146c.763 0 1.448.423 1.789 1.105l.447.895H7v2h6.014a.996.996 0 0 0 .442-.11l.003-.001.004-.002h.003l.002-.001h.004l.001-.001c.009.003.003-.001.003-.001.01 0 .002-.001.002-.001h.001l.002-.001.003-.001.002-.001.002-.001.003-.001.002-.001c.003 0 .001-.001.002-.001l.003-.002.002-.001.002-.001.003-.001.002-.001h.001l.002-.001h.001l.002-.001.002-.001c.009-.001.003-.001.003-.001l.002-.001a.915.915 0 0 0 .11-.078l4.146-3.317c.262-.208.623-.273.94-.167l.557.186-4.133 4.823a2.029 2.029 0 0 1-1.52.688H4v-6zM16 2h-.017c-.163.002-1.006.039-1.983.705-.951-.648-1.774-.7-1.968-.704L12.002 2h-.004c-.801 0-1.555.313-2.119.878C9.313 3.445 9 4.198 9 5s.313 1.555.861 2.104l3.414 3.586a1.006 1.006 0 0 0 1.45-.001l3.396-3.568C18.688 6.555 19 5.802 19 5s-.313-1.555-.878-2.121A2.978 2.978 0 0 0 16.002 2H16zm1 3c0 .267-.104.518-.311.725L14 8.55l-2.707-2.843C11.104 5.518 11 5.267 11 5s.104-.518.294-.708A.977.977 0 0 1 11.979 4c.025.001.502.032 1.067.485.081.065.163.139.247.222l.707.707.707-.707c.084-.083.166-.157.247-.222.529-.425.976-.478 1.052-.484a.987.987 0 0 1 .701.292c.189.189.293.44.293.707z"></path></svg></a></div></div><div class="Navbar_search_icon_wrapper__1a_rL ml-5 dark:text-white"><button name="search-button" aria-label="search button"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="dark:text-white text-black text-[22px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></button></div><div class=""><button name="share" aria-label="share page"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="dark:text-white text-black text-[16px] mt-[7px] ml-2 mr-1" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.5 2.5 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5"></path></svg></button></div><button name="theme-switch" aria-label="theme button" class="Navbar_theme_switch__q7F_Z pl-3 dark:text-white text-black"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-md " height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"></path></svg></button></div></div></nav><aside class="Navbar_nav_sidebar_wrapper__M0KaI dark:bg-slate-900 dark:text-white bg-white text-black"><div class="flex items-center justify-between pb-3"><p class="">МЕНЮ</p><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-slate-800 dark:text-white text-[25px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0V0z"></path><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg></div></div><hr/><div class="my-15"><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/">Главная</a><div class="relative"><div class="flex items-center cursor-pointer justify-between"><p class="my-0">Блог</p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-[20px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path></svg></div><div class="overflow-auto relative h-0 border-0"><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2" href="/blog/"><span>Все публикации</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=DevOps"><span style="text-transform:capitalize">DevOps</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=.NET"><span style="text-transform:capitalize">.NET</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=PostgreSQL"><span style="text-transform:capitalize">PostgreSQL</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=SQL%20Server"><span style="text-transform:capitalize">SQL Server</span></a></div></div><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/instruments/">Инструменты</a><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/about/">Обо мне</a><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/contact/">Контакты</a></div><hr/><div class="my-5"><p class="font-light">Подписаться : </p> <a href="https://github.com/YPermitin/" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><a href="https://t.me/TinyDevVault" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"></path></svg></a><a href="mailto:i.need.ypermitin@yandex.ru" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0 0 68.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg></a><a href="https://boosty.to/ypermitin" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 21h9.62a3.995 3.995 0 0 0 3.037-1.397l5.102-5.952a1 1 0 0 0-.442-1.6l-1.968-.656a3.043 3.043 0 0 0-2.823.503l-3.185 2.547-.617-1.235A3.98 3.98 0 0 0 9.146 11H4c-1.103 0-2 .897-2 2v6c0 1.103.897 2 2 2zm0-8h5.146c.763 0 1.448.423 1.789 1.105l.447.895H7v2h6.014a.996.996 0 0 0 .442-.11l.003-.001.004-.002h.003l.002-.001h.004l.001-.001c.009.003.003-.001.003-.001.01 0 .002-.001.002-.001h.001l.002-.001.003-.001.002-.001.002-.001.003-.001.002-.001c.003 0 .001-.001.002-.001l.003-.002.002-.001.002-.001.003-.001.002-.001h.001l.002-.001h.001l.002-.001.002-.001c.009-.001.003-.001.003-.001l.002-.001a.915.915 0 0 0 .11-.078l4.146-3.317c.262-.208.623-.273.94-.167l.557.186-4.133 4.823a2.029 2.029 0 0 1-1.52.688H4v-6zM16 2h-.017c-.163.002-1.006.039-1.983.705-.951-.648-1.774-.7-1.968-.704L12.002 2h-.004c-.801 0-1.555.313-2.119.878C9.313 3.445 9 4.198 9 5s.313 1.555.861 2.104l3.414 3.586a1.006 1.006 0 0 0 1.45-.001l3.396-3.568C18.688 6.555 19 5.802 19 5s-.313-1.555-.878-2.121A2.978 2.978 0 0 0 16.002 2H16zm1 3c0 .267-.104.518-.311.725L14 8.55l-2.707-2.843C11.104 5.518 11 5.267 11 5s.104-.518.294-.708A.977.977 0 0 1 11.979 4c.025.001.502.032 1.067.485.081.065.163.139.247.222l.707.707.707-.707c.084-.083.166-.157.247-.222.529-.425.976-.478 1.052-.484a.987.987 0 0 1 .701.292c.189.189.293.44.293.707z"></path></svg></a><hr class="mt-5"/></div><div class="mt-5 mb-4"><p class="mb-2 font-light">Переключиться на <!-- -->светлую<!-- --> тему :</p><button name="theme-switch" aria-label="theme-switch" class="Navbar_theme_switch__q7F_Z dark:text-white text-black"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-lg" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"></path></svg></button></div><hr/><div class="my-5"><p class="text-sm font-light dark:text-gray-400 text-gray-500 mb-1">Copyright © 2024</p></div></aside><div class="transition-all fixed h-screen w-screen flex items-center justify-center left-0 z-20 top-0 pointer-events-none opacity-0"><div class="absolute top-0 left-0 w-screen h-screen bg-black opacity-50"></div><div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded lg:w-1/6 mx-3 w-full relative z-10 transition-all top-10"><div class="flex border-gray-300 pb-2 mb-3 border-b"><p class="  font-medium w-full">Share:</p><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"></path></svg></span></div><div class="flex flex-wrap items-center"><a class="mr-3" aria-label="facebook-share" href="https://www.facebook.com/sharer/sharer.php?u=https://ypermitin.github.io" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-92.4 233.5h-63.9c-50.1 0-59.8 23.8-59.8 58.8v77.1h119.6l-15.6 120.7h-104V912H539.2V602.2H434.9V481.4h104.3v-89c0-103.3 63.1-159.6 155.3-159.6 44.2 0 82.1 3.3 93.2 4.8v107.9z"></path></svg></a><a class="mr-3" aria-label="twitter-share" href="http://twitter.com/share?text=Check out this article!! &amp;url=https://ypermitin.github.io&amp;hashtags=webdevelopment,javacript,javascriptdaily,webdevelopmenttutorial,tutorial" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm215.3 337.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg></a><a class="mr-3" aria-label="linkedin-share" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ypermitin.github.io&amp;title=Check out this article!!&amp;source=LinkedIn" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[23px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"></path></svg></a><button class="mr-3" name="copy-link" aria-label="copy-link"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"></path></svg></button></div><div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed flex transition-all right-[10px] -bottom-20 opacity-0" role="alert"><strong class="font-bold">Link Copied</strong><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"></path></svg></span></div></div></div><section class="PageLayout_centered_article_wrapper__gS3Af dark:bg-slate-900 dark:text-white"><div class="container px-0 md:px-[15px] pt-[50px] pb-[50px]"><article class="PageLayout_article_content__4dnq3 pb-[30px] px-3 bg-white dark:bg-slate-800 dark:border-none dark:drop-shadow-lg dark:text-white pt-10 md:pt-0 mx-auto font-regular text-lg leading-relaxed"><div class="mb-[30px]"><h1 class="ArticleHeader_articleTitle__3L1Bi text-center text-2xl md:text-4xl font-medium mt-[20px] mb-[5px]">Надежная регистрация изменений. Версионирование объектов. Аудит. Все средствами SQL Server</h1><div class="mb-[10px] mt-[15px] text-[14px] font-medium ArticleHeader_centered_article_header_author___gRtE"><p class="my-0 mx-[30px] font-medium">YPermitin<span class="px-1 font-light">в</span><a href="/blog/?category=SQL%20Server">SQL Server</a></p><p class="my-0">2022-06-14</p></div><div class="md:mt-2 flex flex-wrap justify-center"><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->регистрация изменений</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->оптимизация</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->производительность</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->1С:Предприятие</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->интеграция</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->SQL Server</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->CDC</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->аудит</p></div></div><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Следи за рукой</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Знание - сила! А знание, подкрепленное фактами, достоверными данными и высокой актуальностью - это сила, ответственность и безграничные возможности в части анализа информации.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Не такая уж и редкая задача - получить историю изменения данных, узнать кто, что и когда изменил в том или ином объекте. Пореже нужно отправлять изменения в другие информационные системы или даже хранилища данных, для чего создаются различные способы регистрации изменений. Но хоть эти задачи и звучат просто, но чем больше система и чем сложнее архитектура потоков данных, тем больше проблем с этим возникает:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Проблемы производительности при регистрации изменений в высоконагруженных системах</li><li>Критичность ошибок регистрации данных, если часть изменений не будет зарегистрирована или потеряна</li><li>Высокая детализация изменений приводит к значительному росту базы данных и таблиц регистрации, в частности, а также существенно может замедлять процессы в информационной системе</li><li>Отправка изменений системам-подписчикам требует большой надежности и скорости работы</li><li>И много других вопросов, с которыми придется столкнуться.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И это нормально! Не нормально - это пытаться использовать один “универсальный” инструмент для решения всех этих задач, проблем.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Так давайте пойдем дальше и посмотрим на один из путей решения. Один из множества. А именно на механизм <b><u><a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-Track-Data-Changes" target="_blank" rel="noopener noreferrer">Change Data Capture из SQL Server</a></u></b>. И путь его использования с платформой 1С.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Обычный ход</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Прежде чем начать нужно сказать пару слов о том как это обычно делается в мире 1С. Примерно это выглядит так:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Планы обмена</b> - объекты конфигурации 1С, задача которых предоставить инфраструктуру для регистрации изменений, формирования и обработки сообщений и возможность использования распределенной информационной базы (что не обязательно). При этом сам механизм имеет как плюсы, так и минусы. Подробно на этом останавливаться не будем, но в высоконагруженных системах использовать планы обмена дело последнее из-за узких мест в его работе.</li><li><b>Собственная таблица регистрации</b> - обычно реализуется на регистрах сведений, но бывают и более извращенные случаи. Фактически создается отдельная таблица, где разработчик может более гибким образом управлять статусами объекта. В основном так решаются задачи регистрации изменений только для обмена со сторонними системами. Истории изменений самих данных как таковых нет.</li><li><b>Версионирование объектов</b> - штатный механизм из БСП и его вариации в виде регистра сведений, в котором сохраняется сериализованная версия объекта на момент изменения. Относительно популярный подход хранения изменений объекта с детализацией до конкретных полей, но влияющий как на скорость записи в базу (обычно незначительно, относительно основного времени записи), так и на размер самой базы (а этот фактор уже очень сильный, иногда половину размера базы может занять история версий объектов, особенно если их не чистить).<ul class="List_list__zLjGi list-disc pl-[30px]"><li>Сам подход хранения версий был настолько популярен, что в итоге подобный же механизм включили на уровне самой платформы 1С в виде “Истории данных”, который проще в использовании, но имеет меньше контроля над своей работой. И больше ошибок, хотя с ними сталкивался достаточно давно и в новых версиях может все работает намного лучше.</li><li>Механизм решает задачу хранения истории изменений, но работает относительно медленно при чтении данных версий, т.к. каждую из них нужно предварительно распаковать или нормализовать.</li></ul></li><li><b>Журнал регистрации</b> - еще один штатных механизм для логирования изменений, но на верхнем уровне. Больше подходит для задач аудита и то не всегда. Содержит информацию кто, что и когда изменил, а также большое количество других событий для анализа. В части отслеживания изменений может помочь увидеть только сам факт изменения и его инициатора, но на вопросы кто изменил и что точный ответ дать не сможет. Хотя есть умельцы, которые версии объектов в виде текста сохраняют в журнал регистрации. Без комментариев. В целом механизм медленный и не поддающийся нормальной интеграции с другими инструментами и системами, только через различные костыли.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Это основное, что касается задач регистрации изменений и хранения истории версий объектов. Есть и другие пути, которые в мире 1С часто используют, немного выходя за границы платформы. Но об этом смысла рассказывать нет. Перейдем к теме статьи.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Берем под контроль</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Отбросим штатные средства и попытаемся использовать механизм регистрации изменений<b><u><a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-Track-Data-Changes" target="_blank" rel="noopener noreferrer">Change Data Capture из SQL Server. </a></u></b>Главная причина, почему будем использовать именно его - доступность (SQL Server до сих пор самая популярная СУБД для систем на базе 1С), высокая производительность и детализация истории изменений. Хотя и для <b><u><a href="https://datacater.io/blog/2021-09-02/postgresql-cdc-complete-guide.html" target="_blank" rel="noopener noreferrer">PostgreSQL подобные возможности есть</a></u></b>, но мы их рассматривать не будем. Поехали!</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Общая архитектура</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В чем суть механизма CDC? Вы включаете для базы данных поддержку использования CDC, затем включаете отслеживание изменений для конкретных таблиц базы данных. При внесении изменений в таблицы, информация об этом появляется в журнале транзакций, вне зависимости от модели восстановления базы данных (простой или полной) и вот именно эти данные из журнала транзакций и служат источником информации о вносимых изменениях.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Фоновый процесс сканирует записи в журнале транзакций и загружает их в таблицы регистрации изменений, которые механизм CDC создает автоматически на каждую отслеживаемую таблицу. Таким образом, регистрация изменений происходит асинхронно и не влияет явно на операции в базе данных.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_xs__E5xhu display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/1. Схема CDC.png" alt="Схема CDC" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">При включении поддержки CDC для всей базы сначала создаются служебные таблицы в схеме “cdc”, информацию о которых Вы можете узнать в официальной документации (в SSMS их можно найти в списке системных таблиц):</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>[cdc].[change_tables]</li><li>[cdc].[ddl_history]</li><li>[cdc].[lsn_time_mapping]</li><li>[cdc].[captured_columns]</li><li>[cdc].[index_columns]</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Как только Вы включаете регистрацию изменений для конкретной таблицы, например, для таблицы [dbo].[v8users], то сразу добавляется таблица для сохранения изменений [cdc].[dbo_v8users_CT] со структурой, аналогичной исходной таблице, но при этом с дополнительными служебными полями:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>[__$start_lsn]</b> - Регистрационный номер транзакции в журнале (LSN), связанный с фиксацией транзакции изменения.</li><li><b>[__$end_lsn]</b> - Указано только в ознакомительных целях. Не поддерживается. Совместимость с будущими версиями не гарантируется.</li><li><b>[__$seqval]</b> - Значение последовательности, используемое для упорядочивания изменений строк в пределах транзакции.</li><li><b>[__$operation]</b> - Определяет операцию языка обработки данных (DML). 1 - удаление, 2 - вставка, 3 - обновление (старые значения), 4 - обновление (новые значения).</li><li><b>[__$command_id]</b> - Отслеживает порядок операций в транзакции.</li></ul><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_small__BEVeh display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/2. Хранимые процедуры CDC.png" alt="Хранимые процедуры CDC" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Таким образом, механизм CDC позволяет собрать историю изменения данных в таблицах на физическом уровне, что предоставляет максимальную детализацию истории изменений. Но это также создает некоторые особенности в части обработки этих данных, т.к. некоторые операции могут формировать несколько операций в истории изменения данных. Например, операция обновления может быть представлена операцией удаления и операцией добавления, но с одним идентификатором транзакции. Это нужно учитывать.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_small__BEVeh display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/3. Функции CDC.png" alt="Функции CDC" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Кроме служебных таблиц в базе появляются также объекты:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Множество служебных хранимых процедур в схеме “cdc”.</li><li>И функции для удобного получения истории изменений по таблицам.</li><li>Задания для загрузки изменений из журнала транзакций и очистки исторических данных.</li><li>И некоторые другие объекты.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И все было бы хорошо, но просто так CDC подружить с 1С не получится, т.к. появятся следующие проблемы:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>При проведении реструктуризации базы данных механизм CDC для обновляемой таблицы будет отключен и нужно будет его вручную включить обратно.</li><li>В момент отключения механизма CDC из-за реструктуризации может появиться потеря информации об изменениях.</li><li>И, конечно, будет проблема в части использования информации об изменении данных из CDC, ведь официальной поддержки у платформы 1С для этого механизма нет.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Но не стоит отчаиваться, так как все эти проблемы можно решить. Этим мы и займемся дальше. В одной статье полноценно все рассказать нельзя, но направление работ определить точно можно.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Делаем настройку</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Данный подход по настройке CDC подходит для любых приложений, которые используют SQL Server в качестве СУБД.<b><u><a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-Track-Data-Changes/CDC-Under-Control" target="_blank" rel="noopener noreferrer">Подробные шаги по настройке описаны здесь. </a></u></b>Мы будем адаптировать подход к информационной базе 1С.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Подготовка</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">На первом шаге создадим в базе новую схему данных “yy”, чтобы все новые объекты хранить там и не смешивать их с объектами платформы 1С.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-fXSgRJ sc-JrEyx faRnqX CtKKW prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">SCHEMA</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AUTHORIZATION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Первым объектом в новой схеме станет таблица настроек. В ней мы будем хранить следующую информацию:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Имя исходной таблицы в базе данных, для которой мы хотим поддерживать настройки CDC.</li><li>Флаг использования CDC.</li><li>Имя таблицы CDC, которая была создана системой автоматически. Вручную не заполняем (!!!).</li><li>Текущее имя таблицы, куда переадресуется сохранение регистрируемых данных. То есть данные в основной таблице CDC мы хранить не будем, они будут переадресованы в нашу собственную таблицу. Этот параметр вручную заполнять не нужно (!!!), все будет сделано автоматически.</li><li>И данные, по которым мы можем определить изменяли ли таблицу DDL-командами: идентификатор объекта и дата последнего изменения объекта.</li></ul><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-fjvwmM sc-bbSYpP iycoQw cLQVUo prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Таблица настроек CDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MaintenanceSettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IDENTITY</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SchemaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">UseCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">bit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SchemaNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableNameCDCHistory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">CaptureInstanceCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableObjectId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableSchemaLastChangeDate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">datetime2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">7</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">CONSTRAINT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PK_MaintenanceSettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">KEY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CLUSTERED</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ASC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">PRIMARY</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">PRIMARY</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Индекс для защиты уникальности настроек. На одну таблицу в схеме данных</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- может быть только одна настройка.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">UNIQUE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">NONCLUSTERED</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INDEX</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">UX_MaintenanceSettingsCDC_BySchemaAndTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MaintenanceSettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SchemaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ASC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ASC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">PRIMARY</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Фактически, интерактивно нужно заполнять лишь поля SchemaName, TableName и UseCDC, а остлаьное будет заполнено автоматически.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Дополнительно создадим две функции, которые будут возвращать имена схем. Это просто для удобства.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Небольшие служебные объекты</h2><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-fBWQee sc-hknPuZ dDoTSr fYDKyo prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Функция возвращает имя схемы данных CDC по умолчанию.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Маловероятно, что Вам придется как-то эту часть изменять.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">GetCDCSchemeName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURNS</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURN</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;cdc&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Функция возвращает имя схемы данных, где будут находиться служебные объекты.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Вы можете изменить ее под свои нужды. Только не забудьте исправить имя схемы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- в DDL-скриптах создания объектов базы данных.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">GetMainSchemeName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURNS</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURN</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;yy&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И самое главное в части настроек - это добавить процедуру для автоматического заполнения служебных полей, ведь вручную мы указываем только:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Имя схемы исходной таблицы</li><li>Имя исходной таблицы</li><li>И флаг использования CDC</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Вот как будет выглядеть эта процедура.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Процедура обновления служебных полей в настройке</h2><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-uVXKs sc-hCPjmr dwTABu gWZlxw prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Процедура для обновления служебных полей настроек CDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">UpdateServiceMaintenanceSettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaNameCDC</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">null</span><span class="token plain"> output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDC</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">null</span><span class="token plain"> output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDCHistory</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">null</span><span class="token plain"> output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@captureInstanceCDC</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">null</span><span class="token plain"> output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableObjectId</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">null</span><span class="token plain"> output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableSchemaLastChangeDate</span><span class="token plain"> datetime2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">null</span><span class="token plain"> output</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@schameName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> NOCOUNT </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TRAN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@schameName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> SchemaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TableName</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MaintenanceSettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> ID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Получаем идентификатор исходной таблицы,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- а также дату последнего изменения таблицы DDL-командами</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@currentCDCEnabled</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">bit</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableObjectId</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableSchemaLastChangeDate</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> create_date </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> modify_date </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> create_date</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> modify_date</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">tables</span><span class="token plain"> tb</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schemas s </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">on</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schema_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tb</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schema_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@schameName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> tb</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Сохраняем информацию о CDC:</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">--	* Имя схемы CDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">--	* Имя таблицы CDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">--	* Имя переопределенной таблицы CDC. Внимание! Имя формируется заново</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">--		при каждом вызове. Это нужно учитывать при использовании процедуры</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">--	* Имя экземпляра объекта сбора данных</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaNameCDC</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">GetCDCSchemeName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDC</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OBJECT_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDCHistory</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OBJECT_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;_&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">convert</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">varchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> getdate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">101</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;/&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;_&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">convert</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">varchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> getdate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">108</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;:&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token variable" style="color:rgb(156, 220, 254)">@captureInstanceCDC</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> capture_instance</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">cdc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">change_tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> source_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableObjectId</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Обновляем настройку</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">UPDATE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MaintenanceSettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SchemaNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableNameCDCHistory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDCHistory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">CaptureInstanceCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@captureInstanceCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableObjectId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableObjectId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableSchemaLastChangeDate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableSchemaLastChangeDate</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> ID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">COMMIT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TRAN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Все основные моменты описаны на листинге выше.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь мы готовы перейти к следующему этапу.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Переопределяем поведение</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Платформа 1С во время реструктуризации пересоздает таблицы, что может быть большой проблемой при использовании CDC. После пересоздания таблицы механизм CDC уже по факту отключен и новые изменения не регистрируются. Пока кто-то вручную его не включит, все сделанные изменения с этот момента будут потеряны. Это самая частая проблема в таких сценариях использования.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_small__BEVeh display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/4. Таблица регистрации CDC.png" alt="Таблица регистрации CDC" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для решения этой проблемы предлагается такой вариант:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Изменить поток данных об изменениях, который формируется из файла логов транзакций, таким образом, чтобы изменения записывались не в служебную таблицу CDC (которая как-раз и удаляется при реструктуризации), а в нашу собственную таблицу. Тогда при реструктуризации никаких потерянных изменений не будет.</li><li>Ну а для включения CDC после реструктуризации сделаем некоторое задание (job), которое асинхронно обновит настройки CDC для новых таблиц максимально оперативно.</li></ul><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_small__BEVeh display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/5. Собственные таблицы регистрации CDC.png" alt="Собственные таблицы регистрации CDC" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Первым пунктом и займемся. Схема будет такой:</p><ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Есть штатная таблица CDC, куда SQL Server в реляционном формате сохраняет данные об изменениях. О них мы уже говорили выше. На скриншоте пример такой таблицы. Все они находятся в схеме “cdc”.</li><li>Мы автоматически по таблице настроек CDC “MaintenanceSettingsCDC” будем создавать в схеме “yy” служебную таблицу с именем формата &quot;[ИмяТаблицыCDC]_[ДатаСозданияСоВременем]&quot;. При каждой реструктуризации будет создаваться такая таблица, что позволит сохранить работоспособность CDC при любых изменениях структуры таблицы. Фактически у нас будет история изменений таблицы DDL-командами. На скриншоте как-раз есть история из трех реструктуризаций.</li><li>Чтобы новая, переопределенная таблица CDC была задействована, нужно для штатной таблицы CDC создать триггер вида “INSTEAD OF INSERT”, чтобы все вставки перенаправлялись в нашу собственную таблицу.</li><li>В момент переключения также переместим все накопившиеся изменения из штатной таблицы CDC в нашу собственную таблицу. Так никакие изменения не потеряются.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Такой подход исключит потерю данных в таблицах CDC при изменении структуры основных таблиц, т.к. штатные таблицы CDC практически всегда будут пустыми. Переключение с таблицы CDC на нашу собственную таблицу будем выполнять следующей процедурой.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Перенаправление потока данных CDC в собственные таблицы</h2><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-NxrBK sc-cfxfQh fFQVyo lhxdmE prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Процедура переопределения потока данных в таблицу CDC на наши собственные</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- таблицы. Переопределение выполняется для конкретной настройки в таблице MaintenanceSettingsCDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">OverrideDataFlowForCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> NOCOUNT </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@originalTableName</span><span class="token plain"> sysname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationTableName</span><span class="token plain"> sysname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Читаем данные переданной настройки CDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationTableName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableNameCDCHistory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@originalTableName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MaintenanceSettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> ID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@originalSchemaName</span><span class="token plain"> sysname </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">GetCDCSchemeName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationSchemaName</span><span class="token plain"> sysname </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">GetMainSchemeName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationObjectFullName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationSchemaName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Формируем список таблиц для генерации скриптов создания копий таблиц и индексов,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- триггеров и их пересоздание</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"> sysname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> tables_cursor </span><span class="token keyword" style="color:rgb(86, 156, 214)">CURSOR</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> SYSOBJECTS s </span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">objects objs </span><span class="token keyword" style="color:rgb(86, 156, 214)">on</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> objs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">object_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">xtype </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;U&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token operator" style="color:rgb(212, 212, 212)">and</span><span class="token plain"> SCHEMA_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">objs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schema_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@originalSchemaName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@originalTableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">OPEN</span><span class="token plain"> tables_cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FETCH</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">NEXT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> tables_cursor </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHILE</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(156, 220, 254)">@FETCH_STATUS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameFull</span><span class="token plain"> SYSNAME</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameFull</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@originalSchemaName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			  </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_name</span><span class="token plain"> SYSNAME</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_id</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Подготовка к формированию скриптов по таблицам и индексам</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			  </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;[&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;].[&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;]&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_id</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">objects o </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schemas s </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">schema_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">schema_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameFull</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;U&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@SQL</span><span class="token plain"> NVARCHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAX</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">	</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@SQLTRANSFER</span><span class="token plain"> NVARCHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAX</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">	</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@SQLTRANSFERTRIGGER</span><span class="token plain"> NVARCHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAX</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@SQLTRANSFERTRIGGERDROP</span><span class="token plain"> NVARCHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAX</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> index_column </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				  ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_descending_key</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_included_column</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_columns ic </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">columns</span><span class="token plain"> c </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_id</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		fk_columns </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			 </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				  k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">constraint_object_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> cname </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> rcname </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> rc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">foreign_key_columns k </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">columns</span><span class="token plain"> rc </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> rc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">referenced_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> rc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">referenced_column_id </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">columns</span><span class="token plain"> c </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parent_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parent_column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parent_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_id</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Скрипт создания новой таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@SQL</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		IF EXISTS (SELECT * FROM SYSOBJECTS s LEFT JOIN sys.objects objs on s.id = objs.object_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">				   WHERE s.name=&#x27;&#x27;&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationTableName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;&#x27; </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">						AND xtype=&#x27;&#x27;U&#x27;&#x27; </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">						AND SCHEMA_NAME(objs.schema_id) = &#x27;&#x27;&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationSchemaName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;&#x27;)</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		BEGIN</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">			DROP TABLE &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationObjectFullName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		END</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">			CREATE TABLE &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationObjectFullName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> STUFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">9</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;, [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;] &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_computed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;AS &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> cc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">definition</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> UPPER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;varchar&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;char&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;varbinary&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;binary&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;text&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							   </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">max_length </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;MAX&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">max_length </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">VARCHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							 </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;nvarchar&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;nchar&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;ntext&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							   </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">max_length </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;MAX&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">max_length </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">VARCHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							 </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;datetime2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;time2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;datetimeoffset&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							   </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">scale </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">VARCHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							 </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;decimal&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							   </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">precision</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">VARCHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;,&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">scale </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">VARCHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							</span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">collation_name </span><span class="token operator" style="color:rgb(212, 212, 212)">IS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; COLLATE &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">collation_name </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_nullable </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; NULL&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; NOT NULL&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> dc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">definition</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">IS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; DEFAULT&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> dc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">definition</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_identity </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; IDENTITY(&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ISNULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">seed_value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;,&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ISNULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">increment_value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;1&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">columns</span><span class="token plain"> c </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">types</span><span class="token plain"> tp </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">user_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">user_type_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">computed_columns cc </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">default_constraints dc </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">default_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> dc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parent_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> dc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parent_column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">identity_columns ic </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_identity </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_id</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;NVARCHAR(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">9</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; &#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> ISNULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">9</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;, CONSTRAINT [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;] PRIMARY KEY (&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> STUFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">								 </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;, [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;] &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_descending_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;DESC&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;ASC&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">								 </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_columns ic </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">								 </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">columns</span><span class="token plain"> c </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">								 </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_included_column </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">									 </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parent_object_id </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">									 </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> ic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">unique_index_id     </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">								 </span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;NVARCHAR(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">key_constraints k </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parent_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_id</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;PK&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token plain">  </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> ISNULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					 </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;ALTER TABLE &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; WITH&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_not_trusted </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; NOCHECK&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; CHECK&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					  </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					  </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; ADD CONSTRAINT [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name  </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;] FOREIGN KEY(&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					  </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> STUFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;, [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cname </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;]&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> fk_columns k</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">constraint_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;NVARCHAR(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					   </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					  </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; REFERENCES [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> SCHEMA_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ro</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">schema_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;].[&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> ro</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;] (&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					  </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> STUFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;, [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">rcname </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;]&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> fk_columns k</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">constraint_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;NVARCHAR(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					   </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">delete_referential_action </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; ON DELETE CASCADE&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">delete_referential_action </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; ON DELETE SET NULL&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">delete_referential_action </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; ON DELETE SET DEFAULT&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					  </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">update_referential_action </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; ON UPDATE CASCADE&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">update_referential_action </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; ON UPDATE SET NULL&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">update_referential_action </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; ON UPDATE SET DEFAULT&#x27;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					  </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;ALTER TABLE &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; CHECK CONSTRAINT [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name  </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;]&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">foreign_keys fk </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">objects ro </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> ro</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">referenced_object_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> fk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parent_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_id</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;NVARCHAR(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> ISNULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				 </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;CREATE&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_unique </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; UNIQUE&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; NONCLUSTERED INDEX [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;] ON &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationObjectFullName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; (&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						STUFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;, [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;]&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_descending_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; DESC&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; ASC&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> index_column c</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_included_column </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;NVARCHAR(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">						</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> ISNULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;INCLUDE (&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							STUFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;, [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;]&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> index_column c</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_included_column </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">								</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">							</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;NVARCHAR(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CHAR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">13</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indexes i </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOWAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@object_id</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">--AND i.is_primary_key = 0</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">--AND i.[type] = 2</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;NVARCHAR(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Скрипт для переноса накопившихся данных в новую таблицу</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@SQLTRANSFER</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		INSERT INTO [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationSchemaName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;].[&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationTableName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;] </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		(&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		STUFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;,&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">columns</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> c</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">types</span><span class="token plain"> tp </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">system_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">system_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">user_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">user_type_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">OBJECT_ID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OBJECT_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameFull</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;timestamp&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;nvarchar(max)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;) </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		SELECT </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		STUFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;,&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">columns</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> c</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">types</span><span class="token plain"> tp </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">system_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">system_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">user_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">user_type_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">OBJECT_ID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OBJECT_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameFull</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;timestamp&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;nvarchar(max)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		FROM [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@originalSchemaName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;].[&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@tablename</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;];</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Скрипт создания триггера для перенаправления потока данных в новую таблицу</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@SQLTRANSFERTRIGGER</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	CREATE TRIGGER [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@originalSchemaName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;].[tr_AfterInsert_MoveToTable_&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationTableName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;]</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	   ON [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@originalSchemaName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;].[&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@tablename</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;]</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	   INSTEAD OF INSERT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	AS </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	BEGIN</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		SET NOCOUNT ON;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		INSERT INTO [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationSchemaName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;].[&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationTableName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;] </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		(&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		STUFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;,&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">columns</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> c</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">types</span><span class="token plain"> tp </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">system_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">system_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">user_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">user_type_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">OBJECT_ID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OBJECT_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameFull</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;timestamp&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;nvarchar(max)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;) </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		SELECT </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		STUFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;,&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">columns</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> c</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">types</span><span class="token plain"> tp </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">system_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">system_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">user_type_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">user_type_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">OBJECT_ID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OBJECT_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameFull</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> tp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;timestamp&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			column_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> XML PATH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;nvarchar(max)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		FROM INSERTED;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	END</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Скрипт удаления триггера, если он существует перед созданием</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@SQLTRANSFERTRIGGERDROP</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	IF EXISTS (SELECT * FROM sys.objects </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">				WHERE [name] = &#x27;&#x27;tr_AfterInsert_MoveToTable_&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationTableName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">				AND [type] = &#x27;&#x27;TR&#x27;&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">				AND SCHEMA_NAME(schema_id) = &#x27;&#x27;&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@originalSchemaName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;&#x27;)</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	BEGIN</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		  DROP TRIGGER [&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@originalSchemaName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;].[tr_AfterInsert_MoveToTable_&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationTableName</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;];</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	END;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Выполняем команды создания собственного объекта</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> sp_executesql </span><span class="token variable" style="color:rgb(156, 220, 254)">@SQL</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Создаем триггер для перенаправления изменений в собственную таблицу</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> sp_executesql </span><span class="token variable" style="color:rgb(156, 220, 254)">@SQLTRANSFERTRIGGERDROP</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> sp_executesql </span><span class="token variable" style="color:rgb(156, 220, 254)">@SQLTRANSFERTRIGGER</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Затем переносим данные из исходной таблицы в созданную</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> sp_executesql </span><span class="token variable" style="color:rgb(156, 220, 254)">@SQLTRANSFER</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FETCH</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">NEXT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> tables_cursor </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">CLOSE</span><span class="token plain"> tables_cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DEALLOCATE</span><span class="token plain"> tables_cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Процедура задокументирована в листинге. Основные шаги такие:</p><ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Создается собственная таблица для хранения изменений.</li><li>На штатную таблицу CDC создается триггер для перенаправления операций INSERT в нашу собственную, переопределенную таблицу.</li><li>Из штатной таблицы переносятся накопившиеся изменения в переопределенную таблицу.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">То есть на этом этапе у нас уже есть настройки и механизм переопределения потока данных об изменениях CDC. Осталось это как-то применить.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Применяем настройки</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Сначала нужно определиться в какие моменты настройки CDC мы можем применять, а в какие нет. Реализуем самое простое условие - если идет обновление конфигурации информационной базы, то обновлять настройки CDC мы не должны. Почему? Потому что не хотелось бы во время рестурктуризации и “перезаливке” данных из старой таблицы в новую все эти данные в CDC зарегистрировать. Зачем?</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для проверки доступности обновления настроек сделаем процедуру.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-gFAXEw sc-gmPhgS jguAgb dqbzmA prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Процедура позволяет определить доступность применения настроек CDC в данный момент</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ApplySettingsCDCAvailable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@availableResult</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> OUTPUT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> NOCOUNT </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Если в таблице сохраненной конфигуарции есть хоть одна запись,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- то считаем, что идет обновление и никаких настроек CDC применять не нужно</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@availableResult</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">COUNT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ConfigSave</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь при начале обновления информационной базы мы будем уверены, что CDC не будет включен для таблицы, пока реструктуризация перезаливает данные из старой версии таблицы.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Сама процедура применения настроек CDC будет выглядеть так.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Применение настроек CDC</h2><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-hRJeED sc-iHbTvc fSyujZ hbaISU prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Применение настроек CDC по настройкам из таблицы MaintenanceSettingsCDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ApplySettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> NOCOUNT </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@useCDC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">bit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaNameCDC</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDC</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDCHistory</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@captureInstanceCDC</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableObjectId</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableSchemaLastChangeDate</span><span class="token plain"> datetime2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@availableResult</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Проверяем, доступно ли применение настроек CDC в данный момент</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ApplySettingsCDCAvailable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@availableResult</span><span class="token plain"> OUTPUT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@availableResult</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Получаем все активные настройки</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> settingsCursor </span><span class="token keyword" style="color:rgb(86, 156, 214)">CURSOR</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		   </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SchemaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">UseCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SchemaNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableNameCDCHistory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">CaptureInstanceCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableObjectId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableSchemaLastChangeDate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MaintenanceSettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">UseCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">OPEN</span><span class="token plain"> settingsCursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FETCH</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">NEXT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> settingsCursor </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@useCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDCHistory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@captureInstanceCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableObjectId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableSchemaLastChangeDate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHILE</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(156, 220, 254)">@FETCH_STATUS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Проверяем, доступно ли применение настроек CDC в данный момент</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ApplySettingsCDCAvailable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@availableResult</span><span class="token plain"> OUTPUT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@availableResult</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Получаем текущие данные о таблице:</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">--	* Используется для нее CDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">--	* Идентификатор объекта</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">--	* Дата последнего изменения объекта</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@currentCDCEnabled</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">bit</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@currentTableObjectId</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@currentTableSchemaLastChangeDate</span><span class="token plain"> datetime2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@currentCDCEnabled</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tb</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_tracked_by_cdc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@currentTableObjectId</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tb</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@currentTableSchemaLastChangeDate</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> 			</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> create_date </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> modify_date </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> create_date</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> modify_date</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">tables</span><span class="token plain"> tb</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schemas s </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">on</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schema_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tb</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schema_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> tb</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Вариант действий если CDC для объекта уже включен</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@currentCDCEnabled</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">PRINT</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Для таблицы уже используется CDC: &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Есть изменения в структуре таблицы или объект был пересоздан,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token comment" style="color:rgb(106, 153, 85)">-- то нужно пересоздать объекты CDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Структура таблицы изменилась</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			   </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> ISNULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableSchemaLastChangeDate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;2000-01-01 00:00:00&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> datetime2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@currentTableSchemaLastChangeDate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			   </span><span class="token operator" style="color:rgb(212, 212, 212)">OR</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			   </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Идентификатор базы данных изменился</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			   </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> ISNULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableObjectId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@currentTableObjectId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">PRINT</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Зафиксировано изменение таблицы. Пересоздаем настройки CDC: &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Отключение CDC для таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXEC</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_cdc_disable_table</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@source_schema</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@source_name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@capture_instance</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@captureInstanceCDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Включаем CDC заново</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXEC</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sp_cdc_enable_table</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Схема исходной таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@source_schema</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя исходной таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@source_name</span><span class="token plain">   </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя роли для доступа к данным изменений оставляем по умолчанию</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@role_name</span><span class="token plain">     </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Поддержку запросов для суммарных изменений не используем,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">-- чтобы снизить размеры таблиц CDC и иметь возможность его использования,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">-- даже если у таблицы нет уникального ключа</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@supports_net_changes</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Остальные параметры не используются, т.к. не нужны явно</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя уникального индекса для идентификации строк (не обязателен)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">--@index_name    = N&#x27;&lt;index_name,sysname,index_name&gt;&#x27;,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Файловая группа для хранения таблиц изменений (не обязателен)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token comment" style="color:rgb(106, 153, 85)">--@filegroup_name = N&#x27;&lt;filegroup_name,sysname,filegroup_name&gt;&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Обновляем служебные поля настроек CDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">UpdateServiceMaintenanceSettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaNameCDC</span><span class="token plain"> OUTPUT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDC</span><span class="token plain"> OUTPUT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDCHistory</span><span class="token plain"> OUTPUT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@captureInstanceCDC</span><span class="token plain"> OUTPUT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Переопределяем поток изменений из стандартной таблицы CDC в собственную</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">OverrideDataFlowForCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">					</span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token keyword" style="color:rgb(86, 156, 214)">PRINT</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Для таблицы включен CDC: &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Вариант действий, если CDC для объекта еще не был включен</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Включаем CDC для таблицы, т.к. ранее он не был включен</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXEC</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sp_cdc_enable_table</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Схема исходной таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token variable" style="color:rgb(156, 220, 254)">@source_schema</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя исходной таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token variable" style="color:rgb(156, 220, 254)">@source_name</span><span class="token plain">   </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя роли для доступа к данным изменений оставляем по умолчанию</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token variable" style="color:rgb(156, 220, 254)">@role_name</span><span class="token plain">     </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Поддержку запросов для суммарных изменений не используем,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- чтобы снизить размеры таблиц CDC и иметь возможность его использования,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- даже если у таблицы нет уникального ключа</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token variable" style="color:rgb(156, 220, 254)">@supports_net_changes</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Остальные параметры не используются, т.к. не нужны явно</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя уникального индекса для идентификации строк (не обязателен)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">--@index_name    = N&#x27;&lt;index_name,sysname,index_name&gt;&#x27;,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Файловая группа для хранения таблиц изменений (не обязателен)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token comment" style="color:rgb(106, 153, 85)">--@filegroup_name = N&#x27;&lt;filegroup_name,sysname,filegroup_name&gt;&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Обновляем служебные поля настроек CDC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">UpdateServiceMaintenanceSettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaNameCDC</span><span class="token plain"> OUTPUT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDC</span><span class="token plain"> OUTPUT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDCHistory</span><span class="token plain"> OUTPUT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token variable" style="color:rgb(156, 220, 254)">@captureInstanceCDC</span><span class="token plain"> OUTPUT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Переопределяем поток изменений из стандартной таблицы CDC в собственную</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">OverrideDataFlowForCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">PRINT</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Для таблицы включен CDC: &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FETCH</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">NEXT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> settingsCursor </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@settingId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@useCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@schemaNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableNameCDCHistory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@captureInstanceCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableObjectId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@tableSchemaLastChangeDate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">CLOSE</span><span class="token plain"> settingsCursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DEALLOCATE</span><span class="token plain"> settingsCursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Обрабатываем настройки, для которых настройка CDC выключена или отсутствует (при этом CDC включен для объекта).</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- CDC для них должен быть выключен</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteSchamaName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteTableName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteCaptureInstance</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Список объектов, для которых CDC включен, но при этом</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- настройки в таблице MaintenanceSettingsCDC нет</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> disableCDCObjectsCursor </span><span class="token keyword" style="color:rgb(86, 156, 214)">CURSOR</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FOR</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  SCHEMA_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schema_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SchemaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">OBJECT_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ct</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">source_object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">capture_instance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">cdc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">change_tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> ct</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">objects o</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> ct</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">source_object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">object_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">MaintenanceSettingsCDC st</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SCHEMA_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schema_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> st</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SchemaName</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> OBJECT_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ct</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">source_object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> st</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">TableName</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">				</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> st</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">UseCDC </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> st</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ID </span><span class="token operator" style="color:rgb(212, 212, 212)">IS</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">OPEN</span><span class="token plain"> disableCDCObjectsCursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FETCH</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">NEXT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> disableCDCObjectsCursor </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteSchamaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteCaptureInstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHILE</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(156, 220, 254)">@FETCH_STATUS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Проверяем, доступно ли применение настроек CDC в данный момент</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Этот момент описан ниже</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ApplySettingsCDCAvailable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@availableResult</span><span class="token plain"> OUTPUT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@availableResult</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">PRINT</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Отключение CDC для таблицы, т.к. настройка уже не актуальна: &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteTableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Отключение CDC для таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">EXEC</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_cdc_disable_table</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token variable" style="color:rgb(156, 220, 254)">@source_schema</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteSchamaName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@source_name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteTableName</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@capture_instance</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteCaptureInstance</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">FETCH</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">NEXT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> disableCDCObjectsCursor </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteSchamaName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@deleteCaptureInstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">CLOSE</span><span class="token plain"> disableCDCObjectsCursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DEALLOCATE</span><span class="token plain"> disableCDCObjectsCursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Общий алгоритм такой:</p><ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Получаем настройки CDC из таблицы MaintenanceSettingsCDC и обходим каждую.</li><li>Проверяем включен ли CDC для объекта.</li><li>Если включен, то:<ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Проверяем изменилась ли схема объекта или объект был полностью пересоздан</li><li>Включаем CDC</li><li>Обновляем служебные настройки</li><li>Переопределяем поток данных</li></ul></li><li>Если выключен, то просто включаем:<ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Включаем CDC</li><li>Обновляем служебные настройки</li><li>Переопределяем поток данных</li></ul></li><li>Отключаем настройку CDC у объектов, для которых нет активной записи в таблице MaintenanceSettingsCDC.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для применения настроек достаточно вызвать:</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-klVQSN sc-bypIEy eQqNTA hRvUnE prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ApplySettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И дело сделано!</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Сопровождать и остаться в живых</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Инфраструктура готова, но не запускать же это каждый раз вручную? Правильно!</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Проще всего создать задание (Job) и запускать актуализацию настроек CDC раз в 15 секунд, например. Это решит большинство кейсов в части включения CDC во время изменения структуры базы данных после обновления.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Скрипт создания задания смысла приводить нет. Главное сделайте расписание раз в 15 секунд и вызывайте процедуру:</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-ddjGcj sc-dSCuSI bzSoxR hORTCN prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">yy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ApplySettingsCDC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Вот и все сопровождение. Или не все?</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для мониторинга работы CDC можно использовать стандартный журнал логов SQL Server и историю работы заданий в SQL Server Agent. В остальном ничего особого не нужно.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Используем в своих целях</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Мы все настроили, все работает. Но что это нам дает и как это использовать?</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Шаг за шагом</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Проведем небольшой тест. Например, у нас есть документ “Реализация товаров” из демобазы БСП. На стороне базы данных он представлен таблицами:</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/6. Объекты 1С.png" alt="Объекты 1С" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Включим для этих таблиц CDC через настройки.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/7. Настройки CDC.png" alt="Настройки CDC" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Как видно, заполнили только 3 поля. Как только задание применения настроек CDC отработает, то картина изменится на следующую.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/8. Настройки CDC.png" alt="Настройки CDC" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">При этом в схеме “yy” добавлены переопределенные таблицы.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_small__BEVeh display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/10. Переопределенные таблицы CDC.png" alt="Переопределенные таблицы CDC" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь зайдем на сторону клиента 1С и добавим новый документ через копирование, а после сразу же внесем в него небольшое изменение.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_small__BEVeh display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/12. Пример работы в 1С.gif" alt="Пример работы в 1С" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Как Вы думаете, сколько транзакций базы данных мы увидим? Ответ простой: 3:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Первая транзакция (идентификатор 0x000000AF0000AAA80008) - это добавление новых записей в таблицы. Документ в этот момент был записан без проведения. Данные в документе были только в шапке и в таб. части “Товары”, поэтому таблица для счетов на оплату пустая. Вот такие записи в таблице логов изменений.<div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/13. Изменения - 1.png" alt="Изменения" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Изменения в первой транзакции. Сверху таблица шапки, снизу таб. часть товаров.</p></li><li>Вторая транзакция (идентификатор 0x000000AF0000AB38000A) - это проведение документа. Фактически было изменено только поле “Проведен” (_Posted).<div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/14. Изменения - 2.png" alt="Изменения" width="100%" class="block"/></div></div></div></li><li>Третья транзакция (идентификатор 0x000000AF0000AD500074) - обновление поля “Комментарий”. В таблице изменений представлена также двумя записями UPDATE и с единственным измененным полем.<div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/15. Изменения - 3.png" alt="Изменения" width="100%" class="block"/></div></div></div><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C/16. Изменения - 4.png" alt="Изменения" width="100%" class="block"/></div></div></div></li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Таким образом, мы имеем детальную информацию об изменениях документа на каждом шаге, по каждому полю.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Кратко: где используется</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В самом начале статьи мы уже говорили, где это может пригодиться. После наглядного примера регистрации изменений должно было стать понятней:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Версионирование</b> - у нас хранятся версии всех изменений в базе и при этом в разрезе транзакций. Если одна транзакция изменяет множество документов или других объектов, то связь между этими изменениями не трудно найти.</li><li><b>Аудит</b> - информация об изменениях у нас есть, но кто их изменил. Т.к. история изменений сохраняется на уровне базы данных, то у нас нет контекста приложения. То есть нет пользователя приложения. Тут есть два варианта:<ul class="List_list__zLjGi list-disc pl-[30px]"><li>По времени изменения легко найти записи о действиях пользователя в журнале регистрации.</li><li>Или можно в объектах 1С сохранять поля “Создал”, “Дату создания”, “Изменил” и “Дату изменения”, где у нас будет дата события и ссылка на пользователя. Тогда контекст приложения будет доступен и на стороне базы данных.</li><li>Или другие подобные варианты.</li></ul></li><li>Отправка изменений при интеграции. Если в базе у нас есть таблицы с историей изменений, то можно эту информацию использовать для отправки измененных объектов в другие системы. Сценариев много, один из низ - это присоединить Kafka, которая будет забирать себе данные об изменениях и отправлять подписчикам. Надежный и понятный способ интеграции. Но это только один небольшой пример.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Статья - слишком маленький формат, чтобы сразу здесь описать как присоединять Kafka или как удобно из 1С читать таблицы изменений CDC. Но основной посыл должен быть ясен.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Зачем, если можно не использовать</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Незачем! Если Вы не видите плюсов в применении механизма регистрации данных, то скорее всего вам это и не нужно. Аналогичный подход можно использовать и для баз PostgreSQL, но со своими нюансами.<u><b><a href="https://datacater.io/blog/2021-09-02/postgresql-cdc-complete-guide.html" target="_blank" rel="noopener noreferrer">По этому поводу можно прочитать интересную статью.</a></b></u></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Если же штатные инструменты регистрации и обмена Вас не устраивают, а построить DWH в связке с 1С - для Вас большая боль, то CDC может стать отличным стартом. Далее можно развивать использование этого механизма, добавить новые инструменты очередей и аналитики и вот появится новый уровень развития информационных систем.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">P.S. Спасибо, что дочитали! Всем добра!</p></article><div class="Seperator_section_seperator_line__gdWIB dark:border-white border-black"></div><div class="PageLayout_author_and_more__wxN3W mx-auto"><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><div class="flex items-center"><div class="flex items-center justify-center shadow-xl rounded-full overflow-hidden bg-blue-500 shrink-0 w-[60px] h-[60px] mr-3 text-xl"><p class="text-center font-medium text-white">Y</p></div><div class="font-semibold"><p class="text-[20px]  mb-0 mt-0">YPermitin</p><p class="text-xs mt-0 mb-0">.NET, TSQL, DevOps, 1C:Enterprise</p></div></div><p class="text-[16px] mt-2">Developer, just developer.</p><div class="flex items-center flex-wrap mt-3"><a href="https://github.com/YPermitin" target="_blank" class="mr-[15px] text-[32px]" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></div><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><p class="border-b border-gray-300 pb-2 mb-3 font-medium w-full">Поделиться</p><div class="flex flex-wrap items-center"><a class="mr-3" aria-label="facebook-share" href="https://www.facebook.com/sharer/sharer.php?u=https://ypermitin.github.io" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-92.4 233.5h-63.9c-50.1 0-59.8 23.8-59.8 58.8v77.1h119.6l-15.6 120.7h-104V912H539.2V602.2H434.9V481.4h104.3v-89c0-103.3 63.1-159.6 155.3-159.6 44.2 0 82.1 3.3 93.2 4.8v107.9z"></path></svg></a><a class="mr-3" aria-label="twitter-share" href="http://twitter.com/share?text=Check out this article!! &amp;url=https://ypermitin.github.io&amp;hashtags=webdevelopment,javacript,javascriptdaily,webdevelopmenttutorial,tutorial" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm215.3 337.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg></a><a class="mr-3" aria-label="linkedin-share" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ypermitin.github.io&amp;title=Check out this article!!&amp;source=LinkedIn" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[23px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"></path></svg></a><button class="mr-3" name="copy-link" aria-label="copy-link"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"></path></svg></button></div><div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed flex transition-all right-[10px] -bottom-20 opacity-0" role="alert"><strong class="font-bold">Link Copied</strong><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"></path></svg></span></div></div><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><p class="border-b border-gray-300 pb-2 mb-3 font-medium w-full">Другие статьи</p><div class="flex flex-wrap"><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/DevOps/2024-08/ubuntu-vmware-kernel-modules-issue/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/DevOps/2024-08/ubuntu-vmware-kernel-modules-issue/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Решение проблем с модулями VMware в Ubuntu 22.04"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Решение проблем с модулями VMware в Ubuntu 22.04</div></div></div><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/.NET/2024-07/processes-under-control/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/.NET/2024-07/processes-under-control/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Берем процессы под контроль в .NET"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Берем процессы под контроль в .NET</div></div></div><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/.NET/2024-06/detect-devices-with-charp/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/.NET/2024-06/detect-devices-with-charp/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Поиск устройств в сети с .NET (C#)"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Поиск устройств в сети с .NET (C#)</div></div></div><a class="cursor-pointer hover:text-blue-500 block text-sm py-3 px-2 text-center dark:bg-slate-900 bg-blue-500 rounded text-white font-bold hover:!text-blue-900 dark:hover:!text-slate-400 transition-all" href="/blog/?author=YPermitin"><p>Все статьи от автора: <!-- -->YPermitin</p></a></div></div></div></div></section><div class="dark:bg-slate-900 dark:text-white bg-slate-100 text-black"><div class="md:container flex items-center md:justify-center justify-around flex-wrap md:text-[14px] text-[12px] py-5"><p class="my-0 mr-[10px] md:mr-3">Copyright © <!-- -->2024<!-- --> <!-- -->Убежище инженера</p></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/SQLServer/2022-06/change-data-capture-by-sqlserver-for-1C","query":{},"buildId":"3OSMF01S1TFJk6CkfZ1cn","nextExport":true,"autoExport":true,"isFallback":false,"dynamicIds":[8765,3220,935,7355,7651],"scriptLoader":[]}</script></body></html>