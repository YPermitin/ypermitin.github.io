<!DOCTYPE html><html lang="en" translate="no"><head><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1"/><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="google" content="notranslate"/><title>Мониторинг SQL Server с помощью Extended Events (и не только). Как держать руку на пульсе? | Убежище инженера | YPermitin</title><meta name="robots" content="index,follow"/><meta name="description" content="Что и как мониторить в работе SQL Server, чтобы держать Вашу систему в форме."/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://ypermitin.github.io/blog/SQLServer/2019-05/monitoring-with-extended-events-and-other"/><meta property="og:title" content="Мониторинг SQL Server с помощью Extended Events (и не только). Как держать руку на пульсе? | Убежище инженера | YPermitin"/><meta property="og:description" content="Что и как мониторить в работе SQL Server, чтобы держать Вашу систему в форме."/><meta property="og:url" content="https://ypermitin.github.io/blog/SQLServer/2019-05/monitoring-with-extended-events-and-other"/><meta property="og:type" content="website"/><meta property="og:image" content="https://ypermitin.github.io/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/logo.png"/><meta property="og:image:alt" content="Мониторинг SQL Server с помощью Extended Events (и не только). Как держать руку на пульсе? | Убежище инженера | YPermitin"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:locale" content="en_IN"/><meta property="og:site_name" content="Убежище инженера"/><link rel="canonical" href="https://webexpe.com/"/><meta property="keywords" content="SQL Server, мониторинг, Extended Events, логи, производительность, оптимизация"/><meta property="al:web:url" content="https://ypermitin.github.io/blog/SQLServer/2019-05/monitoring-with-extended-events-and-other"/><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/8b3cba25ed5aab85.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8b3cba25ed5aab85.css" data-n-g=""/><link rel="preload" href="/_next/static/css/0eb3a85c2cff7e2b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0eb3a85c2cff7e2b.css"/><link rel="preload" href="/_next/static/css/4a9df9e795bce52b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4a9df9e795bce52b.css"/><link rel="preload" href="/_next/static/css/ee5420a43edabb61.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ee5420a43edabb61.css"/><link rel="preload" href="/_next/static/css/88381d5dde4793c2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/88381d5dde4793c2.css"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script defer="" src="/_next/static/chunks/3a17f596-bbda16a68580be6f.js"></script><script defer="" src="/_next/static/chunks/fea29d9f.d7e20b827bc1967e.js"></script><script defer="" src="/_next/static/chunks/1664-c723d321aa16b9fd.js"></script><script defer="" src="/_next/static/chunks/8765.c3068153c4a9a4e3.js"></script><script defer="" src="/_next/static/chunks/3220.0b189779e06b0c1b.js"></script><script defer="" src="/_next/static/chunks/935.1ba77160b2eb4873.js"></script><script defer="" src="/_next/static/chunks/7355.d7ae2aaed607b6ac.js"></script><script defer="" src="/_next/static/chunks/7651.8de5823eb659d9d7.js"></script><script src="/_next/static/chunks/webpack-ae7b17597bc76f2c.js" defer=""></script><script src="/_next/static/chunks/framework-0e8d27528ba61906.js" defer=""></script><script src="/_next/static/chunks/main-9a17b44c0e255394.js" defer=""></script><script src="/_next/static/chunks/pages/_app-0e49c9c4f9ecc5f7.js" defer=""></script><script src="/_next/static/chunks/6443-faf415311aa71891.js" defer=""></script><script src="/_next/static/chunks/pages/blog/SQLServer/2019-05/monitoring-with-extended-events-and-other-9b8fd5c677d57e31.js" defer=""></script><script src="/_next/static/4yxYh-zP3XFB_CwVS3bjj/_buildManifest.js" defer=""></script><script src="/_next/static/4yxYh-zP3XFB_CwVS3bjj/_ssgManifest.js" defer=""></script></head><body class="bg-slate-100 dark:bg-slate-900 transition-all"><div id="__next"><div data-overlay-container="true"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><nav class="Navbar_navbar__W_ouQ bg-white  dark:bg-slate-900 dark:text-white text-black"><div class="container flex items-center justify-between px-2"><div class="flex items-center"><div class="Navbar_mobileBurgerToggle__Bj_52 mr-5  "><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="dark:text-white text-black text-2xl" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></div><a class="text-[22px] font-semibold" href="/">Убежище инженера</a></div><div class="flex items-center"><div class="text-[14px] font-normal items-center lg:flex hidden"><a class="cursor-pointer hover:text-blue-500 mx-2" href="/">Главная</a><div class="relative"><div class="flex items-center cursor-pointer mx-2"><p class="my-0">Блог</p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-[20px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path></svg></div><div class="overflow-auto absolute w-[180px] z-20 top-[30px] rounded-[4px] shadow-lg bg-white dark:bg-slate-800 border border-gray-300 dark:border-0 h-0 border-0"><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2" href="/blog/"><span>Все публикации</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=.NET"><span style="text-transform:capitalize">.NET</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=DevOps"><span style="text-transform:capitalize">DevOps</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=PostgreSQL"><span style="text-transform:capitalize">PostgreSQL</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=SQL%20Server"><span style="text-transform:capitalize">SQL Server</span></a></div></div><a class="cursor-pointer hover:text-blue-500 mx-2" href="/instruments/">Инструменты</a><a class="cursor-pointer hover:text-blue-500 mx-2" href="/about/">Обо мне</a><a class="cursor-pointer hover:text-blue-500 mx-2" href="/contact/">Контакты</a><div class="ml-5 pt-1"><a href="https://github.com/YPermitin/" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><a href="https://t.me/TinyDevVault" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"></path></svg></a><a href="mailto:i.need.ypermitin@yandex.ru" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0 0 68.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg></a><a href="https://boosty.to/ypermitin" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 21h9.62a3.995 3.995 0 0 0 3.037-1.397l5.102-5.952a1 1 0 0 0-.442-1.6l-1.968-.656a3.043 3.043 0 0 0-2.823.503l-3.185 2.547-.617-1.235A3.98 3.98 0 0 0 9.146 11H4c-1.103 0-2 .897-2 2v6c0 1.103.897 2 2 2zm0-8h5.146c.763 0 1.448.423 1.789 1.105l.447.895H7v2h6.014a.996.996 0 0 0 .442-.11l.003-.001.004-.002h.003l.002-.001h.004l.001-.001c.009.003.003-.001.003-.001.01 0 .002-.001.002-.001h.001l.002-.001.003-.001.002-.001.002-.001.003-.001.002-.001c.003 0 .001-.001.002-.001l.003-.002.002-.001.002-.001.003-.001.002-.001h.001l.002-.001h.001l.002-.001.002-.001c.009-.001.003-.001.003-.001l.002-.001a.915.915 0 0 0 .11-.078l4.146-3.317c.262-.208.623-.273.94-.167l.557.186-4.133 4.823a2.029 2.029 0 0 1-1.52.688H4v-6zM16 2h-.017c-.163.002-1.006.039-1.983.705-.951-.648-1.774-.7-1.968-.704L12.002 2h-.004c-.801 0-1.555.313-2.119.878C9.313 3.445 9 4.198 9 5s.313 1.555.861 2.104l3.414 3.586a1.006 1.006 0 0 0 1.45-.001l3.396-3.568C18.688 6.555 19 5.802 19 5s-.313-1.555-.878-2.121A2.978 2.978 0 0 0 16.002 2H16zm1 3c0 .267-.104.518-.311.725L14 8.55l-2.707-2.843C11.104 5.518 11 5.267 11 5s.104-.518.294-.708A.977.977 0 0 1 11.979 4c.025.001.502.032 1.067.485.081.065.163.139.247.222l.707.707.707-.707c.084-.083.166-.157.247-.222.529-.425.976-.478 1.052-.484a.987.987 0 0 1 .701.292c.189.189.293.44.293.707z"></path></svg></a></div></div><div class="Navbar_search_icon_wrapper__1a_rL ml-5 dark:text-white"><button name="search-button" aria-label="search button"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="dark:text-white text-black text-[22px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></button></div><div class=""><button name="share" aria-label="share page"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="dark:text-white text-black text-[16px] mt-[7px] ml-2 mr-1" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.5 2.5 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5"></path></svg></button></div><button name="theme-switch" aria-label="theme button" class="Navbar_theme_switch__q7F_Z pl-3 dark:text-white text-black"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-md " height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"></path></svg></button></div></div></nav><aside class="Navbar_nav_sidebar_wrapper__M0KaI dark:bg-slate-900 dark:text-white bg-white text-black"><div class="flex items-center justify-between pb-3"><p class="">МЕНЮ</p><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-slate-800 dark:text-white text-[25px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0V0z"></path><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg></div></div><hr/><div class="my-15"><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/">Главная</a><div class="relative"><div class="flex items-center cursor-pointer justify-between"><p class="my-0">Блог</p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-[20px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path></svg></div><div class="overflow-auto relative h-0 border-0"><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2" href="/blog/"><span>Все публикации</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=.NET"><span style="text-transform:capitalize">.NET</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=DevOps"><span style="text-transform:capitalize">DevOps</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=PostgreSQL"><span style="text-transform:capitalize">PostgreSQL</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=SQL%20Server"><span style="text-transform:capitalize">SQL Server</span></a></div></div><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/instruments/">Инструменты</a><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/about/">Обо мне</a><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/contact/">Контакты</a></div><hr/><div class="my-5"><p class="font-light">Подписаться : </p> <a href="https://github.com/YPermitin/" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><a href="https://t.me/TinyDevVault" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"></path></svg></a><a href="mailto:i.need.ypermitin@yandex.ru" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0 0 68.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg></a><a href="https://boosty.to/ypermitin" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 21h9.62a3.995 3.995 0 0 0 3.037-1.397l5.102-5.952a1 1 0 0 0-.442-1.6l-1.968-.656a3.043 3.043 0 0 0-2.823.503l-3.185 2.547-.617-1.235A3.98 3.98 0 0 0 9.146 11H4c-1.103 0-2 .897-2 2v6c0 1.103.897 2 2 2zm0-8h5.146c.763 0 1.448.423 1.789 1.105l.447.895H7v2h6.014a.996.996 0 0 0 .442-.11l.003-.001.004-.002h.003l.002-.001h.004l.001-.001c.009.003.003-.001.003-.001.01 0 .002-.001.002-.001h.001l.002-.001.003-.001.002-.001.002-.001.003-.001.002-.001c.003 0 .001-.001.002-.001l.003-.002.002-.001.002-.001.003-.001.002-.001h.001l.002-.001h.001l.002-.001.002-.001c.009-.001.003-.001.003-.001l.002-.001a.915.915 0 0 0 .11-.078l4.146-3.317c.262-.208.623-.273.94-.167l.557.186-4.133 4.823a2.029 2.029 0 0 1-1.52.688H4v-6zM16 2h-.017c-.163.002-1.006.039-1.983.705-.951-.648-1.774-.7-1.968-.704L12.002 2h-.004c-.801 0-1.555.313-2.119.878C9.313 3.445 9 4.198 9 5s.313 1.555.861 2.104l3.414 3.586a1.006 1.006 0 0 0 1.45-.001l3.396-3.568C18.688 6.555 19 5.802 19 5s-.313-1.555-.878-2.121A2.978 2.978 0 0 0 16.002 2H16zm1 3c0 .267-.104.518-.311.725L14 8.55l-2.707-2.843C11.104 5.518 11 5.267 11 5s.104-.518.294-.708A.977.977 0 0 1 11.979 4c.025.001.502.032 1.067.485.081.065.163.139.247.222l.707.707.707-.707c.084-.083.166-.157.247-.222.529-.425.976-.478 1.052-.484a.987.987 0 0 1 .701.292c.189.189.293.44.293.707z"></path></svg></a><hr class="mt-5"/></div><div class="mt-5 mb-4"><p class="mb-2 font-light">Переключиться на <!-- -->светлую<!-- --> тему :</p><button name="theme-switch" aria-label="theme-switch" class="Navbar_theme_switch__q7F_Z dark:text-white text-black"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-lg" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"></path></svg></button></div><hr/><div class="my-5"><p class="text-sm font-light dark:text-gray-400 text-gray-500 mb-1">Copyright © 2024</p></div></aside><div class="transition-all fixed h-screen w-screen flex items-center justify-center left-0 z-20 top-0 pointer-events-none opacity-0"><div class="absolute top-0 left-0 w-screen h-screen bg-black opacity-50"></div><div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded lg:w-1/6 mx-3 w-full relative z-10 transition-all top-10"><div class="flex border-gray-300 pb-2 mb-3 border-b"><p class="  font-medium w-full">Share:</p><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"></path></svg></span></div><div class="flex flex-wrap items-center"><a class="mr-3" aria-label="facebook-share" href="https://www.facebook.com/sharer/sharer.php?u=https://ypermitin.github.io" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-92.4 233.5h-63.9c-50.1 0-59.8 23.8-59.8 58.8v77.1h119.6l-15.6 120.7h-104V912H539.2V602.2H434.9V481.4h104.3v-89c0-103.3 63.1-159.6 155.3-159.6 44.2 0 82.1 3.3 93.2 4.8v107.9z"></path></svg></a><a class="mr-3" aria-label="twitter-share" href="http://twitter.com/share?text=Check out this article!! &amp;url=https://ypermitin.github.io&amp;hashtags=webdevelopment,javacript,javascriptdaily,webdevelopmenttutorial,tutorial" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm215.3 337.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg></a><a class="mr-3" aria-label="linkedin-share" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ypermitin.github.io&amp;title=Check out this article!!&amp;source=LinkedIn" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[23px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"></path></svg></a><button class="mr-3" name="copy-link" aria-label="copy-link"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"></path></svg></button></div><div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed flex transition-all right-[10px] -bottom-20 opacity-0" role="alert"><strong class="font-bold">Link Copied</strong><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"></path></svg></span></div></div></div><section class="PageLayout_centered_article_wrapper__gS3Af dark:bg-slate-900 dark:text-white"><div class="container px-0 md:px-[15px] pt-[50px] pb-[50px]"><article class="PageLayout_article_content__4dnq3 pb-[30px] px-3 bg-white dark:bg-slate-800 dark:border-none dark:drop-shadow-lg dark:text-white pt-10 md:pt-0 mx-auto font-regular text-lg leading-relaxed"><div class="mb-[30px]"><h1 class="ArticleHeader_articleTitle__3L1Bi text-center text-2xl md:text-4xl font-medium mt-[20px] mb-[5px]">Мониторинг SQL Server с помощью Extended Events (и не только). Как держать руку на пульсе?</h1><div class="mb-[10px] mt-[15px] text-[14px] font-medium ArticleHeader_centered_article_header_author___gRtE"><p class="my-0 mx-[30px] font-medium">YPermitin<span class="px-1 font-light">в</span><a href="/blog/?category=SQL%20Server">SQL Server</a></p><p class="my-0">2019-05-05</p></div><div class="md:mt-2 flex flex-wrap justify-center"><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->SQL Server</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->мониторинг</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->Extended Events</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->логи</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->производительность</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->оптимизация</p></div></div><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Немного истории</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Как показывает практика, во многих компаниях малого и среднего бизнеса (а иногда и крупного) можно столкнуться с отсутствием должного обслуживания серверов баз данных. В самом крайнем случае это выражается в наличии неэффективной стратегии бэкапирования или, о ужас, ее полном отсутствии! Представьте, что произойдет, если после аварии не удастся восстановить базу со всеми данными о деятельности компании?</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Приходилось ли Вам сталкиваться с системными администраторами, которые в случае проблем производительности и стабильности баз 1С отвечают:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Это не наша проблема! Обращайтесь к разработчикам 1С.</li><li>С нашей стороны все в порядке, это 1С так работает.</li><li>Какая еще 1С? Мне нужно настроить AD, а также провести миграцию некоторых серверов в облака.</li><li>(просто молча убегают в закат) и др. странные ситуации.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Знакомо? С одной стороны админов понять можно, ведь для исправления подобных проблем нужны время и знания (иногда специфические), за которые работодатель и платить то не всегда готов. С другой стороны, если не администратор должен за этим следить, то кто? Админа БД не везде можно найти и нанять.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Разработчики 1С также не всегда имеют необходимые компетенции и получается замкнутый круг. Разработчики показывают пальцем на админа, а админ на “этих” 1Сников. Причем у разработчиков даже прав доступа может не быть для решения проблем. В итоге бизнес заказывает внешний аудит производительности <!-- -->:)</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Как тут быть? Все просто (ну, почти) - нужно кооперироваться. Можно настроить мониторинг на SQL Server силами админа, а результаты показывать разработчикам 1С и обсуждать что нужно для решения проблем. Согласитесь, сесть раз в неделю или раз в месяц и разобрать проблемы - займет намного меньше сил и нервов, если продолжать спихивать друг на друга ответственность и конфликтовать. <b>* Конечно, это работает только при адекватности всех сторон.</b></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Сегодня в статье мы рассмотрим простые способы настройки мониторинга SQL Server с помощью Extended Events и с некоторыми другими способами, а также продемонстрируем как собранные данные интерпретировать и что показать 1Сникам.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-fhzEvr sc-jxOSYQ jiJdME ccRQnw prism-code language-text" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain">Внимание! Статья не является полным руководством. </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">Здесь Вы найдете общую информацию и примеры, </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">а также ссылки на полезные материалы по связанным темам.</span></div></pre></div></div><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Extended Events vs. SQL Profiler (SQL Trace)</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Прежде чем перейти непосредственно к примерам настроек сбора данных, нужно пояснить почему все же предлагается использовать Extended Events вместо <b><u><a href="https://learn.microsoft.com/ru-ru/sql/tools/sql-server-profiler/sql-server-profiler?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">SQL Profiler</a></u></b>. Несомненно, SQL Profiler остается одним из самых используемых инструментов для диагностики работы SQL Server, несмотря на то, что считается устаревшим. Не зря Microsoft предупреждает, что он может быть удален в будущих версиях СУБД, ведь ему на смену давно пришел более продвинутый инструмент - <b><u><a href="https://learn.microsoft.com/en-us/sql/relational-databases/extended-events/quick-start-extended-events-in-sql-server?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">Extended Events</a></u></b>.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">SQL Profiler является графической надстройкой для <b><u><a href="https://learn.microsoft.com/en-us/sql/relational-databases/sql-trace/sql-trace?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">SQL Trace</a></u></b>, с помощью которой он собирает данные, а после выводит их в графический интерфейс приложения. Как и SQL Profiler, SQL Trace считается устаревшим инструментом и может быть удален в будущем. Так почему же расширенные события лучше старых добрых трасс?</p><ul class="List_list__zLjGi list-decimal pl-[30px]"><li>SQL Trace находится в режиме поддержки и не дополняется новым функционалом. Также он изначально содержал меньше доступных событий для анализа. К тому же, Extended Events содержит больше информации о событиях. Сравните возможности SQL Trace и Extended Events для различных редакций SQL Server по количеству доступных событий.<div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/1. XEvets vs SQL Trace.png" alt="XEvets vs SQL Trace" width="100%" class="block"/></div></div></div></li><li>Значительно меньшее влияние на производительность при включенном сборе данных, причем имеются расширенные настройки, с помощью которых на это можно влиять.</li><li>Настройки сбора данных (события, фильтры и др.) можно менять на активных сессиях, прямо во время сбора данных.</li><li>Доступен хэш запросов, чтобы идентифицировать одинаковые тексты запросов.</li><li>Можно настроить различные способы хранения логов, причем одновременно в нескольких вариантах.</li><li>Встроенные инструменты в SQL Server Managment Studio и инструкции TSQL для работы с ними.</li><li>Поддержка PowerShell <!-- -->:)</li><li>И еще многое другое.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Все еще используйте SQL Profiler / SQL Trace? Я тоже! Но, SQL Profiler только для тестовых баз, где нужно быстро посмотреть, что там за запрос. Если же нужно выполнять работы на рабочем окружении или настраивать мониторинг, то только Extended Events!</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Собираем данные</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И так, Вы собираетесь использовать расширенные события, но куда смотреть? В SQL Server Managment Studio в разделе “Управление ➡️ Расширенные события ➡️ Сеансы” Вы можете найти список всех сеансов расширенных событий.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_small__BEVeh display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/2. Сессии сбора данных.png" alt="Сессии сбора данных" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Здесь же можно добавить новый сеанс расширенных событий с помощью мастера, так и с помощью полной настройки вручную с нуля. Также можно управлять состоянием каждого сеанса (остановить или запустить), удалить его или сформировать скрипт T-SQL на основе существующего объекта.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_xs__E5xhu display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/3. Создание новой сессии.png" alt="Создание новой сессии" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Рассматривать процесс создания сеанса с помощью графического интерфейса мы не будем. Вместо этого создадим основные сеансы расширенных событий с помощью T-SQL.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Помните! Все что описано ниже лишь примеры и их нужно адаптировать под конкретную ситуацию: устанавливать фильтры по базе, настраивать хранение сеансов, добавлять другие необходимые события или удалять лишние, изменять состав собираемых полей и так далее. Главное начать, а там уже все будет проще!</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Тяжелые запросы по CPU</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Обычно всех интересуют долгие по времени выполнения запросы, или запросы отбирающие больше всего ресурсов CPU. Это не одно и то же, ведь на сервере может быть включен параллелизм, тогда затраченное процессорное время не будет равно времени выполнения запроса даже приблизительно. Для отслеживания событий по CPU достаточно использовать два события: <b><u><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/event-classes/rpc-completed-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">RPC:Completed</a></u></b> и <b><u><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/event-classes/sql-batchcompleted-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">SQL:BatchCompleted</a></u></b>. Первое событие возникает при вызове процедур, которые обычно делает платформа 1С через обращение к <b><u><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/system-stored-procedures/sp-executesql-transact-sql?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">sp_executesql</a></u></b>. Практически во всех остальных случаях это второе событие выполнения пакета запросов.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также стоит учитывать, чтоб сбор абсолютно всех запросов особо смысла не имеет и их нужно отфильтровать от “шума”. Для этого можно установить фильтр по полю времени выполнения события (поле “duration”). Значения там хранятся в микросекундах. Обычно я собираю запросы, которые выполняются более 5 секунд (то есть более 5000000 микросекунд).</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Чтобы создать сеанс сбора таких запросов воспользуется следующим скриптом. <b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Diagnostics/Extended-Events/%D0%A2%D1%8F%D0%B6%D0%B5%D0%BB%D1%8B%D0%B5%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D1%8B%20%D0%BF%D0%BE%20CPU.sql" target="_blank" rel="noopener noreferrer">Оригинальный скрипт находится здесь.</a></u></b></p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-lcIQwB sc-kdBRUi czurxv bSvSwN prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Анализ тяжелых запросов по CPU</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">HeavyQueryByCPU</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Класс событий RPC:Completed указывает, что удаленный вызов процедуры завершен.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/rpc-completed-event-class?view=sql-server-2017</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">rpc_completed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_pid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nt_username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_principal_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">duration</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5000000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Класс событий SQL:BatchCompleted указывает на завершение выполнения пакета языка Transact-SQL.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/sql-batchcompleted-event-class?view=sql-server-2017</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_batch_completed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_pid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nt_username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_principal_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">duration</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5000000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> TARGET package0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">event_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Путь к файлу хранения логов. Если не указан, то используется путь к каталогу логов SQL Server</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    filename</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;HeavyQueryByCPU.xel&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Максимальный размер файла в мегабайтах</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    max_file_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Максимальное количество файлов, после чего начнется перезапись логов в более старых файлах.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    max_rollover_files</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_MEMORY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">4096</span><span class="token plain"> KB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    EVENT_RETENTION_MODE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">ALLOW_SINGLE_EVENT_LOSS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_DISPATCH_LATENCY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">15</span><span class="token plain"> SECONDS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_EVENT_SIZE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> KB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MEMORY_PARTITION_MODE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">NONE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    TRACK_CAUSALITY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">OFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    STARTUP_STATE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">OFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">При использовании не забудьте указать путь, где будут хранится файлы с результатами логирования.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Таким образом, мы соберем все запросы, которые выполняются более 5 секунд, а дальше уже сможем агрегировать их и получить свой TOP по нагрузке.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Тяжелые запросы по объему данных</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">На втором месте для поиска тяжелых запросов используется объем логических чтений. Именно логических. То есть тех, которые были выполнены из оперативной памяти. Это важно, т.к. SQL Server кэширует страницы, полученные с диска в буферный кэш, то есть в оперативную память. Именно поэтому SQL Server такой прожорливый в части использования RAM (особенно если его не ограничить в настройках инстанса), но зато позволяет значительно повысить производительность. Тут главное соблюдать баланс.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Сбор тяжелых запросов по логическим чтениям позволит определить те запросы, которые чаще всего используют буферный кэш, тем самым “вымывая” из него данные для других запросов. Что это значит? Допустим, на сервере 32 ГБ оперативной памяти. Бухгалтер запустил отчет, запрос которого благодаря усилиями разработчика, считал 25 ГБ данных. Тем самым весь буфферный кэш SQL Server теперь используется этим отчетом, а остальные запросы будут вынуждены обращаться к диску и заново получать страницы, помещать их в кэш. Фактически, пользователи столкнуться с замедлением работы информационной системы. Описание, конечно, общее, но смысл должен быть понятен.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Собирать будем те же события, что и для CPU: <b><u><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/event-classes/rpc-completed-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">RPC:Completed</a></u></b> и <b><u><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/event-classes/sql-batchcompleted-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">SQL:BatchCompleted</a></u></b>. Для избавления от избыточного логирования событий в этом случае необходимо поставить фильтр на поле с размером прочитанных данных (то есть “logical reads”). На практике все зависит от конкретной системы и размера базы. Обычно использую значение фильтра от 10000 до 50000 прочитанных страниц (то есть от ~80 МБ до ~400 МБ, т.к. 1 страница = 8 КБ).</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для создания сеанса сбора тяжелых запросов по считываемому объему данных из кэша используем скрипт.Оригинальный скрипт здесь.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-tafSX sc-esYjtY jPNsJp cvMkDq prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Анализ тяжелых запросов по чтению данных</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">HeavyQueryByReads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Класс событий RPC:Completed указывает, что удаленный вызов процедуры завершен.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/rpc-completed-event-class?view=sql-server-2017</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">rpc_completed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_pid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nt_username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">query_hash</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">query_plan_hash</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_principal_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">logical_reads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">50000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Класс событий SQL:BatchCompleted указывает на завершение выполнения пакета языка Transact-SQL .</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/sql-batchcompleted-event-class?view=sql-server-2017</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_batch_completed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_pid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nt_username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">query_hash</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">query_plan_hash</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_principal_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">logical_reads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">50000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> TARGET package0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">event_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Путь к файлу хранения логов. Если не указан, то используется путь к каталогу логов SQL Server</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    filename</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;HeavyQueryByReads.xel&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Максимальный размер файла в мегабайтах</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    max_file_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Максимальное количество файлов, после чего начнется перезапись логов в более старых файлах.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    max_rollover_files</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_MEMORY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">4096</span><span class="token plain"> KB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    EVENT_RETENTION_MODE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">ALLOW_SINGLE_EVENT_LOSS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_DISPATCH_LATENCY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">15</span><span class="token plain"> SECONDS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_EVENT_SIZE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> KB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MEMORY_PARTITION_MODE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">NONE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    TRACK_CAUSALITY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">OFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    STARTUP_STATE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">OFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">При необходимости измените настройки под себя.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В итоге будем иметь статистику какие запросы у нас “прожорливые” по чтению.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Анализ блокировок и взаимоблокировок</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В платформе 1С реализован собственный менеджер блокировок. Всем известные управляемые блокировки должны были повысить производительность, что в принципе и сделали. Но, конечно же, отказа от использования блокировок на уровне СУБД не произошло, т.к. поддержание целостности данных никто не отменял. Поэтому мониторинг блокировок и взаимоблокировок на уровне СУБД является также актуальным.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для получения информации о возникших таймаутах на блокировках, ожиданиях на блокировках и взаимоблокировках можно воспользоваться следующими способоми.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Регулярный сбор информации об ожиданиях, таймаутах и взаимоблокировках</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для минимального влияния на работу базы данных и сервера СУБД рекомендую собирать информацию об ожиданиях на блокировках с помощью механизма <b><u><a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/blocked-process-report-event-class?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">отчетов по заблокированным процессам</a></u></b>. Он включается в свойствах сервера и выполняет сбор статистики с заданной периодичностью (обычно 5 секунд достаточно). При этом сбора информации обо всех установленных блокировках не производится, что снижает нагрузку на сервер. Мы получим только необходимую информацию о том, какой процесс кого ждал, какие запросы выполнялись и так далее.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Дополняем сессию сбора событиями отчета по взаимоблокировкам, чтобы в этот же отчет получить информацию о взаимоблокировках, их XML-граф и связаную информацию.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Информацию о событиях читайте в официальной документации: <b><u><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/event-classes/blocked-process-report-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">Blocked Process Report</a></u></b> и <b><u><a href="https://learn.microsoft.com/en-us/dynamics365/business-central/dev-itpro/administration/monitor-database-deadlocks" target="_blank" rel="noopener noreferrer">Deadlock XML Report</a></u></b>.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset"><b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Diagnostics/Extended-Events/%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BE%D0%BA%20%D0%B8%20%D0%B2%D0%B7%D0%B0%D0%B8%D0%BC%D0%BE%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BE%D0%BA%20%D1%81%20%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E%20%D0%BE%D1%82%D1%87%D0%B5%D1%82%D0%BE%D0%B2.sql" target="_blank" rel="noopener noreferrer">Оригинал скрипта здесь.</a></u></b></p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-fXSgRJ sc-JrEyx faRnqX CtKKW prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Анализ блокировок и взаимоблокировок с помощью отчетов</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Предварительно нужно включить события отчетов заблокированных процессов</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/blocked-process-report-event-class?view=sql-server-ver15</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXEC</span><span class="token plain"> sp_configure </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;show advanced options&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">RECONFIGURE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXEC</span><span class="token plain"> sp_configure </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;blocked process threshold&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;5&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">RECONFIGURE</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Далее создаем сессию сбор данных событий заблокированных процессов и взаимоблокировок</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">BlocksAndDeadlocksAnalyse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">blocked_process_report</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">           sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">           sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">xml_deadlock_report </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">           sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">           sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> TARGET package0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">asynchronous_file_target</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> filename </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LockAndDeadlockAnalyzeReports.xel&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">     metadatafile </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LockAndDeadlockAnalyzeReports.xem&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">     max_file_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">     max_rollover_files</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAX_DISPATCH_LATENCY </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token plain">SECONDS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">Результат сессии содержит подробную информацию о событиях блокировок и взаимоблокировок:</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">- Какая сессия какие блокировала</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">- Сколько происходило ожидание на блокироваке</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">- Какие запросы участвовали с обоих сторон</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">- И другая информация</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">*/</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">BlocksAndDeadlocksAnalyse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">STARTUP_STATE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В целом, данных подход позволяет взять под контроль абсолютное большинство проблем с ожиданиями на блокировках, таймаутами или взаимоблокировками. При этом минимально влияя на работу сервера СУБД и базы данных в частности.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Детальный анализ работы блокировочного механизма</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Второй способ с более детальным анализом можно использовать следующий, но он может сильно повлиять на работу сервера баз данных. Используйте в тех случаях, когда ранее описанный метод не позволяет проанализировать причины происходящих проблем.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Создаем сессию сбора информации обо всех возникших блокировках в системе, их отмене и таймаутах. При этом информацию записываем в файл, но с ограничением максимального размера в 1 ГБ. Максимальное количество файлов установим в 3. Выбранные события для сессии это: <b><u><a href="lock:Acquired" target="_blank" rel="noopener noreferrer">Lock:Acquired</a></u></b> (возникновение блокировки), <b><u><a href="https://learn.microsoft.com/en-us/sql/relational-databases/event-classes/lock-cancel-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">Lock:Cancel</a></u></b> (отмена блокировки), <b><u><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/event-classes/lock-timeout-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">Lock:Timeout</a></u></b> (таймаут на блокировке). Еще дополнительно можно собирать данные по событию <b><u><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/event-classes/lock-escalation-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">Lock:Escalation</a></u></b> (эскалация блокировки), но это по необходимости.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Сеанс собирает данные обо всех возникающих блокировках, отмененных блокировках и таймаутах. На нагруженных системах он может очень быстро увеличиваться в размерах, что потребует дискового пространства. Обычно сбор этих сведений выполняется в период пиковых нагрузок или в моменты времени, когда проблема с блокировками проявляется.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset"><b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Diagnostics/Extended-Events/%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BE%D0%BA.sql" target="_blank" rel="noopener noreferrer">Оригинальный скрипт здесь.</a></u></b></p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-fjvwmM sc-bbSYpP iycoQw cLQVUo prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Анализ блокировок</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">LockAnalyze</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Класс событий Lock:Acquired указывает, что была получена блокировка для ресурса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/lock-acquired-event-class?view=sql-server-2017</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lock_acquired</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_pid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nt_username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_principal_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">username</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Класс событий Lock:Cancel сигнализирует, что получение блокировки на ресурс было отменено</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/lock-cancel-event-class?view=sql-server-2017</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lock_cancel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_pid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nt_username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_principal_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">username</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Класс событий Lock:Timeout указывает на то, что запрос на захват некоторого ресурса превысил время ожидания</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/lock-timeout-event-class?view=sql-server-2017</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lock_timeout</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">duration</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> TARGET package0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">event_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Путь к файлу хранения логов. Если не указан, то используется путь к каталогу логов SQL Server</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    filename</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LockAnalyze.xel&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Максимальный размер файла в мегабайтах</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    max_file_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Максимальное количество файлов, после чего начнется перезапись логов в более старых файлах.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    max_rollover_files</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_MEMORY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">4096</span><span class="token plain"> KB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    EVENT_RETENTION_MODE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">ALLOW_SINGLE_EVENT_LOSS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_DISPATCH_LATENCY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">15</span><span class="token plain"> SECONDS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_EVENT_SIZE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> KB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MEMORY_PARTITION_MODE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">NONE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    TRACK_CAUSALITY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">OFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    STARTUP_STATE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">OFF</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Может понадобиться изменить настройки куда будет сохраняться файл с логами, а также ограничения на макс. размер файла и их количество.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">После этого, для анализа данных собранных логов лучше перенести их в отдельную базу данных. Последующий анализ заключается в поиске запроса, который блокировал выполнение текущей инструкции и привел к таймауту.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также есть другой способ для оперативного анализа кто и что блокирует. Для этого создадим сессию с доп. событием <b><u><a href="https://learn.microsoft.com/en-us/sql/relational-databases/event-classes/lock-released-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">SQL:LockReleased</a></u></b>, которое показывает снятие блокировки с ресурса. Вот так будут выглядеть скрипты оперативного анализа блокировок.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-fBWQee sc-hknPuZ dDoTSr fYDKyo prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_event_sessions </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LockAnalyze_Operational&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> LockAnalyze_Operational </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@dbid</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Для фильтра по базе данных</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@dbid</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> db_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&lt;ИмяБазыДанных&gt;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@dbid</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">IS</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">BEGIN</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURN</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Создаем сессию для анализа блокировок</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DECLARE</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@sql</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">@sql</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">CREATE EVENT SESSION LockAnalyze_Operational ON SERVER  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">ADD EVENT sqlserver.lock_acquired   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">    (action   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">        ( sqlserver.sql_text, sqlserver.database_id, sqlserver.tsql_stack,  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">         sqlserver.plan_handle, sqlserver.session_id)  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">    WHERE ( database_id=&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> cast</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@dbid</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; AND resource_0!=0)   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">    ),  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">ADD EVENT sqlserver.lock_released   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">    (WHERE ( database_id=&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> cast</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@dbid</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27; AND resource_0!=0 ))  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">ADD TARGET package0.pair_matching   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">    ( SET begin_event=&#x27;&#x27;sqlserver.lock_acquired&#x27;&#x27;,   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">            begin_matching_columns=&#x27;&#x27;database_id, resource_0, resource_1, resource_2, transaction_id, mode&#x27;&#x27;,   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">            end_event=&#x27;&#x27;sqlserver.lock_released&#x27;&#x27;,   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">            end_matching_columns=&#x27;&#x27;database_id, resource_0, resource_1, resource_2, transaction_id, mode&#x27;&#x27;,  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">    respond_to_memory_pressure=1)  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">WITH (max_dispatch_latency = 1 seconds)&#x27;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXEC</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">@sql</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> LockAnalyze_Operational </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">STATE </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">START</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Ждем выполнения проблемной нагрузки.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-uVXKs sc-hCPjmr dwTABu gWZlxw prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Сохраняем данные сессии во временную таблицу для последующего анализа</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(action[@name=&quot;session_id&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;int&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;database_id&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;int&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;resource_type&quot;]/text)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;nvarchar(50)&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> resource_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;resource_0&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bigint&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> resource_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;resource_1&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bigint&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> resource_1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;resource_2&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bigint&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> resource_2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;mode&quot;]/text)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;nvarchar(50)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">mode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(action[@name=&quot;sql_text&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;varchar(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(action[@name=&quot;plan_handle&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;varchar(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> xml</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> plan_handle</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">      </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(action[@name=&quot;tsql_stack&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;varchar(MAX)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> xml</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> tsql_stack  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#unmatched_locks  </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">xest</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">target_data </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> xml</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        lockinfo  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">dm_xe_session_targets xest  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">dm_xe_sessions xes </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> xes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">address </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> xest</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">event_session_address  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> xest</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">target_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;pair_matching&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> xes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LockAnalyze_Operational&#x27;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> heldlocks  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CROSS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">APPLY</span><span class="token plain"> lockinfo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nodes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;//event[@name=&quot;lock_acquired&quot;]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">objlocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Получаем результаты анализа</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Сессия</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ID базы данных</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">resource_type </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Тип ресурса</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">resource_0 </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Ресурс</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">resource_1 </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Ресурс</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">resource_2 </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Ресурс</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">mode</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Режим блокировки</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Текст запроса</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">plan_handle </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Идентификатор плана запроса</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#unmatched_locks ul  </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">dm_tran_locks tl </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tl</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">resource_database_id </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">resource_type </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tl</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">resource_type  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> resource_0 </span><span class="token operator" style="color:rgb(212, 212, 212)">IS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> session_id </span><span class="token operator" style="color:rgb(212, 212, 212)">IN</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> blocking_session_id </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">dm_exec_requests </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> blocking_session_id </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> tl</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">request_status</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;wait&#x27;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">REPLACE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">mode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LCK_M_&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tl</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">request_mode  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Удаляем временную таблицу и сессию расширенных событий</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#unmatched_locks  </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> FindBlockers </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Так мы получим информацию о причинах таймаутов анализируя меньший объем логов, чем в первом примере.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для сбора и последующего анализа причин взаимоблокировок можно использовать сессию, в которой собираются данные событий <b><u><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/event-classes/lock-deadlock-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">Lock:Deadlock</a></u></b>, <b><u><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/event-classes/lock-deadlock-chain-event-class?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">Lock:Deadlock Chain</a></u></b> и <b><u><a href="https://learn.microsoft.com/en-us/dynamics365/business-central/dev-itpro/administration/monitor-database-deadlocks" target="_blank" rel="noopener noreferrer">Deadlock XML Report</a></u></b> для построения графического отчета.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset"><b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Diagnostics/Extended-Events/%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D0%B2%D0%B7%D0%B0%D0%B8%D0%BC%D0%BE%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BE%D0%BA.sql" target="_blank" rel="noopener noreferrer">Оригинал скрипта здесь.</a></u></b></p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-NxrBK sc-cfxfQh fFQVyo lhxdmE prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Анализ взаимоблокировок</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">DeadlockAnalyze</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Класс событий Lock:Deadlock предназначен для отслеживания возникновения взаимоблокировок и объектов, которые в них участвуют.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/lock-deadlock-event-class?view=sql-server-2017</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lock_deadlock</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_pid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nt_username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_principal_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">username</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Класс событий Lock:Deadlock Chain используется для регистрации условий возникновения взаимоблокировок.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- https://docs.microsoft.com/ru-ru/sql/relational-databases/event-classes/lock-deadlock-chain-event-class?view=sql-server-2017</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lock_deadlock_chain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_pid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nt_username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_principal_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">username</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Создает отчет о событии взаимоблокировки в формате XML</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">xml_deadlock_report</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_pid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nt_username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_principal_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">username</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> TARGET package0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">event_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Путь к файлу хранения логов. Если не указан, то используется путь к каталогу логов SQL Server</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        filename</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;DeadlockAnalyze.xel&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Максимальный размер файла в мегабайтах</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        max_file_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Максимальное количество файлов, после чего начнется перезапись логов в более старых файлах.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        max_rollover_files</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        MAX_MEMORY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">4096</span><span class="token plain"> KB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        EVENT_RETENTION_MODE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">ALLOW_SINGLE_EVENT_LOSS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        MAX_DISPATCH_LATENCY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">15</span><span class="token plain"> SECONDS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        MAX_EVENT_SIZE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> KB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        MEMORY_PARTITION_MODE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">NONE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        TRACK_CAUSALITY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">OFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        STARTUP_STATE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">OFF</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></div></pre></div></div><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Как обработать отчет по взаимоблокировкам</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В обоих вариантах сбора информации о блакировках используется сбор XML-отчета о взаимоблокировке. Обработать его можно одинаково в обоих случаях.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Обычно взаимоблокировки достаточно редкое явление, но мониторить их нужно в любом случае. Чтобы получить файл графа взаимоблокировки (*.xdl) из XML расширенного события необходимо скопировать вот этот значение в отдельный файл с расширением “xdl”.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/4. Граф взаимоблокировок.png" alt="Граф взаимоблокировок" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">После этого файл графа можно открывать в SQL Server Managment Studio.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/5. Удобное чтение графа взаимоблокировки.png" alt="Удобное чтение графа взаимоблокировки" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Остальные события помогут найти конкретные запросы и причины их появления.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Желаю Вам отсутствия взаимоблокировок!</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь Вы знаете как собрать информацию о запросах, приводящих к появлению таймаутов на блокировках и взаимоблокировкам.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Ошибки, ошибки, ошибки</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Было бы не плохо также отслеживать любые ошибки, происходящие на уровне СУБД. Для этого воспользуемся скриптом для сбора всех ошибок с помощью события <b><u><a href="https://learn.microsoft.com/en-us/sql/relational-databases/errors-events/database-engine-events-and-errors?view=sql-server-ver16" target="_blank" rel="noopener noreferrer">“SQL:ErrorReported”</a></u></b>.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset"><b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Diagnostics/Extended-Events/%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D0%BE%D1%88%D0%B8%D0%B1%D0%BE%D0%BA.sql" target="_blank" rel="noopener noreferrer">Оригинальный скрипт здесь.</a></u></b></p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-gFAXEw sc-gmPhgS jguAgb dqbzmA prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Анализ ошибок</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">Errors</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> EVENT sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">error_reported</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ACTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client_pid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_system</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nt_username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">server_principal_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transaction_sequence</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        sqlserver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">severity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> TARGET package0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">event_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Путь к файлу хранения логов. Если не указан, то используется путь к каталогу логов SQL Server</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    filename</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">N</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Errors.xel&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Максимальный размер файла в мегабайтах</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    max_file_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Максимальное количество файлов, после чего начнется перезапись логов в более старых файлах.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    max_rollover_files</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_MEMORY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">4096</span><span class="token plain"> KB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    EVENT_RETENTION_MODE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">ALLOW_SINGLE_EVENT_LOSS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_DISPATCH_LATENCY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">15</span><span class="token plain"> SECONDS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MAX_EVENT_SIZE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> KB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    MEMORY_PARTITION_MODE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">NONE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    TRACK_CAUSALITY</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">OFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    STARTUP_STATE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">OFF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Может пригодиться для диагностики не только проблем SQL Server, но и ошибок при выполнении запросов платформой 1С.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Какой у нас план?</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Иногда для диагностики проблем необходимо получить план запроса. Собирать планы всех запросов может быть не лучшим решением, т.к. значительно увеличит размер собираемых логов и в особых случаях может повлиять на производительность сервера.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Поэтому лучше использовать такие пути получения плана запроса:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Perfomance/%D0%90%D0%BA%D1%82%D0%B8%D0%B2%D0%BD%D1%8B%D0%B5%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D1%8B%20%D0%B8%20%D0%BF%D0%BB%D0%B0%D0%BD%D1%8B%20%D0%B2%D1%8B%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F.sql" target="_blank" rel="noopener noreferrer">этот скрипт</a></u></b>этот скрипт и посмотрите ее план.</li><li>Найти план выполнения по тексту запроса, если он еще содержится в кэше. <b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Perfomance/%D0%9F%D0%BE%D0%B8%D1%81%D0%BA%20%D0%BF%D0%BB%D0%B0%D0%BD%D0%B0%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0%20%D0%BF%D0%BE%20%D1%82%D0%B5%D0%BA%D1%81%D1%82%D1%83%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0.sql" target="_blank" rel="noopener noreferrer">Вот пример скрипта.</a></u></b></li><li><b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Diagnostics/Extended-Events/%D0%A1%D0%B1%D0%BE%D1%80%20%D0%BF%D0%BB%D0%B0%D0%BD%D0%BE%D0%B2%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%BE%D0%B2.sql" target="_blank" rel="noopener noreferrer">Собирать все планы выполнения</a></u></b> и повесить сервер с помощью Extended Events. Серьезно! Это только для ознакомления и применяется в редких случаях, особенно на продакшене.</li><li>Есть и другие способы получить план. <b><u><a href="https://www.sqlshack.com/how-to-obtain-sql-execution-plans-using-different-methods/" target="_blank" rel="noopener noreferrer">Вот дополнительная информация по этому поводу.</a></u></b></li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь, когда у Вас есть план запроса, Вы можете составить свой план работ! <!-- -->:)<!-- -->.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Анализируй это</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Собрать данные недостаточно, их еще нужно проанализировать! И тут платформа 1С приготовила нам некоторые сюрпризы. Разберем пример сбора и анализа данных собранных тяжелых запросов по CPU, а также анализ событий по таймаутам на блокировках. Все примеры будут очень похожи.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Перенос в отдельную базу данных</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И так, сессия Extended Events работает уже несколько рабочих дней и пора перейти к анализу собранных ей данных. Для начала остановим сессию.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Сделать это можно либо через интерфейс.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/6. Остановка сессии сбора.png" alt="Остановка сессии сбора" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Либо через TSQL.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-hRJeED sc-iHbTvc fSyujZ hbaISU prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> EVENT </span><span class="token keyword" style="color:rgb(86, 156, 214)">SESSION</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">ИмяСессии</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> SERVER  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">STATE </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> STOP</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- START для запуска</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Ничего сложного.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Далее копируем файлы XEL с собранными данными на сервер логов или локальный компьютер, т.к. выполнять анализ данных на рабочем сервере дело рисковое, ведь он может “съесть” значительную часть ресурсов.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/7. Файлы расширенных событий.png" alt="Файлы расширенных событий" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для удобной работы с логами лучше всего переносить их в базу данных. Конечно, есть возможность работы с ними без сохранения в базу, но это может значительно усложнить процесс обработки и анализа. Например, так мы не сможем повторно работать с данными эффективно, а для данных в базе мы могли бы создать индексы. Кроме того, для платформы 1С собранные данные нужно подвергать постобработке, к которой мы еще вернемся ниже. И так, как же перенести данные расширенных событий в базу.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Исходим из того, что база данных для обработки логов уже создана. Нам лишь нужно эти логи туда загрузить. Для этого запустим SQL Server Managment Studio и перейдем в “Файл ➡️ Открыть ➡️ Объединить файлы расширенных событий….”.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/8. Объединение файлов расширенных событий для чтения.png" alt="Объединение файлов расширенных событий для чтения" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">После добавляем в список все файлы, которые хотим обработать. Это намного удобнее, чем загружать каждый отдельный файл логов в базу. Ожидаем некоторое время, пока SSMS не обработает все события. После этого запускаем мастер выгрузки событий в таблицу базы данных.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/9. Экспорт расширенный событий в таблицу базы.png" alt="Экспорт расширенный событий в таблицу базы" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Вводим данные аутентификации, после чего необходимо выбрать базу данных, её схему (по умолчанию “dbo”) и имя таблицы для загрузки данных.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/10. Выбор целевой таблицы.png" alt="Выбор целевой таблицы" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Ожидаем завершение операции экспорта.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/11. Просмотр событий.png" alt="Просмотр событий" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">На этом все, SSMS создал таблицу и загрузил туда данные расширенных событий.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для ознакомительных целей упомянем и способ работы с собранными логами без сохранения в базу данных, но при работе с большим массивом логов он неэффективен.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Чтение файлов XEL через T-SQL выполняется с помощью sys.fn_xe_file_target_read_file. Каждое событие хранится в виде XML и вся задача сводится к разбору этих данных для представления в виде таблицы с отдельными колонками.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-klVQSN sc-bypIEy eQqNTA hRvUnE prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(action[@name=&quot;database_name&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;nvarchar(128)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> database_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(@name)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;varchar(50)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> event_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(@package)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;varchar(50)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> package_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(@timestamp)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;datetime2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">utc_timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;duration&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;int&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> duration</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;cpu_time&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;int&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> cpu</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;physical_reads&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;int&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> physical_reads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;logical_reads&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;int&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> logical_reads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;writes&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;int&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> writes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;row_count&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;int&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> row_count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;(data[@name=&quot;statement&quot;]/value)[1]&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;nvarchar(max)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> statement</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"> cast</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">event_data </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> XML</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> event_data</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fn_xe_file_target_read_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Q:\SQLTraces\254-sp-sql6\QueryStatistics\QueryAnalysis*.xel&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token boolean">null</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token boolean">null</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token boolean">null</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> ed</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">cross</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">apply</span><span class="token plain"> ed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">event_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nodes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;event&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Если файлов XEL несколько, то есть возможность указать шаблон имени файла через “*”, как это сделано в примере выше.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Этот способ не всегда удобен, т.к. не позволяет делать постобработку, группировку данных, использовать индексы для быстрого поиска и так далее.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И так, мы подготовили логи для дальнейшей обработки, но как оказалось это еще не все. Для быстрой и эффективной работы нам необходимо добавить ключевое поле в таблицу, изменить некоторые колонки и добавить кластерный индекс. Например, вот так:</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-ddjGcj sc-dSCuSI bzSoxR hORTCN prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Добавляем уникальное поле ID для каждой записи</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">QueryAnalysis</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> ID </span><span class="token keyword" style="color:rgb(86, 156, 214)">INT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IDENTITY</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Изменяем тип колонки &quot;database_name&quot; с &quot;nvarchar(max)&quot; на &quot;nvarchar(150)&quot;,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- чтобы его можно было использовать в индексах</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">QueryAnalysis</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">COLUMN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">150</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Добавляем кластерный индекс по периоду, имени базы и ключу записи</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">UNIQUE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CLUSTERED</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INDEX</span><span class="token plain"> CIX_Timestamp_DatabaseName_ID </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">QueryAnalysis</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">timestamp</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UTC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Добавляем индекс для быстрого поиска по &quot;ID&quot; + &quot;timestamp (UTC)&quot;.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Для оптимизации включены покрывающие поля, которые содержат тексты запросов, </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- но это приводит к увеличению размера базы с логами.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">UNIQUE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">NONCLUSTERED</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INDEX</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">UI_ID_Timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">QueryAnalysis</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ASC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">timestamp</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UTC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ASC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">INCLUDE </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"> 	</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">batch_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">statement</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Если есть возможность, то можно включить сжатие PAGE на уровне таблиц и индексов для базы с логами.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Так можно значительно сэкономить место.</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Эти шаги совсем не обязательные и могут изменяться в зависимости от состава собираемых полей в сессиях. Имеет смысл выполнять эти манипуляции только если данных для анализа много и планируется делать различные запросы для обработки этих записей. Нужен ли индекс, если в логах 10 записей? <!-- -->:)</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Отлично, теперь у нас есть таблица с загруженными логами и индекс для эффективной обработки данных.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Эти действия могут отличаться, если состав собираемых полей с помощью Extended Events другой, но общий принцип должен быть понятен. Финальный вариант таблицы с логами выглядит так.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2019-05/monitoring-with-extended-events-and-other/12. Результат выгрузки событий.png" alt="Результат выгрузки событий" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Осталось решить проблему постобработки данных.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Постобработка. Или грабли от 1С</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для SQL-запросов платформы есть одна большая особенность (другие мелкие нюансы можно не рассматривать): имена временных таблиц в запросах могут иметь случайные имена вида “<!-- -->#tt&lt;<!-- -->Тут случайны номер, который присвоит платформа 1С<!-- -->&gt;<!-- -->”. Аналогично обстоят дела и с именами параметров: @P1, @P2 … @PN.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Поэтому было бы не плохо привести их имена к общему виду. Например, к “#ttN” для временных таблиц и @PN для имен параметров.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Есть множество способов сделать постобработку данных. От написания различных программ на C#, Pyton и так далее, до использования самой 1С. Мы же сейчас пойдем другим путем и используем инструмент, который изначально есть на любом Win-сервере. Это PowerShell!</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-fxwsqt sc-hIUIyC iBQgcK eQWcYZ prism-code language-powershell" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Строка подключения к базе</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Примеры:</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#   - аутентификация средствами NTLM: &quot;Server=&lt;Имя сервера&gt;;Database=&lt;Имя базы&gt;;Integrated Security=TRUE;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#   - аутентификация средствами SQL Server: &quot;Data Source=&lt;Имя сервера&gt;;user=&lt;Имя пользователя&gt;;password=&lt;Пароль&gt;;Initial Catalog=&lt;Имя базы&gt;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token variable" style="color:rgb(156, 220, 254)">$connectionString</span><span class="token plain"> = </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&lt;Строка подключения&gt;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Таблица с логами Extended Events</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token variable" style="color:rgb(156, 220, 254)">$tableWithLogName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&lt;Имя таблицы с логами&gt;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Размер порции для обработки записей</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token variable" style="color:rgb(156, 220, 254)">$portion</span><span class="token plain"> = 100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Таймаут подключения для команд</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmdTimeoutSeconds</span><span class="token plain"> = 180</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">try</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnection</span><span class="token plain"> = </span><span class="token function" style="color:rgb(220, 220, 170)">new-object</span><span class="token plain"> system</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SqlClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SQLConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnectionForUpdate</span><span class="token plain"> = </span><span class="token function" style="color:rgb(220, 220, 170)">new-object</span><span class="token plain"> system</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SqlClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SQLConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnectionForUpdate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Проверяем наличие колонок в логах</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text_exist</span><span class="token plain"> = </span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text_exist</span><span class="token plain"> = </span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$statement_exist</span><span class="token plain"> = </span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$database_name_exist</span><span class="token plain"> = </span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token plain"> = </span><span class="token function" style="color:rgb(220, 220, 170)">New-Object</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">Data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SqlClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SqlCommand</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Connection = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnection</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CommandTimeout = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmdTimeoutSeconds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CommandText = </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">        SELECT </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	        cls.column_for_check AS [Name]</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	        ,CASE WHEN cl_info.column_id IS NOT NULL THEN 1 ELSE 0 END AS [exist]</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">        FROM (</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		        SELECT &#x27;batch_text&#x27; column_for_check</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		        UNION ALL</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		        SELECT &#x27;sql_text&#x27; column_for_check</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		        UNION ALL</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		        SELECT &#x27;statement&#x27; column_for_check</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		        UNION ALL</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		        SELECT &#x27;database_name&#x27; column_for_check</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	        ) cls </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	        LEFT JOIN sys.columns cl_info</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	        ON cls.column_for_check = cl_info.[name]</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">		        AND cl_info.[Object_ID] = Object_ID(N&#x27;dbo.&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$tableWithLogName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&#x27;)&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ExecuteReader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">HasRows </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;batch_text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;exist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> 1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text_exist</span><span class="token plain"> = </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">elseif</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;sql_text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;exist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> 1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text_exist</span><span class="token plain"> = </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">elseif</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;statement&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;exist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> 1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$statement_exist</span><span class="token plain"> = </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">elseif</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;database_name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;exist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> 1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$database_name_exist</span><span class="token plain"> = </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text_exist</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token boolean">$false</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-and</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text_exist</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token boolean">$false</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-and</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$statement_exist</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnectionForUpdate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token function" style="color:rgb(220, 220, 170)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Таблица &quot;</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token string variable" style="color:rgb(156, 220, 254)">$tableWithLogName</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token string" style="color:rgb(206, 145, 120)">&quot; не содержит данных для обработки!&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$lastRowID</span><span class="token plain"> = 0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$finish</span><span class="token plain"> = </span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$fieldForJob</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;[batch_text],&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	              &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;[sql_text],&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;    </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	              &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$statement_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;[statement],&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Trim</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$fieldForJob</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$fieldForJob</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Substring</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$fieldForJob</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Length </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> 1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$fieldsForUpdateLogRecord</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;     [batch_text] = @new_batch_text,&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	                &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$statement_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;     [statement] = @new_statement,&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;    </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	                &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;     [sql_text] = @new_sql_text,&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Trim</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$fieldsForUpdateLogRecord</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$fieldsForUpdateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Substring</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$fieldsForUpdateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Length </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> 1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">Do</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">    </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token plain"> = </span><span class="token function" style="color:rgb(220, 220, 170)">New-Object</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">Data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SqlClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SqlCommand</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Connection = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnection</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CommandTimeout = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmdTimeoutSeconds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CommandText = </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">            SELECT TOP (&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$portion</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;)</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	              -- Ключевые поля</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	              [ID]</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">                  &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$database_name_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;,[database_name]&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;	          </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">                  ,[timestamp (UTC)] AS [timestamp]</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">                  -- Поля для обработки</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">                  ,&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$fieldForJob</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;       </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">              FROM [dbo].[&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$tableWithLogName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;]</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">              WHERE [ID] &gt; @lastRowID</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">              ORDER BY</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	              -- Сортировка по ключевым полям</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	              [ID]</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	              ,[timestamp (UTC)]&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$paramLastRowId</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Parameters</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@lastRowID&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$lastRowID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ExecuteReader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">HasRows </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">           </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$rowID</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ID&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$DatabaseName</span><span class="token plain"> =  $</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$database_name_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;database_name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$timestamp</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;timestamp&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">                       </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text_exist</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;batch_text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-replace</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;#tt[\d]+&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ttN&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-replace</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@P[\d]+&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@PN&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text_exist</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;sql_text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-replace</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;#tt[\d]+&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ttN&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-replace</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@P[\d]+&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@PN&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$statement_exist</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-eq</span><span class="token plain"> </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$statement</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;statement&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$statement</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$statement</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-replace</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;#tt[\d]+&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ttN&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$statement</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$statement</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-replace</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@P[\d]+&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@PN&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token comment" style="color:rgb(106, 153, 85)"># Обновляем данные в записи</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token plain"> = </span><span class="token function" style="color:rgb(220, 220, 170)">New-Object</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">Data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SqlClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SqlCommand</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Connection = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnectionForUpdate</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CommandTimeout = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmdTimeoutSeconds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CommandText = </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">                    UPDATE [dbo].[&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$tableWithLogName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;] SET</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">                    &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$fieldsForUpdateLogRecord</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;       </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">                    WHERE [timestamp (UTC)] = @timestamp</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">                    &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$database_name_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;AND [database_name] = @databaseName&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;	                </span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	                    AND [ID] = @RowID&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$newParam</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Parameters</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;RowID&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$rowID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$database_name_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$newParam</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Parameters</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;databaseName&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$DatabaseName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$newParam</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Parameters</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;timestamp&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$newParam</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Parameters</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;new_batch_text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$batch_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$statement_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$newParam</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Parameters</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;new_statement&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$statement</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text_exist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token variable" style="color:rgb(156, 220, 254)">$newParam</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Parameters</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;new_sql_text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$resultExec</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlCmd_updateLogRecord</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ExecuteNonQuery</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token variable" style="color:rgb(156, 220, 254)">$lastRowID</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(156, 220, 254)">$rowID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">          </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Else</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token variable" style="color:rgb(156, 220, 254)">$finish</span><span class="token plain"> = </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token function" style="color:rgb(220, 220, 170)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Последний обработанный идентификатор строки: &quot;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$rowID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$finish</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-ne</span><span class="token plain"> </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">catch</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">Write-Error</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$_</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Exception</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">finally</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$sqlConnectionForUpdate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Можно этот скрипт значительно ускорить за счет операций BulkInsert, кэширования в памяти и других способов, но есть ли смысл?</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Используете другой подход? Было бы интересно узнать, пишите в комментариях.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь мы готовы агрегировать данные для поиска проблемных запросов.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Смотрим результаты</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Ничего сверхъестественного здесь нет. Просто группируем данные по тексту запроса и сортируем либо по CPU, либо по логическим чтениям.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Анализ запросов по CPU и чтениям</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Предположим, что мы загрузили данные сессии “” в одноименную таблицу. Теперь нам лишь нужно получить самые тяжелые запросы по CPU. Выполним такой запрос.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jnOFWn sc-dZodDb kouCPZ beItvB prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TOP</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	  DB_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token function" style="color:rgb(220, 220, 170)">SUM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">cpu_time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">cpu_time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token function" style="color:rgb(220, 220, 170)">SUM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">duration</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">duration</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token function" style="color:rgb(220, 220, 170)">SUM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">physical_reads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">physical_reads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token function" style="color:rgb(220, 220, 170)">SUM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">logical_reads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">logical_reads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token function" style="color:rgb(220, 220, 170)">SUM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">writes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">writes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token function" style="color:rgb(220, 220, 170)">SUM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">row_count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">row_count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">HeavyQueryByCPU</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> DB_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">cpu_time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В итоге, имеем 10 самых тяжелых запросов по использованию ресурсов CPU.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Примерно такой же запрос был бы, если бы мы обрабатывали результаты сбора тяжелых запросов по чтениям.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Собранные логи по блокировкам также можно изучить запросом</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Анализ блокировок</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Собранную информацию о таймаутах и установленных блокировках можно анализировать по разному. Можно найти для каждого таймаута блокирующую для него транзакцию и конкретный запрос. Чтобы не усложнять пример, рассмотрим простейший случай.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Допустим, мы загрузили результаты сбора данных о таймаутах на блокировках в таблицу “LockAnalyze”, выполнили постобработку запросов. Далее вот таким простым запросом получаем список таймаутов и блокирующих сессий для него.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-eZjPq sc-ggpkNl exvVPd iSVnmL prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">mode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Информация что было заблокировано</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">locks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_text</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">locks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">lock_timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">locks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">lock_transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">mode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">      </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">transaction_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Заблокированные ресурсы    </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">	  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	  </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">LockAnalyze</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	  </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lock_timeout&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> timeouts</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">LockAnalyze</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">locks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> locks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> locks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> locks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> locks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">resource_2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> timeouts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> locks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			</span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> locks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lock_acquired&#x27;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">То есть мы попытались найти для каждого таймаута соответствующую установленную блокировку, которая стала причиной проблемы. Сопоставление сделали по ресурсам (поля resource_0, resource_1, resource_2), базе данных и учитывая время таймаута.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Конечно, такой анализ не даст точных результатов, а при большом объеме логов может показать множества лишней информации. В этом случае нужно будет усложнять запрос. Также может понадобиться добавить в сессию сбор событий Lock:Released.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Основное, что требуется здесь понять, так это общий подход к поиску причин таймаутов на блокировках. Наиболее эффективным способом определения причин появления проблем с блокировками является расследование “на горячую”, которое было описано в примерах выше.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И напоследок посмотрим ошибки SQL Server.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Анализ ошибок</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Проанализируем самые частые ошибки на сервере СУБД и источники их возникновения.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-cmaqZA sc-kAkozD kvQiYo kciXiC prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TOP</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	  DB_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">      </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token function" style="color:rgb(220, 220, 170)">COUNT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">error_count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">Errors</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	  DB_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">database_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">    </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">client_hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">client_app_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">      </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sql_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">error_count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Конечно, как устранить ошибки мы сразу не узнаем, но повод для расследования ситуации появится.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Запросы можно адаптировать под свои настройки расширенных событий.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">А как же технологический журнал?</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Конечно, использовать технологический журнал можно для анализа тяжелых запросов и блокировок, даже планы запроса можно собрать. Но вот незадача! Влияние ТЖ на производительность системы может быть на столько высоко, что фактически остановит основную работу. Именно поэтому встроенные средства SQL Server намного лучше для диагностики проблем на уровне СУБД.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Но, к сожалению, без технологического журнала все равно не обойтись. Вместе с простым мониторингом SQL Server он поможет решать такие задачи.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Поиск мест в модулях конфигурации</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Допустим, мониторинг нашел, что подобный запрос находится в TOP 10 по нагрузке на CPU.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-gFVuLS sc-brPMkR dUxOCE cVxhxS prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#tt1 WITH(TABLOCK)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_Q_000_F_000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _Q_000_F_001</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _Q_000_F_002</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _Q_000_F_003</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    T1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Q_001_F_000_</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    T1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Q_001_F_001_</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token number" style="color:rgb(181, 206, 168)">0x01</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">@P1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token number" style="color:rgb(181, 206, 168)">1.0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Q_001_F_000_</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token variable" style="color:rgb(156, 220, 254)">@P2</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Q_001_F_001_</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ALL</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token number" style="color:rgb(181, 206, 168)">2.0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token variable" style="color:rgb(156, 220, 254)">@P3</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ALL</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token number" style="color:rgb(181, 206, 168)">3.0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token variable" style="color:rgb(156, 220, 254)">@P4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> T1</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Как найти где именно он выполняется в конфигурации 1С? С помощью настройки ТЖ.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-iMWBWc sc-fvtEUL gZBeko abriu prism-code language-xml" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token prolog" style="color:rgb(0, 0, 128)">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">config</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">http://v8.1c.ru/v8/tech-log</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">dump</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">create</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">false</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">log</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">location</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">&lt;Путь к каталогу для сохранения логов&gt;</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">history</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">48</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">eq</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">name</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">dbmssql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%INSERT INTO%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%SELECT%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%0x01%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%FROM (%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%SELECT%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%1.0%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%UNION ALL%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%SELECT%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%2.0%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%UNION ALL%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%SELECT%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">like</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Sql</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">%3.0%</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">property</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">all</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">log</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">config</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В итоге, в одном из файлов логов мы получим модуль и строчку кода, откуда платформа генерирует этот запрос.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-bBeLha sc-ihgokY fWBPGd gyhBuN prism-code language-text" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain">22:24.869011-1,DBMSSQL,6,process=rphost,p:processName=1C-Plus-MSOffice,OSThread=4760,t:clientID=12,t:applicationName=1CV8C,t:computerName=SRV-1C-MAIN,t:connectID=5,SessionID=2,Usr=DefUser,AppID=1CV8C,Trans=0,dbpid=59,Sql=&quot;INSERT INTO #tt1 WITH(TABLOCK) (_Q_000_F_000, _Q_000_F_001, _Q_000_F_002, _Q_000_F_003) SELECT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">T1.Q_001_F_000_,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">T1.Q_001_F_001_,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">0x01,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">?</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">FROM (SELECT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">1.0 AS Q_001_F_000_,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">? AS Q_001_F_001_</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">UNION ALL SELECT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">2.0,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">?</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">UNION ALL SELECT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">3.0,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">?) T1</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">p_0: 40181231000000</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">p_1: &#x27;Тест 1&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">p_2: &#x27;Тест 2&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">p_3: &#x27;Тест 3&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">&quot;,Rows=0,RowsAffected=3,Context=&#x27;Форма.Вызов : Отчет.ВыгрузкаРезультатаКомпоновки.Форма.ФормаОтчета.Модуль.ВыгрузитьВAccessНаСервере</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">Отчет.ВыгрузкаРезультатаКомпоновки.Форма.ФормаОтчета.Форма : 43 : РаботаСAccessКлиентСервер.ПолучитьОграниченияВыгрузкиБазы(,2,)</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	ОбщийМодуль.РаботаСAccessСервер.Модуль : 55 : Возврат ВыгрузитьИсточникВБазуДанных(</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		ОбщийМодуль.РаботаСAccessСервер.Модуль : 123 : Стр = ПолучитьСледующуюЗапись(ИсточникДанных, НомерЗаписи);</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">			ОбщийМодуль.РаботаСAccessСервер.Модуль : 302 : СледующаяЗапись = ИсточникДанных.Следующий();&#x27;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для настройки ТЖ в этом случае нужно учитывать, что некоторые части SQL-запросов платформы могут изменяться (имена временных таблиц, имена полей вложенного запроса и др.). Поэтому лучше всего стараться использовать те части, которые точно не изменятся (имя таблиц или имена полей в базе, конструкции языка запросов и др).</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Поиск ошибок, связанных с работой СУБД</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Вообще, рекомендуется собирать информацию об исключительных ситуация на сервере 1С в постоянном режиме. Для этого настраивается технологический журнал с таким содержимым файла настроек.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jMalIJ sc-iMTngq gUpsZE bJNMjG prism-code language-xml" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">config</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">http://v8.1c.ru/v8/tech-log</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">log</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">location</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">&lt;Путь к каталогу для сохранения логов&gt;</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">history</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">168</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">eq</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">EXCP</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">eq</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">EXCPCNTX</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">eq</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">ADMIN</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">eq</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">PROC</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">eq</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">ATTN</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">eq</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">QERR</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">eq</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">SCOM</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">eq</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">property</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">CONN</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">event</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">property</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">all</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">property</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">log</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">config</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Подобная настройка технологического журнала не создает заметной нагрузки на сервере и позволяет фиксировать события сбоев в работе его компонентов. При этом фиксируются и те ошибки, которые возникают при обращении к СУБД (таймауты на блокировках и др.).</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Послесловие по ТЖ</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Это только те задачи, которые можно решить с минимальной затратой ресурсов. В статье мы не будем подробно останавливаться на работе ТЖ, но с его помощью можно решить множество других вопросов, с которыми Extended Events не в силах помочь:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Анализ и поиск проблем с управляемыми блокировками.</li><li>Поиск узких мест производительности в коде конфигураций.</li><li>Проверка работы сервера, кластера.</li><li>И многое другое.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">То есть без технологического журнала все равно никуда, но для диагностики проблем СУБД лучше использовать нативные инструменты.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Что еще можно / нужно собирать</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Выше уже было сказано, что статья не является полным руководством, поэтому кратко рассмотрим что еще можно собирать для мониторинга. Кроме тех данных, что мы собирали с помощью расширенных событий, обязательно нужно мониторить:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b><u><a href="/blog/DevOps/2022-06/windows-perfomance-counter-and-powershell" target="_blank" rel="noopener noreferrer">С помощью счетчиков производительности ОС Windows: </a></u></b><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Загрузку оборудования</li><li>Внутренние показатели SQL Server.</li></ul></li><li><b><u><a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-Maintenance/Service-Database" target="_blank" rel="noopener noreferrer">Статистику обслуживания базы данных:</a></u></b><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Один и более раз в день сохранять информацию о состоянии индексов в базу данных с логами с помощью Job\’а или другим способом. Можно использовать этот скрипт.</li><li>Сохранять информацию о состоянии статистик в базу с логами также один или несколько раз в сутки. Например, этим скриптом.</li><li>Фиксировать операции обслуживания индексов и статистик. Например, в этом скрипте обслуживания выделено место, где эту информацию можно записывать в базу (имя таблицы, имя обслуживаемого объекта, тип операции, дата запуска и дата завершения).</li></ul></li><li>Другую необходимую информацию:<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Perfomance/%D0%A0%D0%B0%D0%B7%D0%B2%D0%B5%D1%80%D0%BD%D1%83%D1%82%D0%B0%D1%8F%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B0%20%D0%BF%D0%BE%20%D0%BE%D0%B6%D0%B8%D0%B4%D0%B0%D0%BD%D0%B8%D1%8F%D0%BC.sql" target="_blank" rel="noopener noreferrer">Статистику по ожиданиям.</a></u></b></li><li><b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Databases-Info/%D0%A0%D0%B0%D0%B7%D0%BC%D0%B5%D1%80%20%D0%B2%D1%81%D0%B5%D1%85%20%D0%B1%D0%B0%D0%B7.sql" target="_blank" rel="noopener noreferrer">Размер баз.</a></u></b></li><li><b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Databases-Info/%D0%A0%D0%B0%D0%B7%D0%BC%D0%B5%D1%80%D1%8B%20%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86.sql" target="_blank" rel="noopener noreferrer">Размер таблиц.</a></u></b></li><li>И многое другое.</li></ul></li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Конечный вариант собираемых данных полностью зависит от целей мониторинга и должен быть адаптирован под Вашу ситуацию.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Конечно, можно использовать стандартные средства Windows и SQL Server, но можно взять в помощь какую-либо систему мониторинга. Например, Zabbix, или вообще все логи выгружать в ElasticSearch. Тут все зависит от потребностей.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Уровень Enterprise!</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Вы дочитали до сюда с вопросом “А проще нельзя сделать”? Конечно, можно! Если бы выполнять мониторинг приходилось всегда через подобную ручную работу, то реагировать на проблемы производительности не всегда бы удавалось. Тем более на больших, высоконагруженных системах. Тут на помощь приходят инструменты мониторинга:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b><u><a href="https://v8.1c.ru/tekhnologii/tekhnologii-krupnykh-vnedreniy/korporativnyy-instrumentalnyy-paket/" target="_blank" rel="noopener noreferrer">Корпоративный инструментальный пакет (в его составе ЦУП)</a></u></b></li><li><b><u><a href="https://softpoint.ru/solutions/perfexpert/" target="_blank" rel="noopener noreferrer">Softpoint PerfExpert</a></u></b></li><li><b><u><a href="http://www.gilev.ru/" target="_blank" rel="noopener noreferrer">Сервисы Gilev.ru</a></u></b></li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">По крайней мере именно с этими инструментами приходилось работать за последние годы. На мой взгляд, самым продвинутым и эффективным остается PerfExpert, но это мое субъективное мнение.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Конечно, весь мониторинг можно организовать самостоятельно, но на это уйдет гораздо больше времени, а про сопровождение вообще лучше не говорить <!-- -->:)<!-- -->.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Это еще не все</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Мы рассмотрели преимущества использования Extended Events для диагностики работы СУБД и некоторые нюансы в контексте платформы 1С. Кратко пробежались по некоторым приемам работы с технологическим журналом и другим направлениям развития мониторинга.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Главное, что нужно понять, так это существующий большой разрыв в инструментах диагностики платформы 1С и SQL Server, причем не в пользу первой. Конечно, без ТЖ никуда, но для мониторинга СУБД и оперативной диагностики запросов, блокировок, взаимоблокировок и ошибок лучше использовать собственные инструменты SQL Server.</p></article><div class="Seperator_section_seperator_line__gdWIB dark:border-white border-black"></div><div class="PageLayout_author_and_more__wxN3W mx-auto"><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><div class="flex items-center"><div class="flex items-center justify-center shadow-xl rounded-full overflow-hidden bg-blue-500 shrink-0 w-[60px] h-[60px] mr-3 text-xl"><p class="text-center font-medium text-white">Y</p></div><div class="font-semibold"><p class="text-[20px]  mb-0 mt-0">YPermitin</p><p class="text-xs mt-0 mb-0">.NET, TSQL, DevOps, 1C:Enterprise</p></div></div><p class="text-[16px] mt-2">Developer, just developer.</p><div class="flex items-center flex-wrap mt-3"><a href="https://github.com/YPermitin" target="_blank" class="mr-[15px] text-[32px]" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></div><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><p class="border-b border-gray-300 pb-2 mb-3 font-medium w-full">Поделиться</p><div class="flex flex-wrap items-center"><a class="mr-3" aria-label="facebook-share" href="https://www.facebook.com/sharer/sharer.php?u=https://ypermitin.github.io" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-92.4 233.5h-63.9c-50.1 0-59.8 23.8-59.8 58.8v77.1h119.6l-15.6 120.7h-104V912H539.2V602.2H434.9V481.4h104.3v-89c0-103.3 63.1-159.6 155.3-159.6 44.2 0 82.1 3.3 93.2 4.8v107.9z"></path></svg></a><a class="mr-3" aria-label="twitter-share" href="http://twitter.com/share?text=Check out this article!! &amp;url=https://ypermitin.github.io&amp;hashtags=webdevelopment,javacript,javascriptdaily,webdevelopmenttutorial,tutorial" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm215.3 337.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg></a><a class="mr-3" aria-label="linkedin-share" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ypermitin.github.io&amp;title=Check out this article!!&amp;source=LinkedIn" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[23px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"></path></svg></a><button class="mr-3" name="copy-link" aria-label="copy-link"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"></path></svg></button></div><div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed flex transition-all right-[10px] -bottom-20 opacity-0" role="alert"><strong class="font-bold">Link Copied</strong><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"></path></svg></span></div></div><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><p class="border-b border-gray-300 pb-2 mb-3 font-medium w-full">Другие статьи</p><div class="flex flex-wrap"><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/.NET/2024-09/simple-and-fast-sql-clr/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/.NET/2024-09/simple-and-fast-sql-clr/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Расширение для SQL Server. Быстро и просто. SQLCLR снова в деле"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Расширение для SQL Server. Быстро и просто. SQLCLR снова в деле</div></div></div><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/DevOps/2024-08/ubuntu-vmware-kernel-modules-issue/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/DevOps/2024-08/ubuntu-vmware-kernel-modules-issue/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Решение проблем с модулями VMware в Ubuntu 22.04"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Решение проблем с модулями VMware в Ubuntu 22.04</div></div></div><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/.NET/2024-07/processes-under-control/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/.NET/2024-07/processes-under-control/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Берем процессы под контроль в .NET"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Берем процессы под контроль в .NET</div></div></div><a class="cursor-pointer hover:text-blue-500 block text-sm py-3 px-2 text-center dark:bg-slate-900 bg-blue-500 rounded text-white font-bold hover:!text-blue-900 dark:hover:!text-slate-400 transition-all" href="/blog/?author=YPermitin"><p>Все статьи от автора: <!-- -->YPermitin</p></a></div></div></div></div></section><div class="dark:bg-slate-900 dark:text-white bg-slate-100 text-black"><div class="md:container flex items-center md:justify-center justify-around flex-wrap md:text-[14px] text-[12px] py-5"><p class="my-0 mr-[10px] md:mr-3">Copyright © <!-- -->2024<!-- --> <!-- -->Убежище инженера</p></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/SQLServer/2019-05/monitoring-with-extended-events-and-other","query":{},"buildId":"4yxYh-zP3XFB_CwVS3bjj","nextExport":true,"autoExport":true,"isFallback":false,"dynamicIds":[28765,53220,30935,87355,47651],"scriptLoader":[]}</script></body></html>