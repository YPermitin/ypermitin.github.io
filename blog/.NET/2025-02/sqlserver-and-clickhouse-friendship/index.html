<!DOCTYPE html><html lang="en" translate="no"><head><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1"/><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="google" content="notranslate"/><title>Дружба между SQL Server и ClickHouse. SQLCLR снова с нами | Убежище инженера | YPermitin</title><meta name="robots" content="index,follow"/><meta name="description" content="Создаем дружбу между SQL Server и ClickHouse через SQLCLR (SELECT, BULK INSERT и любые другие запросы)."/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://ypermitin.github.io/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship"/><meta property="og:title" content="Дружба между SQL Server и ClickHouse. SQLCLR снова с нами | Убежище инженера | YPermitin"/><meta property="og:description" content="Создаем дружбу между SQL Server и ClickHouse через SQLCLR (SELECT, BULK INSERT и любые другие запросы)."/><meta property="og:url" content="https://ypermitin.github.io/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship"/><meta property="og:type" content="website"/><meta property="og:image" content="https://ypermitin.github.io/imp_assets/.NET/2025-02/sqlserver-and-clickhouse-friendship/logo.png"/><meta property="og:image:alt" content="Дружба между SQL Server и ClickHouse. SQLCLR снова с нами | Убежище инженера | YPermitin"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:locale" content="en_IN"/><meta property="og:site_name" content="Убежище инженера"/><link rel="canonical" href="https://webexpe.com/"/><meta property="keywords" content="C#, .NET, SQLServer, ClickHouse, SQLCLR"/><meta property="al:web:url" content="https://ypermitin.github.io/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship"/><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/9390881c82d58e40.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9390881c82d58e40.css" data-n-g=""/><link rel="preload" href="/_next/static/css/f381482cc81d5917.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f381482cc81d5917.css"/><link rel="preload" href="/_next/static/css/4a9df9e795bce52b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4a9df9e795bce52b.css"/><link rel="preload" href="/_next/static/css/ee5420a43edabb61.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ee5420a43edabb61.css"/><link rel="preload" href="/_next/static/css/88381d5dde4793c2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/88381d5dde4793c2.css"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script defer="" src="/_next/static/chunks/3a17f596-055cd9ef17181fc5.js"></script><script defer="" src="/_next/static/chunks/fea29d9f.0cfd8a10f65a727d.js"></script><script defer="" src="/_next/static/chunks/1664-468559f2e2a9395f.js"></script><script defer="" src="/_next/static/chunks/1274.6124caf478e7e4b5.js"></script><script defer="" src="/_next/static/chunks/8681.4514a8f7d45090c5.js"></script><script defer="" src="/_next/static/chunks/7897.b3984fce345297e6.js"></script><script defer="" src="/_next/static/chunks/7200.f56c768592bdb988.js"></script><script defer="" src="/_next/static/chunks/2726.5ee11496e940c0a2.js"></script><script src="/_next/static/chunks/webpack-e8a7f948ae318a2b.js" defer=""></script><script src="/_next/static/chunks/framework-945b357d4a851f4b.js" defer=""></script><script src="/_next/static/chunks/main-58191ff039d30768.js" defer=""></script><script src="/_next/static/chunks/pages/_app-acf79cc5654d0ec0.js" defer=""></script><script src="/_next/static/chunks/4104-89a1ab977b9431e5.js" defer=""></script><script src="/_next/static/chunks/pages/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship-06370f0ba4a63ac9.js" defer=""></script><script src="/_next/static/-bGN1hEP2YVpKeQylWsrE/_buildManifest.js" defer=""></script><script src="/_next/static/-bGN1hEP2YVpKeQylWsrE/_ssgManifest.js" defer=""></script></head><body class="bg-slate-100 dark:bg-slate-900 transition-all"><div id="__next"><div data-overlay-container="true"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><nav class="Navbar_navbar__W_ouQ bg-white  dark:bg-slate-900 dark:text-white text-black"><div class="container flex items-center justify-between px-2"><div class="flex items-center"><div class="Navbar_mobileBurgerToggle__Bj_52 mr-5  "><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="dark:text-white text-black text-2xl" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></div><a class="text-[22px] font-semibold" href="/">Убежище инженера</a></div><div class="flex items-center"><div class="text-[14px] font-normal items-center lg:flex hidden"><a class="cursor-pointer hover:text-blue-500 mx-2" href="/">Главная</a><div class="relative"><div class="flex items-center cursor-pointer mx-2"><p class="my-0">Блог</p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-[20px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path></svg></div><div class="overflow-auto absolute w-[180px] z-20 top-[30px] rounded-[4px] shadow-lg bg-white dark:bg-slate-800 border border-gray-300 dark:border-0 h-0 border-0"><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2" href="/blog/"><span>Все публикации</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=CPP"><span style="text-transform:capitalize">C++</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=.NET"><span style="text-transform:capitalize">.NET</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=DevOps"><span style="text-transform:capitalize">DevOps</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=PostgreSQL"><span style="text-transform:capitalize">PostgreSQL</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=SQL%20Server"><span style="text-transform:capitalize">SQL Server</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=1C:%D0%9F%D1%80%D0%B5%D0%B4%D0%BF%D1%80%D0%B8%D1%8F%D1%82%D0%B8%D0%B5"><span style="text-transform:capitalize">1C:Предприятие</span></a></div></div><a class="cursor-pointer hover:text-blue-500 mx-2" href="/instruments/">Инструменты</a><a class="cursor-pointer hover:text-blue-500 mx-2" href="/about/">Обо мне</a><a class="cursor-pointer hover:text-blue-500 mx-2" href="/contact/">Контакты</a><div class="ml-5 pt-1"><a href="https://github.com/YPermitin/" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><a href="https://t.me/TinyDevVault" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"></path></svg></a><a href="mailto:i.need.ypermitin@yandex.ru" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0 0 68.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg></a><a href="https://boosty.to/ypermitin" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 21h9.62a3.995 3.995 0 0 0 3.037-1.397l5.102-5.952a1 1 0 0 0-.442-1.6l-1.968-.656a3.043 3.043 0 0 0-2.823.503l-3.185 2.547-.617-1.235A3.98 3.98 0 0 0 9.146 11H4c-1.103 0-2 .897-2 2v6c0 1.103.897 2 2 2zm0-8h5.146c.763 0 1.448.423 1.789 1.105l.447.895H7v2h6.014a.996.996 0 0 0 .442-.11l.003-.001.004-.002h.003l.002-.001h.004l.001-.001c.009.003.003-.001.003-.001.01 0 .002-.001.002-.001h.001l.002-.001.003-.001.002-.001.002-.001.003-.001.002-.001c.003 0 .001-.001.002-.001l.003-.002.002-.001.002-.001.003-.001.002-.001h.001l.002-.001h.001l.002-.001.002-.001c.009-.001.003-.001.003-.001l.002-.001a.915.915 0 0 0 .11-.078l4.146-3.317c.262-.208.623-.273.94-.167l.557.186-4.133 4.823a2.029 2.029 0 0 1-1.52.688H4v-6zM16 2h-.017c-.163.002-1.006.039-1.983.705-.951-.648-1.774-.7-1.968-.704L12.002 2h-.004c-.801 0-1.555.313-2.119.878C9.313 3.445 9 4.198 9 5s.313 1.555.861 2.104l3.414 3.586a1.006 1.006 0 0 0 1.45-.001l3.396-3.568C18.688 6.555 19 5.802 19 5s-.313-1.555-.878-2.121A2.978 2.978 0 0 0 16.002 2H16zm1 3c0 .267-.104.518-.311.725L14 8.55l-2.707-2.843C11.104 5.518 11 5.267 11 5s.104-.518.294-.708A.977.977 0 0 1 11.979 4c.025.001.502.032 1.067.485.081.065.163.139.247.222l.707.707.707-.707c.084-.083.166-.157.247-.222.529-.425.976-.478 1.052-.484a.987.987 0 0 1 .701.292c.189.189.293.44.293.707z"></path></svg></a></div></div><div class="Navbar_search_icon_wrapper__1a_rL ml-5 dark:text-white"><button name="search-button" aria-label="search button"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="dark:text-white text-black text-[22px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></button></div><div class=""><button name="share" aria-label="share page"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="dark:text-white text-black text-[16px] mt-[7px] ml-2 mr-1" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.5 2.5 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5"></path></svg></button></div><button name="theme-switch" aria-label="theme button" class="Navbar_theme_switch__q7F_Z pl-3 dark:text-white text-black"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-md " height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"></path></svg></button></div></div></nav><aside class="Navbar_nav_sidebar_wrapper__M0KaI dark:bg-slate-900 dark:text-white bg-white text-black"><div class="flex items-center justify-between pb-3"><p class="">МЕНЮ</p><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-slate-800 dark:text-white text-[25px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0V0z"></path><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg></div></div><hr/><div class="my-15"><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/">Главная</a><div class="relative"><div class="flex items-center cursor-pointer justify-between"><p class="my-0">Блог</p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-[20px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path></svg></div><div class="overflow-auto relative h-0 border-0"><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2" href="/blog/"><span>Все публикации</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=CPP"><span style="text-transform:capitalize">C++</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=.NET"><span style="text-transform:capitalize">.NET</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=DevOps"><span style="text-transform:capitalize">DevOps</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=PostgreSQL"><span style="text-transform:capitalize">PostgreSQL</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=SQL%20Server"><span style="text-transform:capitalize">SQL Server</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=1C:%D0%9F%D1%80%D0%B5%D0%B4%D0%BF%D1%80%D0%B8%D1%8F%D1%82%D0%B8%D0%B5"><span style="text-transform:capitalize">1C:Предприятие</span></a></div></div><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/instruments/">Инструменты</a><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/about/">Обо мне</a><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/contact/">Контакты</a></div><hr/><div class="my-5"><p class="font-light">Подписаться : </p> <a href="https://github.com/YPermitin/" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><a href="https://t.me/TinyDevVault" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"></path></svg></a><a href="mailto:i.need.ypermitin@yandex.ru" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0 0 68.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg></a><a href="https://boosty.to/ypermitin" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 21h9.62a3.995 3.995 0 0 0 3.037-1.397l5.102-5.952a1 1 0 0 0-.442-1.6l-1.968-.656a3.043 3.043 0 0 0-2.823.503l-3.185 2.547-.617-1.235A3.98 3.98 0 0 0 9.146 11H4c-1.103 0-2 .897-2 2v6c0 1.103.897 2 2 2zm0-8h5.146c.763 0 1.448.423 1.789 1.105l.447.895H7v2h6.014a.996.996 0 0 0 .442-.11l.003-.001.004-.002h.003l.002-.001h.004l.001-.001c.009.003.003-.001.003-.001.01 0 .002-.001.002-.001h.001l.002-.001.003-.001.002-.001.002-.001.003-.001.002-.001c.003 0 .001-.001.002-.001l.003-.002.002-.001.002-.001.003-.001.002-.001h.001l.002-.001h.001l.002-.001.002-.001c.009-.001.003-.001.003-.001l.002-.001a.915.915 0 0 0 .11-.078l4.146-3.317c.262-.208.623-.273.94-.167l.557.186-4.133 4.823a2.029 2.029 0 0 1-1.52.688H4v-6zM16 2h-.017c-.163.002-1.006.039-1.983.705-.951-.648-1.774-.7-1.968-.704L12.002 2h-.004c-.801 0-1.555.313-2.119.878C9.313 3.445 9 4.198 9 5s.313 1.555.861 2.104l3.414 3.586a1.006 1.006 0 0 0 1.45-.001l3.396-3.568C18.688 6.555 19 5.802 19 5s-.313-1.555-.878-2.121A2.978 2.978 0 0 0 16.002 2H16zm1 3c0 .267-.104.518-.311.725L14 8.55l-2.707-2.843C11.104 5.518 11 5.267 11 5s.104-.518.294-.708A.977.977 0 0 1 11.979 4c.025.001.502.032 1.067.485.081.065.163.139.247.222l.707.707.707-.707c.084-.083.166-.157.247-.222.529-.425.976-.478 1.052-.484a.987.987 0 0 1 .701.292c.189.189.293.44.293.707z"></path></svg></a><hr class="mt-5"/></div><div class="mt-5 mb-4"><p class="mb-2 font-light">Переключиться на <!-- -->светлую<!-- --> тему :</p><button name="theme-switch" aria-label="theme-switch" class="Navbar_theme_switch__q7F_Z dark:text-white text-black"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-lg" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"></path></svg></button></div><hr/><div class="my-5"><p class="text-sm font-light dark:text-gray-400 text-gray-500 mb-1">Copyright © 2024</p></div></aside><div class="transition-all fixed h-screen w-screen flex items-center justify-center left-0 z-20 top-0 pointer-events-none opacity-0"><div class="absolute top-0 left-0 w-screen h-screen bg-black opacity-50"></div><div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded lg:w-1/6 mx-3 w-full relative z-10 transition-all top-10"><div class="flex border-gray-300 pb-2 mb-3 border-b"><p class="  font-medium w-full">Share:</p><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"></path></svg></span></div><div class="flex flex-wrap items-center"><a class="mr-3" aria-label="facebook-share" href="https://www.facebook.com/sharer/sharer.php?u=https://ypermitin.github.io" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-92.4 233.5h-63.9c-50.1 0-59.8 23.8-59.8 58.8v77.1h119.6l-15.6 120.7h-104V912H539.2V602.2H434.9V481.4h104.3v-89c0-103.3 63.1-159.6 155.3-159.6 44.2 0 82.1 3.3 93.2 4.8v107.9z"></path></svg></a><a class="mr-3" aria-label="twitter-share" href="http://twitter.com/share?text=Check out this article!! &amp;url=https://ypermitin.github.io&amp;hashtags=webdevelopment,javacript,javascriptdaily,webdevelopmenttutorial,tutorial" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm215.3 337.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg></a><a class="mr-3" aria-label="linkedin-share" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ypermitin.github.io&amp;title=Check out this article!!&amp;source=LinkedIn" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[23px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"></path></svg></a><button class="mr-3" name="copy-link" aria-label="copy-link"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"></path></svg></button></div><div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed flex transition-all right-[10px] -bottom-20 opacity-0" role="alert"><strong class="font-bold">Link Copied</strong><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"></path></svg></span></div></div></div><section class="PageLayout_centered_article_wrapper__gS3Af dark:bg-slate-900 dark:text-white"><div class="container px-0 md:px-[15px] pt-[50px] pb-[50px]"><article class="PageLayout_article_content__4dnq3 pb-[30px] px-3 bg-white dark:bg-slate-800 dark:border-none dark:drop-shadow-lg dark:text-white pt-10 md:pt-0 mx-auto font-regular text-lg leading-relaxed"><div class="mb-[30px]"><h1 class="ArticleHeader_articleTitle__3L1Bi text-center text-2xl md:text-4xl font-medium mt-[20px] mb-[5px]">Дружба между SQL Server и ClickHouse. SQLCLR снова с нами</h1><div class="mb-[10px] mt-[15px] text-[14px] font-medium ArticleHeader_centered_article_header_author___gRtE"><p class="my-0 mx-[30px] font-medium">YPermitin<span class="px-1 font-light">в</span><a href="/blog/?category=.NET">.NET</a></p><p class="my-0">2025-02-18</p></div><div class="md:mt-2 flex flex-wrap justify-center"><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->C#</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->.NET</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->SQLServer</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->ClickHouse</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->SQLCLR</p></div></div><blockquote class="text_quoted_text__5DQLs" style="text-align:right"><q>Настоящая дружба правдива и отважна.<br/>(с) Байрон Д.</q></blockquote><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Создаем дружбу между SQL Server и ClickHouse через SQLCLR (SELECT, BULK INSERT и любые другие операции).</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Содержание</h1><ul class="List_list__zLjGi list-disc pl-[30px]"><li><a class="cursor-pointer hover:text-blue-500" href="/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship/#integration"><b><u>Интеграция - вечная задача</u></b></a></li><li><a class="cursor-pointer hover:text-blue-500" href="/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship/#show-me-cards"><b><u>Раскройте все карты</u></b></a></li><li><a class="cursor-pointer hover:text-blue-500" href="/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship/#sqlclr-and-legacy"><b><u>SQLCLR и мир легаси</u></b></a></li><li><a class="cursor-pointer hover:text-blue-500" href="/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship/#where-is-library"><b><u>Как пройти в библиотеку?</u></b></a></li><li><a class="cursor-pointer hover:text-blue-500" href="/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship/#setup-and-config"><b><u>Установка и настройка</u></b></a></li><li><a class="cursor-pointer hover:text-blue-500" href="/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship/#queries"><b><u>Запросы, запросы, запросы</u></b></a></li><li><a class="cursor-pointer hover:text-blue-500" href="/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship/#thoughts"><b><u>Немного мыслей</u></b></a></li><li><a class="cursor-pointer hover:text-blue-500" href="/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship/#link"><b><u>Полезные материалы</u></b></a></li></ul><section id="section-integration"><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset" id="integration">Интеграция - вечная задача</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Мы живем в мире разнообразного ПО, написанного на разных языках, платформах, для разных ОС и выполняющего абсолютно (или почти) разные задачи. Таков наш путь, а значит и таковы задачи.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">В таких условиях задача интеграции будет всегда актуальной. Не обошел этот вопрос стороной и интеграцию между такими СУБД как SQL Server и ClickHouse. Причин подружить эти две великолепные СУБД может быть много. Да даже организация массовых выгрузок из OLTP-базы на SQL Server в DWH на ClickHouse может быть весьма распространённой задачей.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Сегодня мы как раз этим делом и займемся, но обо всем по порядку. Сначала мы рассмотрим в общих чертах самые популярные пути, а после остановимся на одном из них немного подробней. Речь идет, конечно, об интеграции SQL Server с ClickHouse средствами расширения SQLCLR.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">В статье мы пройдем весь путь от подготовки клиентской библиотеки и ее корректной установки в среде CLR для SQL Server, до установки расширения и его использования различными способами. Для тех, кто хочет сразу посмотреть на готовую библиотеку и примеры использования - прошу перейти к GitHub на <a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Readme.md" target="_blank" rel="noopener noreferrer"><b><u>страницу проекта</u></b></a>.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Для любопытных - добро пожаловать в дальнейшее путешествие! Настало время погрузиться в перекрестный мир .NET / SQL Server / ClickHouse!</p></section><section id="section-show-me-cards"><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset" id="show-me-cards">Раскройте все карты</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Существуют различные пути реализовать интеграцию SQL Server с базами ClickHouse. Вот самые распространенные решения:<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Выгрузка данных из SQL Server в файлы и их последующая загрузка в ClickHouse.</b> Это могут быть обычные csv / tsv файлы, которые ClickHouse обрабатывает достаточно эффективно. Выгрузку из SQL Server можно выполнять <a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-BCP" target="_blank" rel="noopener noreferrer"><b><u>средствами штатной утилиты BCP</u></b></a> или любым другим удобным способом.</li><li><b>Linked Server</b> - еще одно решение. Со стороны SQL Server можно подключить инстанс / базы ClickHouse в качестве Linked Server&#x27;а и работать с ней через обычные запросы T-SQL, но, к сожалению, с существенными ограничениями. Более подробную информацию <a href="https://github.com/YPermitin/ClickHouseTools/tree/main/CH-Integration" target="_blank" rel="noopener noreferrer"><b><u>можно найти здесь</u></b></a>, в том числе <a href="https://github.com/ClickHouse/clickhouse-odbc/blob/master/test/mssql.linked.server.sql" target="_blank" rel="noopener noreferrer"><b><u>пример настройки</u></b></a>. Работа с ClickHouse при это будет выполняться через ODBC-драйвер, а обработку типов и вообще любой результат запроса нужно будет обрабатывать вручную.</li><li><b>Подключение ClickHouse к SQL Server через ODBC</b> - еще один альтернативный способ интеграции. Можно делать запросы через ODBC-драйвер со стороны ClickHouse до SQL Server. Для этого можно либо использовать конструкцию:<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-fOOuSg sc-hdBJTi bIdCqC beyZJb prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> odbc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">СтрокаПодключенияКSQLServer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Схема</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ИмяТаблицы</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></div></pre></div></div>Либо создать таблицу с движком OBDC. Дополнительную информацию можно узнать в <a href="https://clickhouse.com/docs/knowledgebase/how-to-set-up-ch-on-docker-odbc-connect-mssql" target="_blank" rel="noopener noreferrer"><b><u>официальной документации</u></b></a>.</li><li><b>Промежуточное ПО</b> - можно создать свое или купить готовое ПО, которое выступит посредником в передаче данных между SQL Server и ClickHouse (в обоих направлениях). Тут уже все ограничено лишь воображением, готовыми техническими инструментами для выбранного языка / платформы, ну и, конечно же, бюджетом!</li></ul></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Но мы пойдем другим путем, чтобы получить большую гибкость в функционале и крутые фичи в виде операций BULK INSERT из SQL Server в ClickHouse! В прошлой статье <a href="/blog/.NET/2024-09/simple-and-fast-sql-clr" target="_blank" rel="noopener noreferrer"><b><u>&quot;Расширение для SQL Server. Быстро и просто. SQLCLR снова в деле&quot;</u></b></a> мы уже рассмотрели процесс создания простого расширения SQLCLR для SQL Server. Так почему бы не пойти тем же путем и не организовать работу с ClickHouse из SQL Server этим же способом?</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Задача эта не так проста, как кажется на первый взгляд. Ведь среда CLR, которую использует SQL Server, весьма ограничена в возможностях, а также базируется на устаревшем .NET Framework 4.x. Да что уж тут говорить, если даже не все стандартные сборки доступны для использования из этой среды.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Но, если очень захотеть, то все преграды можно обойти! Займемся же этим!</p></section><section id="section-sqlclr-and-legacy"><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset" id="sqlclr-and-legacy">SQLCLR и мир легаси</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Мы работаем с SQLCLR, среда выполнения которого имеет собственные ограничения. Какие? Их много, но нас интересуют следующие:<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Использование среды выполнения .NET Framework 4.x</b> - в конфигурационном файле <b>sqlservr.exe.config</b>, расположенном в каталоге исполняемых файлов SQL Server (например по пути <b>&quot;C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\Binn\sqlservr.exe.config&quot;</b>, который зависит от версии SQL Server), указывается версия .NET Framework 4.x:<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-iIvHqT sc-jxOwhs fnyebm cvHrAn prism-code language-xml" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token prolog" style="color:rgb(0, 0, 128)">&lt;?xml version =&quot;1.0&quot;?&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">configuration</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">startup</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">useLegacyV2RuntimeActivationPolicy</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">true</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">supportedRuntime</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">v4.0</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">startup</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">runtime</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">assemblyBinding</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">urn:schemas-microsoft-com:asm.v1</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">dependentAssembly</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">              </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">assemblyIdentity</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Microsoft.SqlServer.Types</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">publicKeyToken</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">89845dcd8080cc91</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">              </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">publisherPolicy</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">apply</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">no</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">              </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">bindingRedirect</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">oldVersion</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">11.0.0.0-15.0.0.0</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">newVersion</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">15.0.0.0</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">dependentAssembly</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">assemblyBinding</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">disableCachingBindingFailures</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">enabled</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">1</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">CodeHeapReserveForJumpStubs</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">5</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">runtime</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">configuration</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span></div></pre></div></div>То есть мы не можем использовать библиотеки и новые возможности современной версии платформы .NET (все, что начинается от .NET Core и до .NET 9+).</li><li><b>Нет возможности использовать библиотеки .NET Standard</b> - это вытекает из предыдущего пункта, хоть и не очевидным образом. .NET Standard - это спецификация для всех реализаций .NET. И хотя спецификация версии 2.0 и ниже поддерживают .NET Framework 4.x, среда выполнения SQLCLR работы с .NET Standard не поддерживает. То есть мы не сможем использовать современные библиотеки .NET даже с поддержкой .NET Standard.</li><li><b>Ограниченная поддержка стандартных библиотек в среде SQLCLR</b> - не все стандартные библиотеки .NET Framework поддерживаются в среде SQLCLR, а значит мы не можем просто так ссылаться на них. Вот список библиотек, которые по умолчанию нам доступы:<ul class="List_list__zLjGi list-disc pl-[30px]"><li>mscorlib.dll</li><li>CustomMarshalers.dll</li><li>Microsoft.VisualBasic.dll</li><li>Microsoft.VisualC.dll</li><li>System.Configuration.dll</li><li>System.Core.dll</li><li>System.Data.OracleClient.dll</li><li>System.Data.SqlXml.dll</li><li>System.Data.dll</li><li>System.Deployment.dll</li><li>System.Security.dll</li><li>System.Transactions.dll</li><li>System.Web.Services.dll</li><li>System.Xml.Linq.dll</li><li>system.Xml.dll</li><li>System.dll</li></ul>Мы можем подключать сторонние сборки и обойти это ограничение, чем мы далее и займемся. Более подробную информацию Вы можете найти в <a href="https://learn.microsoft.com/en-us/sql/relational-databases/clr-integration/database-objects/supported-net-framework-libraries?view=sql-server-ver16" target="_blank" rel="noopener noreferrer"><b><u>официальной документации</u></b></a>.</li></ul></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Ограничения мы знаем, но как это влияет на нас? Первый важный шаг - это реализация клиентской библиотеки для отправки запросов в ClickHouse из среды .NET. Конечно, можно создать собственное решение на .NET Framework с нуля, но это долго. Очень долго. Поэтому возьмем готовую библиотеку <a href="https://github.com/DarkWanderer/ClickHouse.Client" target="_blank" rel="noopener noreferrer"><b><u>ClickHouse.Client</u></b></a>, но вот незадача - библиотека поддерживает работу из .NET Framework через .NET Standard. Но мы уже знаем, что SQLCLR такое не поддерживает.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Выход только один - взять исходный код библиотеки и перевести её полностью на .NET Framework 4.x (например, версию 4.8). Причем важно учитывать и зависимости, на которые ссылается библиотека. Они также не должны содержать ссылок на неподдерживаемые версии .NET.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">На момент создания статьи была использована версия 7.9.1. Мы сделаем обзор основных шагов для адаптации библиотеки под .NET Framework, а финальную версию Вы можете сразу посмотреть <a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient" target="_blank" rel="noopener noreferrer"><b><u>в готовом проекте расширения SQLCLR для ClickHouse</u></b></a>. Вот такие изменения были сделаны:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Было выполнено понижение версий библиотек</b> из зависимостей, чтобы избавиться от ссылок на .NET Standard. Изменение версий существенное, но такова цена возврата к legacy:<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Newtonsoft.Json</b> - установлена версия 8.0.3 взамен <b>System.Text.Json</b>, которого для .NET Framework еще не существовало.</li><li><b>NodaTime</b> - с версии 3.2.1 на 1.4.7, в которой имеется поддержка .NET Framework без поддержи современных реализаций .NET.</li></ul>Вот содержимое файла настроек зависимостей <b>packages.config</b>:<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-lcItFd sc-cpclqO elRQcd kKSDxA prism-code language-xml" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token prolog" style="color:rgb(0, 0, 128)">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">packages</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">package</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">id</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">Newtonsoft.Json</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">8.0.3</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">targetFramework</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">net48</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">package</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">id</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">NodaTime</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">1.4.7</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">targetFramework</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">net48</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">packages</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Именно эти версии библиотек выбраны, потому что они самые последние из доступных, где есть только поддержка .NET Framework без ссылок на .NET Standard или более новые версии .NET.</p></li><li><b>Исключено использование новых возможностей платформы .NET:</b><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>record struct</b> - убрано использование <a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient/TypeSettings.cs" target="_blank" rel="noopener noreferrer"><b><u> неподдерживаемой конструкции</u></b></a>.</li><li><b>Переезд на Newtonsoft.Json</b> - мы убрали <b>System.Text.Json</b> и установили <b>Newtonsoft.Json</b>, а значит нужно и изменить алгоритмы работы с JSON. Прмер файла <a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient/ADO/ClickHouseCommand.cs" target="_blank" rel="noopener noreferrer"><b><u>с изменением</u></b></a>.<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-dTWiOz sc-eJoXEY jchURK jEjZWa prism-code language-csharp" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">// Было</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token generic-method function" style="color:rgb(220, 220, 170)">Deserialize</span><span class="token generic-method generic class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(78, 201, 176)">QueryStats</span><span class="token generic-method generic class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> SummarySerializerOptions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// Стало</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> queryStats </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> JsonConvert</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token generic-method function" style="color:rgb(220, 220, 170)">DeserializeObject</span><span class="token generic-method generic class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(78, 201, 176)">QueryStats</span><span class="token generic-method generic class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> queryStats</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div></li><li><b>ArrayPool</b> - эх, пришлось отказаться от <b>ArrayPool</b>. Это пул переиспользуемых ресурсов для оптимизации потребления памяти. В .NET Framework об этих возможностях ничего неизвестно, а значит пришлось убрать его использование и вернуться к менее оптимальным алгоритмам. Больше всего пострадала пакетная обработка коллекций <a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient/Utility/EnumerableExtensions.cs" target="_blank" rel="noopener noreferrer"><b><u>класса EnumerableExtensions.cs</u></b></a>.<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-goiVcJ sc-gSifMm iFNTDr iRFHRd prism-code language-csharp" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(78, 201, 176)">IEnumerable</span><span class="token return-type class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token return-type class-name punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token return-type class-name" style="color:rgb(78, 201, 176)">T</span><span class="token return-type class-name punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token return-type class-name punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token return-type class-name punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token return-type class-name" style="color:rgb(78, 201, 176)"> </span><span class="token return-type class-name keyword" style="color:rgb(86, 156, 214)">int</span><span class="token return-type class-name punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token return-type class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token generic-method function" style="color:rgb(220, 220, 170)">BatchRented</span><span class="token generic-method generic class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(78, 201, 176)">T</span><span class="token generic-method generic class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">this</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">IEnumerable</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token class-name" style="color:rgb(78, 201, 176)">T</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> enumerable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> batchSize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name" style="color:rgb(78, 201, 176)">List</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token class-name" style="color:rgb(78, 201, 176)">T</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> items </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">List</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">T</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">//var array = ArrayPool&lt;T&gt;.Shared.Rent(batchSize);</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> counter </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> item </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> enumerable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)">//array[counter++] = item;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        counter</span><span class="token operator" style="color:rgb(212, 212, 212)">++</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">counter </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;=</span><span class="token plain"> batchSize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">ToArray</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> counter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)">//yield return (array, counter);</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            counter </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)">//array = ArrayPool&lt;T&gt;.Shared.Rent(batchSize);</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            items </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">List</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">T</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">counter </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)">//yield return (array, counter);</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">ToArray</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> counter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></div></pre></div></div>Класс используется при работе с операциями BULK INSERT, так что они станут менее оптимальными в части потребления ресурсов, но в целом все равно рабочими и эффективными.</li><li><b>Удалено использование стандартных классов логирования</b> - убрали использование <b>Microsoft.Extensions.Logging</b>. Замену добавлять не стал. Относится к реализации <b>ClickHouseConnection</b>, <a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient/ADO/ClickHouseConnection.cs" target="_blank" rel="noopener noreferrer"><b><u>вот файл этого класса</u></b></a>.</li><li>И другие мелочи.</li></ul></li><li><b>Включена поддержка C# 9.0</b> - это для поддержки некоторых новых функций из современного .NET, но в контексте .NET Framework. Например, это записи (records) и некоторые другие мелочи. В файле проекта <b>ClickHouseClient.csproj</b> это достигнуто добавлением строки:<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-ixcdjX sc-eQaGpr iBtGJd dQVMvG prism-code language-xml" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">LangVersion</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain">9.0</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">LangVersion</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span></div></pre></div></div>Здесь Вы <a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient/ClickHouseClient.csproj" target="_blank" rel="noopener noreferrer"><b><u>можете посмотреть файл полностью</u></b></a>.</li><li>И другие мелкие изменения.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">По большей части изменений не так уж и много. Вот она сила обратной совместимости .NET! Теперь у нас есть чистая версия библиотеки для .NET Framework 4 без каких-либо &quot;подозрительных&quot; зависимостей. А самое главное - совместимая со средой выполнения SQLCLR.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Но работа по погружению в мир legacy еще не окончена. Для работы с ClickHouse внутри библиотеки используется класс <b>HttpClient</b> из пространства имен <b>System.Net.Http</b>. Проблема в том, что в среде SQLCLR по умолчанию сборка с реализацией этого класса отсутствует. При попытке использования нашей адаптированной библиотеки мы получим ошибку вида:<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-VLMBG sc-gXbNzB hkuzhT dWBRqp prism-code language-text" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain">Assembly &#x27;system.net.http, version=4.0.0.0, culture=neutral, publickeytoken=b03f5f7f11d50a3a.&#x27; was not found in the SQL catalog.</span></div></pre></div></div>или<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-dcMTLQ sc-bBhMX jBCHZS dkRiGP prism-code language-text" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain">Assembly &#x27;System.Net.Http&#x27; could not be installed because existing policy would keep it from being used.</span></div></pre></div></div>То есть эта сборка просто недоступна по умолчанию!</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Это значит, что нам нужно эту сборку зарегистрировать! Но не все так просто. Убедившись, что .NET Framework 4.х установлен на машине вместе со SQL Server, нужно выполнить следующие действия <b>в контексте базы данных</b> (пусть в примере будет база <b>PowerSQLCLR</b>), где потом будет установлено расширение SQLCLR:<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-hwHXyi sc-ciCoXh iwyBsS joVayI prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Этап 1. Включаем поддержку SQLCLR для инстанса SQL Server и доверие для базы данных.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXEC</span><span class="token plain"> sp_configure </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;clr enabled&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">RECONFIGURE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DATABASE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> TRUSTWORTHY </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Этап 2. Подготавливаем сертификаты Microsoft для сборок .NET Framework.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Этот шаг необходим для подключения стандартных сборок .NET</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- к инстансу SQL Server. Для добавленного сертификата создаем</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- служебную учетную запись и разрешаем работать со сборками.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">USE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">master</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> CERTIFICATE </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> EXECUTABLE </span><span class="token keyword" style="color:rgb(86, 156, 214)">FILE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\System.Net.Http.dll&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> LOGIN </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> CERTIFICATE </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GRANT</span><span class="token plain"> UNSAFE ASSEMBLY </span><span class="token keyword" style="color:rgb(86, 156, 214)">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DENY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CONNECT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">SQL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> LOGIN </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DISABLE</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Этап 3. Добавляем стандартные сборки .NET Framework в служебную базу.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Эти сборки необходимы для работы клиента ClickHouse.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">USE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> ASSEMBLY </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">System</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Http</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\System.Net.Http.dll&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> PERMISSION_SET </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> UNSAFE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> ASSEMBLY </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">System</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Web</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\System.Web.dll&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> PERMISSION_SET </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> UNSAFE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div></pre></div></div>То есть мы выполнили следующие шаги:<ul class="List_list__zLjGi list-disc pl-[30px]"><li>Включили поддержку SQLCLR, если она еще не была включена.</li><li>Зарегистрировали сертификат стандартных сборок .NET Framework для последующего импорта этих сборок.</li><li>Добавили стандартные сборки <b>System.Net.Http</b> и <b>System.Web</b> для корректной работы класса <b>HttpClient</b></li></ul></p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_small__BEVeh display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/.NET/2025-02/sqlserver-and-clickhouse-friendship/1. Сборки.png" alt="Установленные сборки .NET в SQL Server" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Теперь все готово для непосредственного создания расширения SQLCLR. Все, что нужно в мире legacy, мы подготовили.</p></section><section id="section-where-is-library"><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset" id="where-is-library">Как пройти в библиотеку?</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Вот мы вплотную подошли к непосредственному созданию библиотеки расширения SQLCLR, ведь все legacy-подготовки уже закончились. Мы не будем рассматривать базовые принципы создания расширений SQLCLR, ведь мы это делали уже в статье <a href="/blog/.NET/2024-09/simple-and-fast-sql-clr" target="_blank" rel="noopener noreferrer"><b><u>Расширение для SQL Server. Быстро и просто. SQLCLR снова в деле</u></b></a>. Здесь мы сразу определимся, что собираемся реализовать.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Наше расширение будет содержать следующие методы:<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>ExecuteScalar</b> - это скалярная функция, возвращающее первое значение из первой колонки по результатам выполнения запроса.</li><li><b>ExecuteSimple</b> - это табличная функция, возвращающая таблицу с единственной колонкой <b>ResultValue</b> строкового типа, в котором содержатся значения произвольного запроса. Любой возвращаемый тип будет преобразован к строке. Если в первой колонке содержится кортеж ClickHouse с несколькими значениями, то значение будет преобразовано к строке JSON.</li><li><b>ExecuteStatement</b> - это хранимая процедура для выполнения любого выражения без возвращаемых значений. Например, для создания таблицы в базе ClickHosue.</li><li><b>ExecuteToTempTable</b> - выполнение произвольного запроса SELECT к ClickHouse с сохранением полученного результата во временную таблицу SQL Server.</li><li><b>ExecuteToGlobalTempTable</b> - выполнение произвольного запроса SELECT к ClickHouse с сохранением полученного результата во временную ГЛОБАЛЬНУЮ таблицу SQL Server.</li><li><b>ExecuteBulkInsertFromTempTable</b> - выполнение операции BULK INSERT в таблицу ClickHouse из подготовленного набора данных, которых хранится во временной таблице SQL Server.</li></ul></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Полную реализацию библиотеки расширения SQLCLR Вы можете посмотреть в проекте <a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient.Entry" target="_blank" rel="noopener noreferrer"><b><u>ClickHouseClient.Entry</u></b></a>, а ниже мы пробежимся по основным моментам её реализации. Верхний уровень реализации находится в файле <a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient.Entry/EntryClickHouseClient.cs" target="_blank" rel="noopener noreferrer"><b><u>EntryClickHouseClient.cs</u></b></a>.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Функция <b>ExecuteScalar</b> самая простая в реализации. В качестве параметров получаем строку подключения к ClickHouse и текст запроса, а результатом будет срока со значением из запроса.<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jDJeIs sc-eEHciv jiFJNe kCRglK prism-code language-csharp" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// Функция для выполнения запроса к ClickHouse и получения скалярного значения</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;/summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;connectionString&quot;&gt;Строка подключения к ClickHouse&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;queryText&quot;&gt;SQL-текст запроса для выполнения&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;returns&gt;Результат запроса, представленный строкой&lt;/returns&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token function" style="color:rgb(220, 220, 170)">SqlFunction</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">DataAccess </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> DataAccessKind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteScalar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> queryText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> connectionStringValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> queryTextValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">queryText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> resultAsString </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Empty</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> connection </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">ClickHouseConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connectionStringValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> queryResult </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> connection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteScalarAsync</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">queryTextValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetAwaiter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetResult</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        resultAsString </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> queryResult</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">ToString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">resultAsString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Мы используем адаптированную ранее библиотеку <b>ClickHouse.Client</b> и ее класс <b>ClickHouseConnection</b>. Все просто, как дважды два!</p></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Функция <b>ExecuteSimple</b> также простая в реализации, как и предыдущая. В качестве параметров получаем строку подключения к ClickHouse и текст запроса, а результатом будет коллекция строк, представляющих значения первой колонки запроса, преобразованные к строке (представление строки для примитивных типов и JSON для сложных типов).<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-KsiuK sc-hqtLyI enaQly drVMdj prism-code language-csharp" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// Функция для выполнения простого запроса.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// Возвращается только первая колонка из результата запроса в виде строки.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;/summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;connectionString&quot;&gt;Строка подключения к ClickHouse&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;queryText&quot;&gt;SQL-текст запроса для выполнения&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;returns&gt;Набор результата запроса (только первая колонка в виде строки)&lt;/returns&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token function" style="color:rgb(220, 220, 170)">SqlFunction</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    FillRowMethodName </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ExecuteSimpleFillRow&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    SystemDataAccess </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> SystemDataAccessKind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    DataAccess </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> DataAccessKind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(78, 201, 176)">IEnumerable</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteSimple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> queryText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name" style="color:rgb(78, 201, 176)">List</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token class-name" style="color:rgb(78, 201, 176)">ExecuteSimpleRowResult</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> resultRows </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">List</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">ExecuteSimpleRowResult</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> connectionStringValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> queryTextValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">queryText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> connection </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">ClickHouseConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connectionStringValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> reader </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> connection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteReaderAsync</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">queryTextValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetAwaiter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetResult</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                resultRows</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">ExecuteSimpleRowResult</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    ResultValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ConvertTypeToSqlCommandType</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">ToString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> resultRows</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteSimpleFillRow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">object</span><span class="token plain"> resultRow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">out</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> rowValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> resultRowObject </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ExecuteSimpleRowResult</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">resultRow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    rowValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">resultRowObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ResultValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Отличие от функции <b>ExecuteScalar</b> в обработке результата запроса, где каждую строку мы преобразуем к объекту класса <b>ExecuteSimpleRowResult</b>:<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-iVnIWt sc-hWgKua gydTzC bNUHpx prism-code language-csharp" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">namespace</span><span class="token plain"> </span><span class="token namespace">YPermitin</span><span class="token namespace punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token namespace">SQLCLR</span><span class="token namespace punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token namespace">ClickHouseClient</span><span class="token namespace punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token namespace">Models</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">ExecuteSimpleRowResult</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> ResultValue </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">set</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></div></pre></div></div>Преобразования значений к строке выполняем через метод <b>ConvertTypeToSqlCommandType</b>, суть которого получение представления для примитивных типов и JSON-строки для сложных типов. Приводить здесь листинг не буду, вы можете посмотреть реализацию <a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient.Entry/EntryClickHouseClient.cs" target="_blank" rel="noopener noreferrer"><b><u>воооот здесь</u></b></a>.</p></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Хранимая процедура <b>ExecuteStatement</b> еще проще в реализации, чем предыдущие примеры. Также принимает строку подключения к ClickHouse и текст запроса, но при выполнении не считывает результат, т.к. предназначена в основном для отправки DDL/DML-команд.<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jBaHRL sc-gFqXPY gxXpO hcCNhz prism-code language-csharp" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// Выполнение команды к ClickHouse без получения результата</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;/summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;connectionString&quot;&gt;Строка подключения к ClickHouse&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;queryText&quot;&gt;SQL-текст команды&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SqlProcedure</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteStatement</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> queryText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> connectionStringValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> queryTextValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">queryText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> connection </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">ClickHouseConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connectionStringValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> queryResult </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> connection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteStatementAsync</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">queryTextValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetAwaiter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetResult</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Без комментариев, ведь нового тут ничего нет.</p></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify"><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Две хранимые процедуры <b>ExecuteToTempTable</b> и <b>ExecuteToGlobalTempTable</b> нужны для выполнения запроса SELECT к ClickHouse с целью сохранения результата в указанные и подготовленные заранее временные таблицы. Процедуры принимают строку подключения к ClickHouse, текст запроса к Clickhouse и имя временной таблицы для сохранения результата. Различий между ними немного:<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>ExecuteToTempTable</b> - предназначен для работы с <b>локальными</b> временными таблицами, имена которых начинаются с #, а их жизненный цикл привязан к соединению, которое эту таблицу создало.</li><li><b>ExecuteToGlobalTempTable</b> - предназначен для работы с <b>глобальными</b> временными таблицами, имена которых начинаются с ##, а их жизненный цикл не привязан к соединениям. То есть таблицы могут использоваться разными соединениями. Также этот вариант процедуры принимает четвертый параметр со строкой подключения SQL Server. Если указать этот параметр, то для сохранения результата запроса во временную таблицу будут использования операции BULK INSERT на стороне SQL Server, что ускорит работу. Так реализоано, потому что контекстное подключение не позволяет выполнять BULK-операции. Можно передать пустую строку, тогда будет использованы обычные конструкции INSERT.</li></ul></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Вот листинг двух этих процедур.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-ikkVnJ sc-hldWLq gQzCG bAZrqo prism-code language-csharp" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// Выполнение запроса к ClickHouse с сохранением результата во временную локальную таблицу</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;/summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;connectionString&quot;&gt;Строка подключения к ClickHouse&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;queryText&quot;&gt;SQL-текст команды&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;tempTableName&quot;&gt;Имя временной таблицы для сохранения результата&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SqlProcedure</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteToTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> queryText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> tempTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> tempTableNameValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tempTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">!</span><span class="token plain">tempTableNameValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">StartsWith</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;#&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> StringComparison</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">InvariantCultureIgnoreCase</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">Exception</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Temp table name should begin with # (local temp table)&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tempTableNameValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">StartsWith</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;##&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> StringComparison</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">InvariantCultureIgnoreCase</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">Exception</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Temp table name should begin with # (local temp table). Global temp table with ## not supported by this method.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteToTempTableInternal</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> queryText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> tempTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _emptyString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// Выполнение запроса к ClickHouse с сохранением результата во временную глобальную таблицу</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;/summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;connectionString&quot;&gt;Строка подключения к ClickHouse&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;queryText&quot;&gt;SQL-текст команды&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;tempTableName&quot;&gt;Имя временной таблицы для сохранения результата&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;sqlServerConnectionString&quot;&gt;Строка подключения к SQL Server для выполнения BULK INSERT.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// Если передана пустая строка, то вставка во временную таблицу будет выполняться обычными инструкциями INSERT.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SqlProcedure</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteToGlobalTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> queryText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> tempTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> sqlServerConnectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> tempTableNameValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tempTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">!</span><span class="token plain">tempTableNameValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">StartsWith</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;##&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> StringComparison</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">InvariantCultureIgnoreCase</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">Exception</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Temp table name should begin with ## (global temp table).&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteToTempTableInternal</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> queryText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> tempTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sqlServerConnectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Как вы можете заметить, вся фактическая реализация метода находится в <b>ExecuteToTempTableInternal</b>. Листинг этого метода приводить здесь не будем, Вы можете посмотреть его <a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient.Entry/EntryClickHouseClient.cs#L25" target="_blank" rel="noopener noreferrer"><b><u>здесь</u></b></a>. Суть его в следующем:<ul class="List_list__zLjGi list-disc pl-[30px]"><li>Проверяем наличие временной таблицы.</li><li>Открываем подключение к ClickHouse и выполняем запрос с обработкой результата.</li><li>Если доступно использование BULK INSERT к SQL Server, то загружаем полученные записи из ClickHouse во временную таблицу таким образом. В противном случае выполняем команды INSERT для заполнения временной таблицы.</li></ul></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">После в скрипте T-SQL можно работать с полученными данными, выполняя запросы к этой временной таблице. Примеры работы будут представлены ниже.</p></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify"><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify"><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">И последняя хранимая процедура <b>ExecuteBulkInsertFromTempTable</b> для отправки данных из временной таблицы SQL Server в таблицу ClickHouse через BULK INSERT. Процедура принимает три параметра:<ul class="List_list__zLjGi list-disc pl-[30px]"><li>Строка подключения ClickHouse.</li><li>Имя временной таблицы SQL Server.</li><li>Имя таблицы ClickHouse для загрузки данных.</li></ul></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">В библиотеке <b>ClickHouse.Client</b> уже была реализация операции BULK INSERT в таблицу ClickHouse, ее мы и используем!</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-iPXUjb sc-hlweCQ dBERZB kWLGCG prism-code language-csharp" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// Операция массовой вставки данных из временной таблицы SQL Server</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// в таблицу ClickHouse</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;/summary&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;connectionString&quot;&gt;Строка подключения к ClickHouse&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;sourceTempTableName&quot;&gt;Имя временной таблицы с исходными данными&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/// &lt;param name=&quot;destinationTableName&quot;&gt;Имя таблицы ClickHouse для вставки данных&lt;/param&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SqlProcedure</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteBulkInsertFromTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> sourceTempTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlChars</span><span class="token plain"> destinationTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> connectionStringValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connectionString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> sourceTempTableNameValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sourceTempTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> destinationTableNameValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">destinationTableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlConnection</span><span class="token plain"> sqlConnection </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">GetSqlConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sqlConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">State </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> ConnectionState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            sqlConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token class-name" style="color:rgb(78, 201, 176)">List</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">object</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> rowsForInsert </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">List</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">object</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">string</span><span class="token plain"> tempTableSelectQuery </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">@&quot;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">SELECT * FROM &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> sourceTempTableNameValue </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">@&quot;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name" style="color:rgb(78, 201, 176)">SqlCommand</span><span class="token plain"> tempTableReader </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">SqlCommand</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tempTableSelectQuery</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sqlConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            tempTableReader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CommandType </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> CommandType</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> reader </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tempTableReader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">ExecuteReader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">object</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> rowValues </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(86, 156, 214)">object</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">FieldCount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">FieldCount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(212, 212, 212)">++</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> columnValue </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> reader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                        rowValues</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> columnValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                    rowsForInsert</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rowValues</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> connection </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">ClickHouseConnection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connectionStringValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token class-name keyword" style="color:rgb(86, 156, 214)">var</span><span class="token plain"> bulkCopy </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(78, 201, 176)">ClickHouseBulkCopy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">connection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                DestinationTableName </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> destinationTableNameValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                BatchSize </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                MaxDegreeOfParallelism </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                bulkCopy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">InitAsync</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetAwaiter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetResult</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                bulkCopy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">WriteToServerAsync</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rowsForInsert</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetAwaiter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetResult</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Весь смысл процедуры в простых шагах:<ul class="List_list__zLjGi list-disc pl-[30px]"><li>Считываем все записи из указанной временной таблицы.</li><li>Создаем коллекцию записей для отправки в ClickHouse.</li><li>Вызываем операцию BULK INSERT в ClickHouse.</li></ul></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">И всё!</p></p></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Все функции и процедуры готовы! Всё наше расширение SQLCLR готово к установке и использованию!</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Напомню, что исходный код рабочей версии расширения можно <a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-SQLCLR/Projects/ClickHouseClient/Libs/ClickHouseClient.Entry/EntryClickHouseClient.cs" target="_blank" rel="noopener noreferrer"><b><u>найти здесь</u></b></a>.</p></section><section id="section-setup-and-config"><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset" id="setup-and-config">Установка и настройка</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Библиотека готова, пора перейти к установке и настройке. В Visual Studio соберем проект в конфигурации <b>Release</b> и получим следующие необходимые файлы:<ul class="List_list__zLjGi list-disc pl-[30px]"><li>NodaTime.dll</li><li>Newtonsoft.Json.dll</li><li>ClickHouseClient.dll</li><li>ClickHouseClient.Entry.dll</li></ul>Все эти файлы скопируем в каталог, например: <b>&quot;C:\Share\SQLCLR&quot;</b>.<div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/.NET/2025-02/sqlserver-and-clickhouse-friendship/2. Файлы сборки расширения.png" alt="Файлы сборки расширения" width="100%" class="block"/></div></div></div></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Теперь нужно установить и настроить сборку. Ранее мы показывали скрипты по установке стандартных сборок .NET Framework. Теперь мы рассмотрим скрипт со всеми шагами установки, в том числе по созданию объектов функций и процедур, через которые будет вызов методов расширения SQLCLR.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Вот полный скрипт со всеми шагами установки и настройки расширения:<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-iQqcaB sc-fcSHUR laBxHU cjEGhb prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Этап 1. Включаем поддержку SQLCLR для инстанса SQL Server и доверие для базы данных.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXEC</span><span class="token plain"> sp_configure </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;clr enabled&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">RECONFIGURE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DATABASE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> TRUSTWORTHY </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Этап 2. Подготавливаем сертификаты Microsoft для сборок .NET Framework.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Этот шаг необходим для подключения стандартных сборок .NET</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- к инстансу SQL Server. Для добавленного сертификата создаем</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- служебную учетную запись и разрешаем работать со сборками.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">USE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">master</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> CERTIFICATE </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> EXECUTABLE </span><span class="token keyword" style="color:rgb(86, 156, 214)">FILE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\System.Net.Http.dll&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> LOGIN </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> CERTIFICATE </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GRANT</span><span class="token plain"> UNSAFE ASSEMBLY </span><span class="token keyword" style="color:rgb(86, 156, 214)">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DENY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">CONNECT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">SQL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> LOGIN </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">MS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NETcer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DISABLE</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Этап 3. Добавляем стандартные сборки .NET Framework в служебную базу.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Эти сборки необходимы для работы клиента ClickHouse.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">USE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> ASSEMBLY </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">System</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Http</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\System.Net.Http.dll&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> PERMISSION_SET </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> UNSAFE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> ASSEMBLY </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">System</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Web</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\System.Web.dll&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> PERMISSION_SET </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> UNSAFE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Этап 4. Удаляем объекты расширения SQLCLR клиента ClickHouse,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- если они уже существуют. Ниже они будут созданы заново.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">USE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">fn_CHExecuteScalar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">fn_CHExecuteSimple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">fn_CHGetCreateTempDbTableCommand</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteToTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteToGlobalTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteStatement</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteBulkInsertFromTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> ASSEMBLY </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> ASSEMBLY </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Этап 5. Создаем сборку клиента ClickHouse и расширения SQLCLR в служебной базе,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- а также все объекты для работы с ней.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- ВНИМАНИЕ!!! Путь к файлу DLL нужно актуализировать под ваше окружение.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">USE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> ASSEMBLY </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;C:\Share\SQLCLR\ClickHouseClient.dll&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> PERMISSION_SET </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> UNSAFE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> ASSEMBLY </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;C:\Share\SQLCLR\ClickHouseClient.Entry.dll&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> PERMISSION_SET </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> UNSAFE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">fn_CHExecuteScalar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@connectionString</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@queryText</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURNS</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> EXTERNAL NAME </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">YPermitin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EntryClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ExecuteScalar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">fn_CHExecuteSimple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@connectionString</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@queryText</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURNS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ResultValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">EXTERNAL NAME </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">YPermitin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EntryClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ExecuteSimple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">fn_CHGetCreateTempDbTableCommand</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@connectionString</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@queryText</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@tempTableName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">RETURNS</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> EXTERNAL NAME </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">YPermitin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EntryClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">GetCreateTempDbTableCommand</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">   </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteStatement</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@connectionString</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@queryText</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> EXTERNAL NAME </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">YPermitin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EntryClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ExecuteStatement</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteToTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@connectionString</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@queryText</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@tempTableName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> EXTERNAL NAME </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">YPermitin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EntryClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ExecuteToTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteToGlobalTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@connectionString</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@queryText</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@tempTableName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@sqlServerConnectionString</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> EXTERNAL NAME </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">YPermitin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EntryClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ExecuteToGlobalTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">PROCEDURE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteBulkInsertFromTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@connectionString</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@sourceTempTableName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token variable" style="color:rgb(156, 220, 254)">@destinationTableName</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> EXTERNAL NAME </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">YPermitin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EntryClickHouseClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ExecuteBulkInsertFromTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div></pre></div></div></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Скрипт работает в 5 этапов:<ul class="List_list__zLjGi list-disc pl-[30px]"><li>Включаем поддержку SQLCLR для инстанса SQL Server и доверие для базы данных.</li><li>Подготавливаем сертификаты Microsoft для сборок .NET Framework.</li><li>Добавляем стандартные сборки .NET Framework в служебную базу.</li><li>Удаляем объекты расширения SQLCLR клиента ClickHouse.</li><li>Создаем сборку клиента ClickHouse и расширения SQLCLR в служебной базе, а также все объекты для работы с ней.</li></ul></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Теперь мы можем работать с ClickHouse из T-SQL! Время пришло!</p></section><section id="section-queries"><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset" id="queries">Запросы, запросы, запросы</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Вот несколько примеров, где мы из T-SQL выполним несколько запросов к ClickHouse. Воспользуемся всеми методами, которые мы реализовали выше.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Получаем версию ClickHouse.<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jCWzJg sc-fvubMj dhtvMQ kkrocS prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">fn_CHExecuteScalar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Строка подключения</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Host=yy-comp;Port=8123;Username=default;password=;Database=default;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- текст запроса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;select version()&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Пример результата:</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- 25.2.1.2434</span></div></pre></div></div></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Пример выполнения простого запроса, который возвращает одну колонку. Для возврата нескольких колонок используется кортеж, сериализованный в JSON. В T-SQL полученные элементы JSON разбираются конструкциями SQL Server.<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jVxTAy sc-erPUmh hOqCoB CYFEB prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	JSON_VALUE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ResultValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;$.Item1&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">DatabaseName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	JSON_VALUE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ResultValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;$.Item2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">Engine</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	JSON_VALUE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ResultValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;$.Item3&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">DataPath</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">JSON_VALUE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ResultValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;$.Item4&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> uniqueidentifier</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">UUID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fn_CHExecuteSimple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Строка подключения</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Host=yy-comp;Port=8123;Username=default;password=;Database=default;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Запрос</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">SELECT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	tuple(name, engine, data_path,uuid)</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">FROM `system`.`databases`</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> d</span></div></pre></div></div></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Создаем временную таблицу и сохраняем в нее результат запроса.<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-iRTMaw sc-eKrodz gNKVzl cTdIwH prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">OBJECT_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;tempdb..#logs&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">IS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#logs;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#logs</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">EventTime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> datetime2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">Tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">QueryId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> uniqueidentifier</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteToTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Строка подключения</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Host=yy-comp;Port=8123;Username=default;password=;Database=default;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Текст запроса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">select</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	event_time,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	query,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	tables,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	query_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">from `system`.query_log</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">limit 1000</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя временной таблицы для сохранения результата</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;#logs&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Считываем результат</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#logs</span></div></pre></div></div></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Создаем ГЛОБАЛЬНУЮ временную таблицу и сохраняем в нее результат запроса.<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jkvfRO sc-eXVaYZ bOyzFB dQJAxX prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">OBJECT_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;tempdb..##logs&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">IS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">##logs;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">##logs</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">EventTime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> datetime2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token keyword" style="color:rgb(86, 156, 214)">Tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">QueryId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> uniqueidentifier</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteToGlobalTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Строка подключения</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Host=yy-comp;Port=8123;Username=default;password=;Database=default;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Текст запроса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">select</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	event_time,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	query,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	tables,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	query_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">from `system`.query_log</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">limit 1000</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя временной таблицы для сохранения результата</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;##logs&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Строка подключения к SQL Server для BULK INSERT.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Строка контекстного подключения для этого не подходит.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;server=localhost;database=master;trusted_connection=true&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Считываем результат</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">##logs</span></div></pre></div></div>При использовании глобальной таблицы можно достичь более высокой производительности за счет переноса в нее данных через BULK INSERT (если указана строка подключения к SQL Server).</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Запуск произвольной команды без возвращения результата.<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jxYSNo sc-zOxLx dWylOs bfuPVX prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteStatement</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Строка подключения</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Host=yy-comp;Port=8123;Username=default;password=;Database=default;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Запрос</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">CREATE TABLE IF NOT EXISTS SimpleTable</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">(</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	Id UInt64,</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	Period datetime DEFAULT now(),</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">	Name String</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">)</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">ENGINE = MergeTree</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">ORDER BY Id;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div></pre></div></div></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Выполнение операции BULK INSERT в таблицу ClickHouse. Отправляется набор данных из временной таблицы.<div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-cgHfjM sc-fpikKz dlcYZA dUEzsz prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> NOCOUNT </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Создаем временную таблицу</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">OBJECT_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;tempdb..#rowsForInsert&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">IS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#rowsForInsert;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#rowsForInsert</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">bigint</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Period</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> datetime2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Заполняем набор данных</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> x </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> n </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">7</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">9</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#rowsForInsert</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	ROW_NUMBER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">OVER</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	GETDATE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Value &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> CAST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ROW_NUMBER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">OVER</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> nvarchar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> x ones</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> x tens</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> x hundreds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> x thousands</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Отправляем в ClickHouse</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">PowerSQLCLR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_CHExecuteBulkInsertFromTempTable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Строка подключения</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Host=yy-comp;Port=8123;Username=default;password=;Database=default;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя временной таблицы с исходными данными</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;#rowsForInsert&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя таблицы в ClickHouse для BULK INSERT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;SimpleTable&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">&#x27;</span></div></pre></div></div></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Вот и все примеры! Дело сделано, пути назад нет <!-- -->:)</p></section><section id="section-thoughts"><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset" id="thoughts">Немного мыслей</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Это было длинное путешествие, спасибо что прошли его вместе со мной!</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Мы еще раз стали свидетелями мощи технологии SQLCLR. Несмотря на то, что сама технология уже перешла в статус legacy, т.к. больше не планируется её развития, но это не значит смерти SQLCLR. Ведь на его базе создано так много решений, что поддерживать его для совместимости в SQL Server будут еще многие десятилетия. Ломать - не строить! Microsoft будет беречь совместимость с этой технологией, а в будущем может и реализует ей замену в связке с современными версиями .NET (но это не точно).</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Дружба SQL Server + ClickHouse открывают большие возможности по интеграции двух СУБД и не только это! Мы можем открыть новые возможности использования SQL Server в приложениях, которые используют эту СУБД как основное хранилище данных. К этой теме мы еще вернемся в будущем.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">Оцените логотип новой СУБД в результате объединения функций SQL Server и ClickHouse <!-- -->:)))</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_xs__E5xhu display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/.NET/2025-02/sqlserver-and-clickhouse-friendship/3. SQL Server + ClickHosue.png" alt="SQL Server + ClickHouse" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:justify">А на сегодня интернета достаточно! Удачи в делах и до скорых встреч!</p></section><section id="section-link"><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset" id="link">Полезные ссылки</h1><ul class="List_list__zLjGi list-disc pl-[30px]"><li><a href="https://github.com/YPermitin/ClickHouseTools/tree/main/CH-Integration" target="_blank" rel="noopener noreferrer"><b><u>Интеграция</u></b> - интеграция ClickHouse с другими СУБД или информационными системами..</a></li><li><a href="https://github.com/YPermitin/ClickHouseTools" target="_blank" rel="noopener noreferrer"><b><u>ClickHouseTools</u></b> - инструменты обслуживания и разработки для Yandex ClickHouse, а также другие интересности.</a></li><li><a href="/blog/.NET/2024-09/simple-and-fast-sql-clr" target="_blank" rel="noopener noreferrer"><b><u>Расширение для SQL Server. Быстро и просто. SQLCLR снова в деле</u></b> - создание простого расширения SQLCLR на сквозном примере.</a></li></ul></section></article><div class="Seperator_section_seperator_line__gdWIB dark:border-white border-black"></div><div class="PageLayout_author_and_more__wxN3W mx-auto"><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><div class="flex items-center"><div class="flex items-center justify-center shadow-xl rounded-full overflow-hidden bg-blue-500 shrink-0 w-[60px] h-[60px] mr-3 text-xl"><p class="text-center font-medium text-white">Y</p></div><div class="font-semibold"><p class="text-[20px]  mb-0 mt-0">YPermitin</p><p class="text-xs mt-0 mb-0">.NET, TSQL, DevOps, 1C:Enterprise</p></div></div><p class="text-[16px] mt-2">Developer, just developer.</p><div class="flex items-center flex-wrap mt-3"><a href="https://github.com/YPermitin" target="_blank" class="mr-[15px] text-[32px]" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></div><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><p class="border-b border-gray-300 pb-2 mb-3 font-medium w-full">Поделиться</p><div class="flex flex-wrap items-center"><a class="mr-3" aria-label="facebook-share" href="https://www.facebook.com/sharer/sharer.php?u=https://ypermitin.github.io" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-92.4 233.5h-63.9c-50.1 0-59.8 23.8-59.8 58.8v77.1h119.6l-15.6 120.7h-104V912H539.2V602.2H434.9V481.4h104.3v-89c0-103.3 63.1-159.6 155.3-159.6 44.2 0 82.1 3.3 93.2 4.8v107.9z"></path></svg></a><a class="mr-3" aria-label="twitter-share" href="http://twitter.com/share?text=Check out this article!! &amp;url=https://ypermitin.github.io&amp;hashtags=webdevelopment,javacript,javascriptdaily,webdevelopmenttutorial,tutorial" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm215.3 337.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg></a><a class="mr-3" aria-label="linkedin-share" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ypermitin.github.io&amp;title=Check out this article!!&amp;source=LinkedIn" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[23px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"></path></svg></a><button class="mr-3" name="copy-link" aria-label="copy-link"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"></path></svg></button></div><div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed flex transition-all right-[10px] -bottom-20 opacity-0" role="alert"><strong class="font-bold">Link Copied</strong><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"></path></svg></span></div></div><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><p class="border-b border-gray-300 pb-2 mb-3 font-medium w-full">Другие статьи</p><div class="flex flex-wrap"><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/CPP/2025-07/cpp-path-to-gui/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/CPP/2025-07/cpp-path-to-gui/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Тернистый путь к графическому интерфейсу на C++"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Тернистый путь к графическому интерфейсу на C++</div></div></div><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/.NET/2025-02/sqlserver-and-clickhouse-friendship/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Дружба между SQL Server и ClickHouse. SQLCLR снова с нами"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Дружба между SQL Server и ClickHouse. SQLCLR снова с нами</div></div></div><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/.NET/2024-12/protect-dublicate-process/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/.NET/2024-12/protect-dublicate-process/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Контроль дубликатов процессов в C# (.NET)"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Контроль дубликатов процессов в C# (.NET)</div></div></div><a class="cursor-pointer hover:text-blue-500 block text-sm py-3 px-2 text-center dark:bg-slate-900 bg-blue-500 rounded text-white font-bold hover:!text-blue-900 dark:hover:!text-slate-400 transition-all" href="/blog/?author=YPermitin"><p>Все статьи от автора: <!-- -->YPermitin</p></a></div></div></div></div></section><div class="dark:bg-slate-900 dark:text-white bg-slate-100 text-black"><div class="md:container flex items-center md:justify-center justify-around flex-wrap md:text-[14px] text-[12px] py-5"><p class="my-0 mr-[10px] md:mr-3">Copyright © <!-- -->2025<!-- --> <!-- -->Убежище инженера</p></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/.NET/2025-02/sqlserver-and-clickhouse-friendship","query":{},"buildId":"-bGN1hEP2YVpKeQylWsrE","nextExport":true,"autoExport":true,"isFallback":false,"dynamicIds":[91274,28681,97897,7200,2726],"scriptLoader":[]}</script></body></html>