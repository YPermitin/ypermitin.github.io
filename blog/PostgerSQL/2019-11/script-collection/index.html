<!DOCTYPE html><html lang="en" translate="no"><head><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1"/><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="google" content="notranslate"/><title>Набор скриптов для знакомства с PostgreSQL | Убежище инженера | YPermitin</title><meta name="robots" content="index,follow"/><meta name="description" content="Немного скриптов для PostgreSQL, позволяющих познакомиться с состоянием сервера."/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://ypermitin.github.io/blog/PostgerSQL/2019-11/script-collection"/><meta property="og:title" content="Набор скриптов для знакомства с PostgreSQL | Убежище инженера | YPermitin"/><meta property="og:description" content="Немного скриптов для PostgreSQL, позволяющих познакомиться с состоянием сервера."/><meta property="og:url" content="https://ypermitin.github.io/blog/PostgerSQL/2019-11/script-collection"/><meta property="og:type" content="website"/><meta property="og:image" content="https://ypermitin.github.io/imp_assets/PostgreSQL/2019-11/script-collection/logo.png"/><meta property="og:image:alt" content="Набор скриптов для знакомства с PostgreSQL | Убежище инженера | YPermitin"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:locale" content="en_IN"/><meta property="og:site_name" content="Убежище инженера"/><link rel="canonical" href="https://webexpe.com/"/><meta property="keywords" content="PostgreSQL, скрипты"/><meta property="al:web:url" content="https://ypermitin.github.io/blog/PostgerSQL/2019-11/script-collection"/><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/3572aef5c92b999a.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/3572aef5c92b999a.css" crossorigin="" data-n-g=""/><link rel="preload" href="/_next/static/css/74d45923820614f0.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/74d45923820614f0.css" crossorigin=""/><link rel="preload" href="/_next/static/css/4a9df9e795bce52b.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/4a9df9e795bce52b.css" crossorigin=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script defer="" src="/_next/static/chunks/fea29d9f.ed258e6733dee3dc.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/3a17f596.ba96fa4a4d0542ad.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/1664-4a06aa529298108a.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/7167.f2f73d92f46b437d.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/1465.2204281cc9cfb98d.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/9179.149e20aab74a9c64.js" crossorigin=""></script><script src="/_next/static/chunks/webpack-a03c5492e9bbae29.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-92a422f151f77ddb.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-603010d06ef22166.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-09d943187c0df7b5.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/1102-e16f2e3f75ecbbbc.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/blog/PostgerSQL/2019-11/script-collection-34c5642d3890ca38.js" defer="" crossorigin=""></script><script src="/_next/static/w6SFBBOZSxxQOc3fUMUQB/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/w6SFBBOZSxxQOc3fUMUQB/_ssgManifest.js" defer="" crossorigin=""></script></head><body class="bg-slate-100 dark:bg-slate-900 transition-all"><div id="__next"><div data-overlay-container="true"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><nav class="Navbar_navbar__W_ouQ bg-white  dark:bg-slate-900 dark:text-white text-black"><div class="container flex items-center justify-between px-2"><div class="flex items-center"><div class="Navbar_mobileBurgerToggle__Bj_52 mr-5  "><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="dark:text-white text-black text-2xl" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></div><a class="text-[22px] font-semibold" href="/">Убежище инженера</a></div><div class="flex items-center"><div class="text-[14px] font-normal items-center lg:flex hidden"><a class="cursor-pointer hover:text-blue-500 mx-2" href="/">Главная</a><div class="relative"><div class="flex items-center cursor-pointer mx-2"><p class="my-0">Блог</p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-[20px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path></svg></div><div class="overflow-auto absolute w-[180px] z-20 top-[30px] rounded-[4px] shadow-lg bg-white dark:bg-slate-800 border border-gray-300 dark:border-0 h-0 border-0"><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2" href="/blog/"><span>Все публикации</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=.NET"><span style="text-transform:capitalize">.NET</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=PostgreSQL"><span style="text-transform:capitalize">PostgreSQL</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=DevOps"><span style="text-transform:capitalize">DevOps</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=SQL%20Server"><span style="text-transform:capitalize">SQL Server</span></a></div></div><a class="cursor-pointer hover:text-blue-500 mx-2" href="/instruments/">Инструменты</a><a class="cursor-pointer hover:text-blue-500 mx-2" href="/about/">Обо мне</a><a class="cursor-pointer hover:text-blue-500 mx-2" href="/contact/">Контакты</a><div class="ml-5 pt-1"><a href="https://github.com/YPermitin/" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><a href="https://t.me/TinyDevVault" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"></path></svg></a><a href="mailto:i.need.ypermitin@yandex.ru" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0 0 68.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg></a><a href="https://boosty.to/ypermitin" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 21h9.62a3.995 3.995 0 0 0 3.037-1.397l5.102-5.952a1 1 0 0 0-.442-1.6l-1.968-.656a3.043 3.043 0 0 0-2.823.503l-3.185 2.547-.617-1.235A3.98 3.98 0 0 0 9.146 11H4c-1.103 0-2 .897-2 2v6c0 1.103.897 2 2 2zm0-8h5.146c.763 0 1.448.423 1.789 1.105l.447.895H7v2h6.014a.996.996 0 0 0 .442-.11l.003-.001.004-.002h.003l.002-.001h.004l.001-.001c.009.003.003-.001.003-.001.01 0 .002-.001.002-.001h.001l.002-.001.003-.001.002-.001.002-.001.003-.001.002-.001c.003 0 .001-.001.002-.001l.003-.002.002-.001.002-.001.003-.001.002-.001h.001l.002-.001h.001l.002-.001.002-.001c.009-.001.003-.001.003-.001l.002-.001a.915.915 0 0 0 .11-.078l4.146-3.317c.262-.208.623-.273.94-.167l.557.186-4.133 4.823a2.029 2.029 0 0 1-1.52.688H4v-6zM16 2h-.017c-.163.002-1.006.039-1.983.705-.951-.648-1.774-.7-1.968-.704L12.002 2h-.004c-.801 0-1.555.313-2.119.878C9.313 3.445 9 4.198 9 5s.313 1.555.861 2.104l3.414 3.586a1.006 1.006 0 0 0 1.45-.001l3.396-3.568C18.688 6.555 19 5.802 19 5s-.313-1.555-.878-2.121A2.978 2.978 0 0 0 16.002 2H16zm1 3c0 .267-.104.518-.311.725L14 8.55l-2.707-2.843C11.104 5.518 11 5.267 11 5s.104-.518.294-.708A.977.977 0 0 1 11.979 4c.025.001.502.032 1.067.485.081.065.163.139.247.222l.707.707.707-.707c.084-.083.166-.157.247-.222.529-.425.976-.478 1.052-.484a.987.987 0 0 1 .701.292c.189.189.293.44.293.707z"></path></svg></a></div></div><div class="Navbar_search_icon_wrapper__1a_rL ml-5 dark:text-white"><button name="search-button" aria-label="search button"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="dark:text-white text-black text-[22px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></button></div><div class=""><button name="share" aria-label="share page"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="dark:text-white text-black text-[16px] mt-[7px] ml-2 mr-1" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5z"></path></svg></button></div><button name="theme-switch" aria-label="theme button" class="Navbar_theme_switch__q7F_Z pl-3 dark:text-white text-black"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-md " height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path></svg></button></div></div></nav><aside class="Navbar_nav_sidebar_wrapper__M0KaI dark:bg-slate-900 dark:text-white bg-white text-black"><div class="flex items-center justify-between pb-3"><p class="">МЕНЮ</p><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-slate-800 dark:text-white text-[25px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0V0z"></path><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg></div></div><hr/><div class="my-15"><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/">Главная</a><div class="relative"><div class="flex items-center cursor-pointer justify-between"><p class="my-0">Блог</p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-[20px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path></svg></div><div class="overflow-auto relative h-0 border-0"><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2" href="/blog/"><span>Все публикации</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=.NET"><span style="text-transform:capitalize">.NET</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=PostgreSQL"><span style="text-transform:capitalize">PostgreSQL</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=DevOps"><span style="text-transform:capitalize">DevOps</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=SQL%20Server"><span style="text-transform:capitalize">SQL Server</span></a></div></div><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/instruments/">Инструменты</a><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/about/">Обо мне</a><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/contact/">Контакты</a></div><hr/><div class="my-5"><p class="font-light">Подписаться : </p> <a href="https://github.com/YPermitin/" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><a href="https://t.me/TinyDevVault" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"></path></svg></a><a href="mailto:i.need.ypermitin@yandex.ru" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0 0 68.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg></a><a href="https://boosty.to/ypermitin" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 21h9.62a3.995 3.995 0 0 0 3.037-1.397l5.102-5.952a1 1 0 0 0-.442-1.6l-1.968-.656a3.043 3.043 0 0 0-2.823.503l-3.185 2.547-.617-1.235A3.98 3.98 0 0 0 9.146 11H4c-1.103 0-2 .897-2 2v6c0 1.103.897 2 2 2zm0-8h5.146c.763 0 1.448.423 1.789 1.105l.447.895H7v2h6.014a.996.996 0 0 0 .442-.11l.003-.001.004-.002h.003l.002-.001h.004l.001-.001c.009.003.003-.001.003-.001.01 0 .002-.001.002-.001h.001l.002-.001.003-.001.002-.001.002-.001.003-.001.002-.001c.003 0 .001-.001.002-.001l.003-.002.002-.001.002-.001.003-.001.002-.001h.001l.002-.001h.001l.002-.001.002-.001c.009-.001.003-.001.003-.001l.002-.001a.915.915 0 0 0 .11-.078l4.146-3.317c.262-.208.623-.273.94-.167l.557.186-4.133 4.823a2.029 2.029 0 0 1-1.52.688H4v-6zM16 2h-.017c-.163.002-1.006.039-1.983.705-.951-.648-1.774-.7-1.968-.704L12.002 2h-.004c-.801 0-1.555.313-2.119.878C9.313 3.445 9 4.198 9 5s.313 1.555.861 2.104l3.414 3.586a1.006 1.006 0 0 0 1.45-.001l3.396-3.568C18.688 6.555 19 5.802 19 5s-.313-1.555-.878-2.121A2.978 2.978 0 0 0 16.002 2H16zm1 3c0 .267-.104.518-.311.725L14 8.55l-2.707-2.843C11.104 5.518 11 5.267 11 5s.104-.518.294-.708A.977.977 0 0 1 11.979 4c.025.001.502.032 1.067.485.081.065.163.139.247.222l.707.707.707-.707c.084-.083.166-.157.247-.222.529-.425.976-.478 1.052-.484a.987.987 0 0 1 .701.292c.189.189.293.44.293.707z"></path></svg></a><hr class="mt-5"/></div><div class="mt-5 mb-4"><p class="mb-2 font-light">Переключиться на <!-- -->светлую<!-- --> тему :</p><button name="theme-switch" aria-label="theme-switch" class="Navbar_theme_switch__q7F_Z dark:text-white text-black"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-lg" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path></svg></button></div><hr/><div class="my-5"><p class="text-sm font-light dark:text-gray-400 text-gray-500 mb-1">Copyright © 2024</p></div></aside><div class="transition-all fixed h-screen w-screen flex items-center justify-center left-0 z-20 top-0 pointer-events-none opacity-0"><div class="absolute top-0 left-0 w-screen h-screen bg-black opacity-50"></div><div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded lg:w-1/6 mx-3 w-full relative z-10 transition-all top-10"><div class="flex border-gray-300 pb-2 mb-3 border-b"><p class="  font-medium w-full">Share:</p><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"></path></svg></span></div><div class="flex flex-wrap items-center"><a class="mr-3" aria-label="facebook-share" href="https://www.facebook.com/sharer/sharer.php?u=https://ypermitin.github.io" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-92.4 233.5h-63.9c-50.1 0-59.8 23.8-59.8 58.8v77.1h119.6l-15.6 120.7h-104V912H539.2V602.2H434.9V481.4h104.3v-89c0-103.3 63.1-159.6 155.3-159.6 44.2 0 82.1 3.3 93.2 4.8v107.9z"></path></svg></a><a class="mr-3" aria-label="twitter-share" href="http://twitter.com/share?text=Check out this article!! &amp;url=https://ypermitin.github.io&amp;hashtags=webdevelopment,javacript,javascriptdaily,webdevelopmenttutorial,tutorial" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm215.3 337.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg></a><a class="mr-3" aria-label="linkedin-share" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ypermitin.github.io&amp;title=Check out this article!!&amp;source=LinkedIn" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[23px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><button class="mr-3" name="copy-link" aria-label="copy-link"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg></button></div><div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed flex transition-all right-[10px] -bottom-20 opacity-0" role="alert"><strong class="font-bold">Link Copied</strong><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"></path></svg></span></div></div></div><section class="PageLayout_centered_article_wrapper__gS3Af dark:bg-slate-900 dark:text-white"><div class="container px-0 md:px-[15px] pt-[50px] pb-[50px]"><article class="PageLayout_article_content__4dnq3 pb-[30px] px-3 bg-white dark:bg-slate-800 dark:border-none dark:drop-shadow-lg dark:text-white pt-10 md:pt-0 mx-auto font-regular text-lg leading-relaxed"><div class="mb-[30px]"><h1 class="ArticleHeader_articleTitle__3L1Bi text-center text-2xl md:text-4xl font-medium mt-[20px] mb-[5px]">Набор скриптов для знакомства с PostgreSQL</h1><div class="mb-[10px] mt-[15px] text-[14px] font-medium ArticleHeader_centered_article_header_author___gRtE"><p class="my-0 mx-[30px] font-medium">YPermitin<span class="px-1 font-light">в</span><a href="/blog/?category=PostgreSQL">PostgreSQL</a></p><p class="my-0">2019-11-04</p></div><div class="md:mt-2 flex flex-wrap justify-center"><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->PostgreSQL</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->скрипты</p></div></div><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Снова за свое</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Сегодня мы соберем базовый набор скрипто для общего ознакомления с состоянием сервера PostgreSQL. Информация будет полезна для администраторов и разработчиков, имеющих дело с хайповой СУБД, а также всем энтузиастам, желающих “пощупать” PostgreSQL.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Здесь Вы не найдете продвинутых скриптов, ведь это лишь для знакомство с новым серверов PostgreSQL. Но обо всем далее.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Это не руководство</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Данный материал не является полным руководством, и уж тем более не охватывает все вопросы администрирования СУБД, мониторинга производительности и диагностики. Это лишь начальный набор скриптов, с помощью которого Вы сможете ознакомиться что вообще творится на Вашем сервере баз данных и определить дальнейшие шаги.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Все скрипты можно запускать с помощью терминального клиента psql, с помощью графической утилиты pgAdmin или же с помощью другого графического инструмента Azure Data Studio (поддержка PostgreSQL реализовано через расширение, не забудьте его установить). Это прямо “золотой век” инструментария для работы с базами данных!</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Начнем с простых скриптов и постепенно перейдем к некоторым вопросам производительности.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Поехали!</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Перейдем уже непосредственно к скриптам. Все они были проверены на PostgreSQL версии 10, но абсолютное большинство скриптов можно запускать и на более ранних версиях.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Первое знакомство</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Как только Вы запустили свое клиентское приложение, то в первую очередь стоило бы узнать следующую информацию</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Базовая информация о сервере</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Под базовой информацией понимается адрес и порт сервера, версия установленной СУБД PostgreSQL, а также текущее имя базы.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jIYCZY sc-bbxCgr jxqnqb gHfHHM prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	inet_server_addr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Server&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	inet_server_port</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Port&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	current_database</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;CurrentDatabase&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	version</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Version&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Скорее всего, большинство этих параметров Вам уже известны еще до подключения. Разве что версия СУБД может оставлять вопросы.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Время работы с момента запуска</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Иногда может быть полезным узнать, когда последний раз была перезапущена служба PostgreSQL.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jPQKUW sc-hnmNqB jFcQYH ezODkA prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	pg_postmaster_start_time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> StartTime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	date_trunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;second&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">current_timestamp</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> pg_postmaster_start_time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> SecondsRunning</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	date_trunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;second&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">current_timestamp</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> pg_postmaster_start_time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">86400</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> DaysRunning</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Скрипт показывает время с момента старта службы в секундах и днях.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Количество активных соединений</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Работа PostgreSQL построена таким образом, что каждое соединение порождает серверный процесс “postgres” на стороне сервера, именно поэтому количество и список соединений может стать очень важной информацией, для получения представления о нагрузке, интенсивности работы с базой и настроек самой СУБД для оптимальной работы. И по этой же причине для оптимальной работы с PG нужен пул соединений, который и использует платформа 1С.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-eMkmGk sc-bSstmL dvQMRn iFqYLV prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"> pid </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> process_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">       usename </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> username</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">       datname </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> database_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">       client_addr </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> client_address</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">       application_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">       backend_start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">       state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">       state_change</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> pg_stat_activity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Часто имеет смысл собирать количество соединений на постоянной основе с помощью систем мониторинга.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Просмотр конфигурации сервера</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Большое количество параметров сервера PostgreSQL задается в файле postgresql.conf, поэтому обязательно следует рассмотреть настройки этого файла. Однако, это не обязательно делать с помощью редактора VI и перезапускать весь сервер, чтобы из этого редактора выйти <!-- -->:)</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Можно выполнить такой запрос.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-kGLCbq sc-hNDLBw gGUWHN ikcUiF prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> pg_settings</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Здесь Вы можете поставить отбор по интересуемым Вас параметрам</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">--where name like &#x27;%log%&#x27;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Подробную информацию Вы <b><u><a href="https://www.postgresql.org/docs/current/runtime-config.html" target="_blank" rel="noopener noreferrer">можете узнать здесь.</a></u></b></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Общую информацию мы получили, пойдемте дальше.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">О базах данных</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Следующее, что следует изучить - это список баз данных и их размер.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Список баз</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Получим список баз и некоторые их параметры (владелец, кодировка и кое-что другое).</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-drMgrp sc-cZpZpK yNIPH bMTMBq prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    inet_server_addr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Server&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">datname </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    pg_catalog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pg_get_userbyid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">datdba</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Owner&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    pg_catalog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pg_encoding_to_char</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">encoding</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Encoding&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">datcollate </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Collate&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">datctype </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Ctype&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    pg_catalog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">array_to_string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">datacl</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> E</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span></div><div class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Access privileges&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_catalog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pg_database d</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь мы знаем какие базы у нас есть на сервере.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Не думаю, что эта информация может быть полезна сама по себе. Теперь узнаем размер всех баз.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Размер всех баз</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Скрипт позволяет узнать какие базы у нас самые большие по размеру.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-jSUdEz sc-jPpdYo fuJquS bPeccu prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">datname </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> db_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">       pg_size_pretty</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pg_database_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">datname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> db_size</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> pg_database t1</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">order</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">by</span><span class="token plain"> pg_database_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">datname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">desc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Чем больше база, тем больше к ней вопросов.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">На следующем шаге уже может потребоваться посмотреть почему эта база такая большая.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Размер таблиц</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Следующим скриптом Вы можете узнать какие именно таблицы больше всего используют места, где очень “пухлые” индексы и большое количество записей.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-ftxyOh sc-fbbrMC hTMLMx zvjpc prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	tablename </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> table_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	pg_class</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">reltuples </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">rows</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	pg_total_relation_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">schemaname</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token plain">tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> reservedKB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	pg_table_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">schemaname</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token plain">tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> dataKB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	pg_indexes_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">schemaname</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token plain">tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> index_sizeKB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	pg_total_relation_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">schemaname</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token plain">tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> pg_table_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">schemaname</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token plain">tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> pg_indexes_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">schemaname</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token plain">tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> unusedKB</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_catalog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pg_tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> pg_catalog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pg_class</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">where</span><span class="token plain"> pg_tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tablename </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pg_class</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token operator" style="color:rgb(212, 212, 212)">and</span><span class="token plain"> schemaname </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;public&#x27;</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> pg_total_relation_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">schemaname</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;.&#x27;</span><span class="token operator" style="color:rgb(212, 212, 212)">||</span><span class="token plain">tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Гиганты на сервере найдены, причины их размера почти понятны. Двигаемся дальше, рассмотрим, как у нас обстоят дела с индексами.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">И снова индексы</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Индексы являются одними из самых важных объектов любой базы данных, обеспечивающих производительность запросов и клиентских приложений для базы (в нашем случае это платформы 1С). Узнаем список индексов, который у нас есть.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Список индексов</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В скрипте нет ничего необычного, просто список индексов и команда для их создания.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-FjMCv sc-guhxjM jgbeTB bTmxCH prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя индекса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    indexname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Команда создания индекса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    indexdef</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя схемы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	schemaname</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    pg_indexes</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    indexname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также можно получить список индексов, в котором будет список полей, которые в них входят.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-bYpRZF sc-eFyDpN hnVBdc gMmwRO prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> table_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя индекса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> index_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Список колонок</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    string_agg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">attname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;,&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> column_name</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    pg_class t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    pg_class i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    pg_index ix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    pg_attribute a</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">where</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">oid </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indrelid</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">and</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">oid </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indexrelid</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">and</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">attrelid </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">oid</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">and</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">attnum </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ANY</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indkey</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">and</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relkind </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;r&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">and</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname </span><span class="token operator" style="color:rgb(212, 212, 212)">not</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">like</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;pg_%&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">group</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">by</span><span class="token plain">  </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">order</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">by</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь копнем глубже. Список индексов - это хорошо, но нам нужно больше. Индексы нужны, но они могут и быть избыточными. Получим статистику использования индексов.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Статистика использования индексов</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">С помощью предложенного скрипта можно получить информацию о таблицах и их индексах, их размер, а также количество операций сканирования, чтений и количество “живых” строк, прочитанных из индекса.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-crHHJw sc-dEFUer cqhMBR ApFmH prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    pt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tablename </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> TableName</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indexname </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> IndexName</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">pc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">reltuples </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> TotalRows</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">pg_size_pretty</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pg_relation_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">quote_ident</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::</span><span class="token keyword" style="color:rgb(86, 156, 214)">text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> TableSize</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">pg_size_pretty</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pg_relation_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">quote_ident</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indexrelname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::</span><span class="token keyword" style="color:rgb(86, 156, 214)">text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> IndexSize</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">idx_scan </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> TotalNumberOfScan</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">idx_tup_read </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> TotalTupleRead</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">idx_tup_fetch </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> TotalTupleFetched</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_tables </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> pt</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">OUTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> pg_class </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> pc </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> pt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tablename</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">pc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">OUTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		pc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> TableName</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">pc2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> IndexName</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">psai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">idx_scan</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">psai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">idx_tup_read</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">psai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">idx_tup_fetch</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">psai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indexrelname </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_index </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> pi</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> pg_class </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> pc </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> pc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">oid </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pi</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indrelid</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> pg_class </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> pc2 </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> pc2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">oid </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pi</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indexrelid</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> pg_stat_all_indexes </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> psai </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">		</span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> pi</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indexrelid </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> psai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indexrelid </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> T</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> pt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tablename </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">TableName</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> pt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schemaname</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;public&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь мы точно знаем, если, конечно, статистика собрана качественная, какие индексы и как используются. Под “живыми” строками подразумеваются те записи, которые фактически и являются актуальными данными таблицы. “Мертвые” строки - это старые версии записей, которые уже либо заменены более новыми версиями данных, либо удалены из таблицы. На то PostgreSQL и “версионник”, что создает более новые версии данных, а старые версии должны быть подвергнуты очистке с помощью VACUUM.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Рекомендую периодически следить за использованием индексов, ведь избыточные индексы - это не меньшая проблема, чем недостающие индексы.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Попробуем определить недостающие индексы.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Таблица с отсутствующими индексами</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">К сожалению, PostgreSQL не предоставляет таких эффективных инструментов для поиска недостающих индексов, как это есть в SQL Server. Но с помощью статистики использования таблиц, мы можем определить для каких таблиц индексов явно не хватает за счет количества операций сканирования.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-bqOYya sc-gHjVMF fTrwAU cWRaCm prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  relname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  seq_scan </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> idx_scan </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> too_much_seq</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      seq_scan </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">coalesce</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">idx_scan</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Missing Index?&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;OK&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  pg_relation_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">relname::regclass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> rel_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> seq_scan</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> idx_scan</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  pg_stat_all_tables</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  schemaname </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;public&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> pg_relation_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">relname::regclass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">80000</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  too_much_seq </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Далее нужно анализировать запросы к таблице и планы их выполнения, которые нужно собирать отдельно. Это выходит за рамки публикации, но может быть мы вернемся к этой теме в будущем.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также стоит держать под контролем показатели фрагментации индексов, или bloat (“раздутия”) как это обычно еще называют в PostgreSQL.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Информация о фрагментации (раздутии) индексов</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">По результатам скрипта можно судить корректно ли настроено обслуживание, выполняется ли операция VACUUM, эффективно ли обслуживания.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-ettago sc-fGrmBj bFVJWx deKpro prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- https://wiki.postgresql.org/wiki/Show_database_bloat</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  current_database</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> schemaname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">/*reltuples::bigint, relpages::bigint, otta,*/</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">ROUND</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> otta</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> sml</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relpages::</span><span class="token keyword" style="color:rgb(86, 156, 214)">FLOAT</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">otta </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::</span><span class="token keyword" style="color:rgb(86, 156, 214)">NUMERIC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> tbloat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> relpages </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> otta </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> bs</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sml</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relpages</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">otta</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::</span><span class="token keyword" style="color:rgb(86, 156, 214)">BIGINT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> wastedbytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  iname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">/*ituples::bigint, ipages::bigint, iotta,*/</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">ROUND</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> iotta</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">OR</span><span class="token plain"> ipages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> ipages::</span><span class="token keyword" style="color:rgb(86, 156, 214)">FLOAT</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">iotta </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::</span><span class="token keyword" style="color:rgb(86, 156, 214)">NUMERIC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> ibloat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> ipages </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> iotta </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> bs</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ipages</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">iotta</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> wastedibytes</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    schemaname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> cc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">reltuples</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> cc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relpages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> bs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    CEIL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">cc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">reltuples</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">datahdr</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">ma</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> datahdr</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">ma</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> ma </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> datahdr</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">ma </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">nullhdr2</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">bs</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">20</span><span class="token plain">::</span><span class="token keyword" style="color:rgb(86, 156, 214)">FLOAT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> otta</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">COALESCE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;?&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> iname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">COALESCE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">reltuples</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> ituples</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">COALESCE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relpages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> ipages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">COALESCE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CEIL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">reltuples</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">datahdr</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">12</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">bs</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">20</span><span class="token plain">::</span><span class="token keyword" style="color:rgb(86, 156, 214)">FLOAT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> iotta </span><span class="token comment" style="color:rgb(106, 153, 85)">-- very rough approximation, assumes all cols</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      ma</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">bs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">schemaname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">datawidth</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">hdr</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">ma</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> hdr</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">ma</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> ma </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> hdr</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">ma </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::</span><span class="token keyword" style="color:rgb(86, 156, 214)">NUMERIC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> datahdr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">maxfracsum</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">nullhdr</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">ma</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> nullhdr</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">ma</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> ma </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> nullhdr</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">ma </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> nullhdr2</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        schemaname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> tablename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> hdr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ma</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> bs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token function" style="color:rgb(220, 220, 170)">SUM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">null_frac</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">avg_width</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> datawidth</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token function" style="color:rgb(220, 220, 170)">MAX</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">null_frac</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> maxfracsum</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        hdr</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token function" style="color:rgb(220, 220, 170)">COUNT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_stats s2</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> null_frac</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;&gt;</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> s2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schemaname </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schemaname </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> s2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tablename </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tablename</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> nullhdr</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_stats s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> current_setting</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;block_size&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::</span><span class="token keyword" style="color:rgb(86, 156, 214)">NUMERIC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> bs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> SUBSTRING</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">12</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;8.0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;8.1&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;8.2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">27</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">23</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> hdr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token keyword" style="color:rgb(86, 156, 214)">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHEN</span><span class="token plain"> v </span><span class="token operator" style="color:rgb(212, 212, 212)">~</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;mingw32&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">THEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ELSE</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">END</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> ma</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> version</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> foo</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> constants</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> foo</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> rs</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> pg_class cc </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> cc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relname </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> rs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tablename</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> pg_namespace nn </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> cc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">relnamespace </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">oid </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> nn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nspname </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> rs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">schemaname </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> nn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nspname </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;information_schema&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> pg_index i </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> indrelid </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">oid</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> pg_class c2 </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> c2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">oid </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indexrelid</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> sml</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> wastedbytes </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">На этом с индексами пока все. Давайте посмотрим на статистику.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Статистика в порядке?</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Статистика является одним из самых важных показателей, который использует планировщик для построения эффективных планов запросов. Если статистика устареет, то запросы могут быть выполнены самым неоптимальным образом. В итоге вся информационная система может столкнуться с деградацией производительности.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Информация о статистике</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">С помощью этого скрипта можно получить информацию о таблицах в части количества измененных строк с момента последнего обновления статистики, а также запуска последних операций обслуживания.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-dsAqUS sc-dmcoYd kCXICA cjdwPO prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Идентификатор таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;relid&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя схемы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;schemaname&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя таблицы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;relname&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Оценочное число строк, изменённых в этой таблице, с момента последнего сбора статистики</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;n_mod_since_analyze&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;row_mod&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Время последней очистки этой таблицы вручную (VACUUM FULL не учитывается)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;last_vacuum&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Время последней очистки таблицы фоновым процессом автоочистки</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;last_autovacuum&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Время последнего выполнения сбора статистики для этой таблицы вручную</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;last_analyze&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Время последнего выполнения сбора статистики для этой таблицы фоновым процессом автоочистки</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;last_autoanalyze&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Сколько раз очистка этой таблицы была выполнена вручную (VACUUM FULL не учитывается)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vacuum_count&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Сколько раз очистка этой таблицы была выполнена фоновым процессом автоочистки</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;autovacuum_count&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">	</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Сколько раз сбор статистики для этой таблицы был выполнен вручную</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;analyze_count&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Сколько раз сбор статистики для этой таблицы был выполнен фоновым процессом автоочистки</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;autoanalyze_count&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_stat_all_tables</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Так Вы можете проверить эффективность работы VACUUM, а также обновление статистики с помощью опции ANALYZE. Правильная настройка VACUUM - залог эффективной работы СУБД. Вот пример запуска очистки и обновления статистики одним подходом.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-YltrM sc-imiRDh bdHabb dA-DYuN prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> Подробнее: https:</span><span class="token comment" style="color:rgb(106, 153, 85)">//postgrespro.ru/docs/postgrespro/9.5/sql-vacuum</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- VACUUM высвобождает пространство, занимаемое «мёртвыми» кортежами. При обычных операциях Postgres Pro кортежи, </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- удалённые или устаревшие в результате обновления, физически не удаляются из таблицы; они сохраняются в ней, </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- пока не будет выполнена команда VACUUM. </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- VERBOSE - выводит подробный отчет о результатах работы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- ANALYZE - обновляет статистику для оптимальной работы планировщика (эффективного построения планов запросов)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">VACUUM </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">VERBOSE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ANALYZE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Обслуживание в этой публикации мы не затрагиваем, это отдельная история.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь давайте поговорим о производительности.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Производительность</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Тема производительности достаточно сложная и творческая, т.к. сильно зависит от инфраструктуры, настроек PostgreSQL, особенностей информационной системы и еще много чего. Нужен уникальный подход в сопровождении и качественный мониторинг. Сейчас же мы просто рассмотрим несколько скриптов, которые могут помочь в самом начале.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Активные запросы</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Скрипт покажет все активные запросы на сервере.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-vIyEI sc-bjUHJT idfQOb bRHlmp prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Текст активного запроса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;query&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;query&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Идентификатор пользователя</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;usesysid&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя пользователя</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;usename&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user_name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Идентификатор базы</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;datid&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;db_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя базы данных</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;datname&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;db_name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Начало выполнения запроса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;query_start&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;query_start&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">	</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Идентификатор серверного процесса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;pid&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;db_name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Информация о клиенте</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;client_addr&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;client_address&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;client_hostname&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;client_hostname&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">	</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;client_port&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;client_port&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Время начала транзакции</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;xact_start&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;xact_start&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Тип события, которого ждет процесс</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;wait_event_type&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;wait_event_type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Имя ожидаемого события</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;wait_event&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;wait_event&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">-- Общее текущее состояние этого серверного процесса.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token comment" style="color:rgb(106, 153, 85)">/*</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">	active: серверный процесс выполняет запрос.</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">	idle: серверный процесс ожидает новой команды от клиента.</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">	idle in transaction: серверный процесс находится внутри транзакции, но в настоящее время не выполняет никакой запрос.</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">	idle in transaction (aborted): Это состояние подобно idle in transaction, за исключением того, </span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">		что один из операторов в транзакции вызывал ошибку.</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">	fastpath function call: серверный процесс выполняет fast-path функцию.</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">	disabled: Это состояние отображается для серверных процессов, у которых параметр track_activities отключён.</span></div><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">	*/</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;state&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;state&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_stat_activity</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;state&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;active&#x27;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Ну а что дальше делать с этими запросами зависит от ситуации.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Теперь мы можем получить план запроса.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Получение плана запроса</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">PostgreSQL может кэшировать планы запросов в рамках серверных процессов, но это не является поведением по умолчанию. Поэтому, в отличии от SQL Server, мы не сможем получить кэш плана запроса из какого-либо буффера. Вместо этого нам нужно запросить у сервера план явно и он его сгенерирует заново. Вот как это можно сделать.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-eIPYkq sc-hBgdUx csAWAS eNojhK prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Анализ плана запроса, который использует планировщик</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXPLAIN</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Текст запроса для анализа</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_stat_activity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Анализ плана запроса с фактическим выполнением для более точной оценки</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ANALYZE</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Текст запроса для анализа</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">	</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_stat_activity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">EXPLAIN поможет получить план запроса. Если использовать опцию “ANALYZE”, то мы получим более подробную информацию о запросе, в том числе количество строк и время выполнение. Это достигается за счет фактического выполнения запроса. Без этого параметра будет формироваться предварительный план, который во многих случаях также может быть полезен для анализа.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также можно настроить сбор планов выполняемых запросов, но это уже другая история.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Может быть полезным получить информацию о выполняемых транзакциях.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Информация о транзакциях</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Первым делом можно получить длительные транзакции в разрезе клиентский машин и пользователей.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-labuuU sc-yRUbj fzOPmr kWViyY prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    client_addr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    usename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    datname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    clock_timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> xact_start </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> xact_age</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    clock_timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> query_start </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> query_age</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    query </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> pg_stat_activity </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">order</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">by</span><span class="token plain"> xact_start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> query_start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также можно найти “плохие” транзакции, которые ожидают чего-то (снятие блокировки или других ресурсов) или отменены по каким-либо причинам.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-dXNkBG sc-jFREAR gyxKGx eTgnpq prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> pg_stat_activity </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">where</span><span class="token plain"> state </span><span class="token operator" style="color:rgb(212, 212, 212)">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;idle in transaction&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;idle in transaction (aborted)&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Обычно эти скрипты используются в аварийные моменты, когда есть жалобы на работу системы, т.к получать эту информацию в системе в моменты простоя (ночью, например или выходные) нет особого смысла.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Можно проверить эффективность работы кэша.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Использование кэша</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Аналогично SQL Server, можно отслеживать параметр эффективности работы с кэшем.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-bPrlCs sc-fYrVWQ dehAzd jwXwHL prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">sum</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">blks_hit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token function" style="color:rgb(220, 220, 170)">sum</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">blks_hit</span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain">blks_read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> hit_ratio </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> pg_stat_database</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Если значение выше 90%, то СУБД может эффективно использовать память для оптимизации своей работы.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И под конец попробуем получить длительные запросы.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Длительные запросы</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Можно получить информацию о текущих запросах. которые выполняются больше какого-то времени.</p><div class="bg-blue-500 md:p-1 p-2 my-5"><div class="shadow-lg"><pre class="sc-GkLId sc-jYnQyy ffSVpQ rnvQW prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- Запросы, выполняющиеся более 1 минуты</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">now</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> query_start </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;runtime&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    usename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    datname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    waiting</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    query </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> pg_stat_activity </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">now</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> query_start </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;1 minutes&#x27;</span><span class="token plain">::</span><span class="token keyword" style="color:rgb(86, 156, 214)">interval</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">--WHERE now() - query_start &gt; &#x27;60 seconds&#x27;::interval </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> runtime </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В примере это запросы, выполняющиеся более 1 минуты. К сожалению, скрипт не может предоставить полноценную картину. Только сбор и анализ запросов в рамках мониторинга ответит на все вопросы по проблемам производительности.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Вот и все, со скриптами пока все.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Любите ли Вы PostgreSQL?</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Никаких готовых рецептов в статье нет, также как и нет информации о настройке операционной системы для оптимальной работы СУБД (не важно Windows это или *.nix) или настройке мониторинга. Лишь скрипты для получения общей информации.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Однако, теперь у Вас может появиться интерес и направление для изучения этой популярной и эффективной СУБД.</p></article><div class="Seperator_section_seperator_line__gdWIB dark:border-white border-black"></div><div class="PageLayout_author_and_more__wxN3W mx-auto"><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><div class="flex items-center"><div class="flex items-center justify-center shadow-xl rounded-full overflow-hidden bg-blue-500 shrink-0 w-[60px] h-[60px] mr-3 text-xl"><p class="text-center font-medium text-white">Y</p></div><div class="font-semibold"><p class="text-[20px]  mb-0 mt-0">YPermitin</p><p class="text-xs mt-0 mb-0">.NET, TSQL, DevOps, 1C:Enterprise</p></div></div><p class="text-[16px] mt-2">Developer, just developer.</p><div class="flex items-center flex-wrap mt-3"><a href="https://github.com/YPermitin" target="_blank" class="mr-[15px] text-[32px]" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></div><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><p class="border-b border-gray-300 pb-2 mb-3 font-medium w-full">Поделиться</p><div class="flex flex-wrap items-center"><a class="mr-3" aria-label="facebook-share" href="https://www.facebook.com/sharer/sharer.php?u=https://ypermitin.github.io" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-92.4 233.5h-63.9c-50.1 0-59.8 23.8-59.8 58.8v77.1h119.6l-15.6 120.7h-104V912H539.2V602.2H434.9V481.4h104.3v-89c0-103.3 63.1-159.6 155.3-159.6 44.2 0 82.1 3.3 93.2 4.8v107.9z"></path></svg></a><a class="mr-3" aria-label="twitter-share" href="http://twitter.com/share?text=Check out this article!! &amp;url=https://ypermitin.github.io&amp;hashtags=webdevelopment,javacript,javascriptdaily,webdevelopmenttutorial,tutorial" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm215.3 337.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg></a><a class="mr-3" aria-label="linkedin-share" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ypermitin.github.io&amp;title=Check out this article!!&amp;source=LinkedIn" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[23px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><button class="mr-3" name="copy-link" aria-label="copy-link"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg></button></div><div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed flex transition-all right-[10px] -bottom-20 opacity-0" role="alert"><strong class="font-bold">Link Copied</strong><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"></path></svg></span></div></div><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><p class="border-b border-gray-300 pb-2 mb-3 font-medium w-full">Другие статьи</p><div class="flex flex-wrap"><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/.NET/2024-06/detect-devices-with-charp/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/.NET/2024-06/detect-devices-with-charp/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Поиск устройств в сети с .NET (C#)"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Поиск устройств в сети с .NET (C#)</div></div></div><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/.NET/2024-05/game-trainer-on-csharp-or-cpp/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/.NET/2024-05/game-trainer-on-csharp-or-cpp/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Управляем игровым миром с помощью C++ / C#"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Управляем игровым миром с помощью C++ / C#</div></div></div><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/blog/.NET/2024-03/deploy-asp-net-core-on-linux/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/.NET/2024-03/deploy-asp-net-core-on-linux/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Развертывание ASP.NET Core приложений на Ubuntu Linux"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Развертывание ASP.NET Core приложений на Ubuntu Linux</div></div></div><a class="cursor-pointer hover:text-blue-500 block text-sm py-3 px-2 text-center dark:bg-slate-900 bg-blue-500 rounded text-white font-bold hover:!text-blue-900 dark:hover:!text-slate-400 transition-all" href="/blog/?author=YPermitin"><p>Все статьи от автора: <!-- -->YPermitin</p></a></div></div></div></div></section><div class="dark:bg-slate-900 dark:text-white bg-slate-100 text-black"><div class="md:container flex items-center md:justify-center justify-around flex-wrap md:text-[14px] text-[12px] py-5"><p class="my-0 mr-[10px] md:mr-3">Copyright © <!-- -->2024<!-- --> <!-- -->Убежище инженера</p></div></div></div></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{}},"page":"/blog/PostgerSQL/2019-11/script-collection","query":{},"buildId":"w6SFBBOZSxxQOc3fUMUQB","nextExport":true,"autoExport":true,"isFallback":false,"dynamicIds":[7167,1465,9179],"scriptLoader":[]}</script></body></html>