<!DOCTYPE html><html lang="en" translate="no"><head><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1"/><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="google" content="notranslate"/><title>Базы данных. Несколько шагов до серьезного обслуживания | Убежище инженера | YPermitin</title><meta name="robots" content="index,follow"/><meta name="description" content="Практические примеры настройки обслуживания баз данных для SQL Server. Актуально для любых приложений."/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://ypermitin.github.io/SQLServer/2022-05/few-steps-to-serious-maintenance"/><meta property="og:title" content="Базы данных. Несколько шагов до серьезного обслуживания | Убежище инженера | YPermitin"/><meta property="og:description" content="Практические примеры настройки обслуживания баз данных для SQL Server. Актуально для любых приложений."/><meta property="og:url" content="https://ypermitin.github.io/SQLServer/2022-05/few-steps-to-serious-maintenance"/><meta property="og:type" content="website"/><meta property="og:image" content="https://ypermitin.github.io/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/logo.png"/><meta property="og:image:alt" content="Базы данных. Несколько шагов до серьезного обслуживания | Убежище инженера | YPermitin"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:locale" content="en_IN"/><meta property="og:site_name" content="Убежище инженера"/><link rel="canonical" href="https://webexpe.com/"/><meta property="keywords" content="DevOps, SQL Server, обслуживание, оптимизация, производительность"/><meta property="al:web:url" content="https://ypermitin.github.io/SQLServer/2022-05/few-steps-to-serious-maintenance"/><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/8f7fea57709cfc43.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/8f7fea57709cfc43.css" crossorigin="" data-n-g=""/><link rel="preload" href="/_next/static/css/74d45923820614f0.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/74d45923820614f0.css" crossorigin=""/><link rel="preload" href="/_next/static/css/4a9df9e795bce52b.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/4a9df9e795bce52b.css" crossorigin=""/><link rel="preload" href="/_next/static/css/ee5420a43edabb61.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/ee5420a43edabb61.css" crossorigin=""/><link rel="preload" href="/_next/static/css/88381d5dde4793c2.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/88381d5dde4793c2.css" crossorigin=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script defer="" src="/_next/static/chunks/fea29d9f.ed258e6733dee3dc.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/3a17f596.ba96fa4a4d0542ad.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/4577d2ec.8512d1c0609599a2.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/1664-4a06aa529298108a.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/7167.ab55af9c288ecbc3.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/1465.2204281cc9cfb98d.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/9179.149e20aab74a9c64.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/6806.0e24ace3ea941b14.js" crossorigin=""></script><script defer="" src="/_next/static/chunks/1974.532a76ac54dd3d02.js" crossorigin=""></script><script src="/_next/static/chunks/webpack-22c34cc9679713ab.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-92a422f151f77ddb.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-603010d06ef22166.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-03752a3718bc1b47.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/1102-25671d22e9757217.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/SQLServer/2022-05/few-steps-to-serious-maintenance-e1aac32eff7d3d90.js" defer="" crossorigin=""></script><script src="/_next/static/GvfOuLEDzQB0S8cyeLVOh/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/GvfOuLEDzQB0S8cyeLVOh/_ssgManifest.js" defer="" crossorigin=""></script></head><body class="bg-slate-100 dark:bg-slate-900 transition-all"><div id="__next"><div data-overlay-container="true"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><nav class="Navbar_navbar__W_ouQ bg-white  dark:bg-slate-900 dark:text-white text-black"><div class="container flex items-center justify-between px-2"><div class="flex items-center"><div class="Navbar_mobileBurgerToggle__Bj_52 mr-5  "><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="dark:text-white text-black text-2xl" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></div><a class="text-[22px] font-semibold" href="/">Убежище инженера</a></div><div class="flex items-center"><div class="text-[14px] font-normal items-center lg:flex hidden"><a class="cursor-pointer hover:text-blue-500 mx-2" href="/">Главная</a><div class="relative"><div class="flex items-center cursor-pointer mx-2"><p class="my-0">Блог</p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-[20px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path></svg></div><div class="overflow-auto absolute w-[180px] z-20 top-[30px] rounded-[4px] shadow-lg bg-white dark:bg-slate-800 border border-gray-300 dark:border-0 h-0 border-0"><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2" href="/blog/"><span>Все публикации</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=PostgreSQL"><span style="text-transform:capitalize">PostgreSQL</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=DevOps"><span style="text-transform:capitalize">DevOps</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=SQL%20Server"><span style="text-transform:capitalize">SQL Server</span></a></div></div><a class="cursor-pointer hover:text-blue-500 mx-2" href="/about/">Обо мне</a><a href="https://boosty.to/ypermitin" target="_blank" rel="noopener noreferrer" class="d-block mx-2 flex-wrap">Поддержать</a><a href="https://github.com/YPermitin" target="_blank" rel="noopener noreferrer" class="d-block mx-2 flex-wrap">Github</a><a class="cursor-pointer hover:text-blue-500 mx-2" href="/contact/">Контакты</a><div class="ml-5 pt-1"><a href="https://github.com/YPermitin/" target="_blank" rel="noopener noreferrer" class="text-[18px] inline-block mr-4"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></div><div class="Navbar_search_icon_wrapper__1a_rL ml-5 dark:text-white"><button name="search-button" aria-label="search button"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="dark:text-white text-black text-[22px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></button></div><div class=""><button name="share" aria-label="share page"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="dark:text-white text-black text-[16px] mt-[7px] ml-2 mr-1" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5z"></path></svg></button></div><button name="theme-switch" aria-label="theme button" class="Navbar_theme_switch__q7F_Z pl-3 dark:text-white text-black"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-md " height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path></svg></button></div></div></nav><aside class="Navbar_nav_sidebar_wrapper__M0KaI dark:bg-slate-900 dark:text-white bg-white text-black"><div class="flex items-center justify-between pb-3"><p class="">МЕНЮ</p><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-slate-800 dark:text-white text-[25px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0V0z"></path><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg></div></div><hr/><div class="my-15"><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/">Главная</a><div class="relative"><div class="flex items-center cursor-pointer justify-between"><p class="my-0">Блог</p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-[20px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16.293 9.293 12 13.586 7.707 9.293l-1.414 1.414L12 16.414l5.707-5.707z"></path></svg></div><div class="overflow-auto relative h-0 border-0"><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2" href="/blog/"><span>Все публикации</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=PostgreSQL"><span style="text-transform:capitalize">PostgreSQL</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=DevOps"><span style="text-transform:capitalize">DevOps</span></a><a class="cursor-pointer hover:text-blue-500 block text-sm py-2 px-2 border-t border-gray-400" href="/blog/?category=SQL%20Server"><span style="text-transform:capitalize">SQL Server</span></a></div></div><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/about/">Обо мне</a><a href="https://boosty.to/ypermitin" target="_blank" rel="noopener noreferrer" class="text-[16px] block my-3 flex-wrap">Поддержать</a><a href="https://github.com/YPermitin" target="_blank" rel="noopener noreferrer" class="text-[16px] block my-3 flex-wrap">Github</a><a class="cursor-pointer hover:text-blue-500 text-[16px] block my-3" href="/contact/">Контакты</a></div><hr/><div class="my-5"><p class="font-light">Подписаться : </p> <a href="https://github.com/YPermitin/" target="_blank" rel="noopener noreferrer" class="text-[28px] inline-block mr-5 mt-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><hr class="mt-5"/></div><div class="mt-5 mb-4"><p class="mb-2 font-light">Переключиться на <!-- -->светлую<!-- --> тему :</p><button name="theme-switch" aria-label="theme-switch" class="Navbar_theme_switch__q7F_Z dark:text-white text-black"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-lg" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path></svg></button></div><hr/><div class="my-5"><p class="text-sm font-light dark:text-gray-400 text-gray-500 mb-1">Copyright © 2024</p></div></aside><div class="transition-all fixed h-screen w-screen flex items-center justify-center left-0 z-20 top-0 pointer-events-none opacity-0"><div class="absolute top-0 left-0 w-screen h-screen bg-black opacity-50"></div><div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded lg:w-1/6 mx-3 w-full relative z-10 transition-all top-10"><div class="flex border-gray-300 pb-2 mb-3 border-b"><p class="  font-medium w-full">Share:</p><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"></path></svg></span></div><div class="flex flex-wrap items-center"><a class="mr-3" aria-label="facebook-share" href="https://www.facebook.com/sharer/sharer.php?u=https://ypermitin.github.io" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-92.4 233.5h-63.9c-50.1 0-59.8 23.8-59.8 58.8v77.1h119.6l-15.6 120.7h-104V912H539.2V602.2H434.9V481.4h104.3v-89c0-103.3 63.1-159.6 155.3-159.6 44.2 0 82.1 3.3 93.2 4.8v107.9z"></path></svg></a><a class="mr-3" aria-label="twitter-share" href="http://twitter.com/share?text=Check out this article!! &amp;url=https://ypermitin.github.io&amp;hashtags=webdevelopment,javacript,javascriptdaily,webdevelopmenttutorial,tutorial" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm215.3 337.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg></a><a class="mr-3" aria-label="linkedin-share" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ypermitin.github.io&amp;title=Check out this article!!&amp;source=LinkedIn" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[23px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><button class="mr-3" name="copy-link" aria-label="copy-link"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg></button></div><div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed flex transition-all right-[10px] -bottom-20 opacity-0" role="alert"><strong class="font-bold">Link Copied</strong><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"></path></svg></span></div></div></div><section class="PageLayout_centered_article_wrapper__gS3Af dark:bg-slate-900 dark:text-white"><div class="container px-0 md:px-[15px] pt-[50px] pb-[50px]"><article class="PageLayout_article_content__4dnq3 pb-[30px] px-3 bg-white dark:bg-slate-800 dark:border-none dark:drop-shadow-lg dark:text-white pt-10 md:pt-0 mx-auto font-regular text-lg leading-relaxed"><div class="mb-[30px]"><h1 class="ArticleHeader_articleTitle__3L1Bi text-center text-2xl md:text-4xl font-medium mt-[20px] mb-[5px]">Базы данных. Несколько шагов до серьезного обслуживания</h1><div class="mb-[10px] mt-[15px] text-[14px] font-medium ArticleHeader_centered_article_header_author___gRtE"><p class="my-0 mx-[30px] font-medium">YPermitin<span class="px-1 font-light">в</span><a href="/blog/?category=SQL%20Server">SQL Server</a></p><p class="my-0">2022-05-22</p></div><div class="md:mt-2 flex flex-wrap justify-center"><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->DevOps</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->SQL Server</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->обслуживание</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->оптимизация</p><p class="text-[12px] font-normal mr-2 mb-1 inline-block text-gray-500 dark:text-gray-400">#<!-- -->производительность</p></div></div><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Об этом много сказано</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Тема обслуживания баз данных (индексов и статистик) поднимается достаточно часто в разных статьях, официальной документации, на форумах и так далее. Обычно дается описание процессов обслуживания, зачем они нужны и какие бывают, на что влияют. И, конечно же, как сделать настройку обслуживания. Последнее обычно преподносится на базовом уровне, но, конечно, не всегда.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Сегодня мы снова коснемся этой темы, но несколько в ином ключе. Мы на практических примерах посмотрим на настройку обслуживания от простого случая до более продвинутого. Так можно будет проследить как меняется обслуживание при изменении требований к работе информационной системы.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Мы сосредоточимся на решении именно практических задач. Теорию Вы можете найти по ссылкам в конце статьи.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Общие слова</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Прежде чем мы перейдем к примерам, определимся с тем, что будем делать.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Обслуживание подразумевает две больших части:</p><ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Поддержание фрагментации индексов на приемлемом уровне. В идеале процент фрагментации у каждого индекса должен быть равен 0 или близок к этому значению.</li><li>Состояние статистики должно быть в максимально в актуальном состоянии. При изменении строк в таблице, объекты статистики должны иметь гистограмму распределения значений, которая отражает состояние объектов базы наиболее актуальным образом.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Все это влияет на формируемые планы запросов. В самых общих чертах, если индекс имеет высокую фрагментацию или статистика знатно устарела, то оптимизатор SQL Server даже не будет пытаться использовать индекс и выполнит полное сканирование таблицы. Последнее, как Вы понимаете, не самая быстрая и оптимальная ситуация. Есть и другие последствия отсутствия обслуживания, но это совсем другая история.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также сразу отметим, что никаких сторонних программ для настройки обслуживания мы использовать не будем. Чистый TSQL, возможно, в готовых скриптах и/или хранимых процедурах. Но никакого стороннего софта.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Итак, настало время первого примера!</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Примеры, примеры, примеры</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">На старт, внимание, марш!</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Типичное обслуживание</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Когда речь заходит об обслуживании, то обычно начинают с создания плана обслуживания, где используют готовые компоненты. Для этого создаем план обслуживания через SQL Server Managment Studio в разделе “Managment ➡️ Maintenance Plans” с субпланом “FullMaintenance”.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/1. Простой план обслуживания.png" alt="Простой план обслуживания" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Механизм планов обслуживания базируется на “обрезанной” версии SSIS, если так можно выразиться. Для использования готовых компонентов нужно использовать именно его.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_xs__E5xhu display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/2. Раздел обслуживания.png" alt="Раздел обслуживания" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Альтернативным вариантом является использование заданий (job’ов) агента SQL Server, просто указывая явно скрипты TSQL для выполнения.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В созданный субплан добавляем три компонента. Выше Вы уже могли видеть схему субплана обслуживания.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Rebuild Index Task</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Компонент перестроения индексов “Rebuild Index Task” имеет в себе большинство необходимых настроек для запуска простого обслуживания.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/3. Rebuild Index Task.png" alt="Rebuild Index Task" width="100%" class="block"/></div></div></div><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Connection</b> - указываем параметры соединения с базой данных, сервером СУБД. Обычно здесь остается стандартная настройка, останавливаться подробней не будем.</li><li><b>Database(s)</b> - указываем для какой базы (или списка баз) нужно выполнять обслуживание. Обычный фильтр.</li><li><b>Object</b> - здесь мы можем выбрать для каких объектов базы данных нужно выполнять обслуживание.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Tables and Views</b> - все объекты базы.</li><li><b>Tables</b> - таблицы базы, можно указать все или выбрать конкретные.</li><li><b>Views</b> - представления базы, можно указать все или выбрать конкретные.</li></ul></li><li><b>Free space options</b> - параметр отвечает за то, сколько процентов свободного места нужно оставлять в каждой странице. По умолчанию используются стандартные параметры сервера, но это значение можно переопределить. Если оставлять некоторое место на страницах свободным, то можно уменьшить рост фрагментации индексов, т.к. изменения будут дописываться в существующие страницы и связанные данные меньше будут “раскидываться” между отдельными страницами. Подробнее читайте в документации, рассматривать это сегодня более детально не будем.</li><li><b>Advaned options</b> - это различные дополнительные настройки для более тонкого управления обслуживанием индексов.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Sort results in tempdb</b> - этот флаг включает хранение промежуточных результатов сортировки при формировании индекса. По умолчанию они хранятся в памяти или целевой файловой группе. По умолчанию он установлен в ЛОЖЬ.</li><li><b>Keep index online</b> - SQL Server поддерживает перестроение индексов в онлайн режиме, при котором работа с таблицей и индексом не блокируется во время выполнения обслуживания. По завершению перестроения выполняется переключение старого индекса на новый, что позволяет исключить блокирование работы запросов и выполнять обслуживание при минимальном размере технологического окна. Или при его полном отсутствии. Дополнительно к этому режиму указывают варианты действия для тех индексов, которые не поддерживают онлайн-обслуживание (например, если содержат типы text, ntext, image, filestream. Первые 3 считаются устаревшими, но все еще поддерживаются для совместимости). В момент переключения, конечно же, кратковременно создается блокировка на уровне схемы данных и есть различные сценарии обработки этой блокировки. Об этом подробней мы поговорим ниже.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Do not rebuild</b> - индексы без поддержки онлайн перестроения будут пропущены.</li><li><b>Rebuild indexes offline</b> - индекс без поддержки онлайн перестроения будет обслужен в обычном режиме с блокировкой работы с ним.</li></ul></li><li><b>Pad index</b> - указать заполнение индекса. Определяет разреженность индекса. По умолчанию выключен. При включении настройка fillfactor применяется к страницам промежуточного индекса.</li><li><b>MAXDOP</b> - указываем степень параллелизма для операций обслуживания. Таким образом можно указать параметр, отличный от значения параметра всего сервера.</li></ul></li><li><b>Index Stats Options</b> - параметры анализа индексов перед обслуживанием. Фактически это режимы просмотра для системной DMV sys.dm_db_index_physical_stats, которые влияют на работу некоторых фильтров и точность результатов анализа. Но зато поверхностный анализ позволяет ускорить запросы перед началом обслуживания. Детальный анализ потребует больше времени и создаст дополнительную нагрузку на сервер.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Fash</b></li><li><b>Sampled</b></li><li><b>Detailed</b></li></ul></li><li><b>Oprimize index only if</b> - дополнительные фильтры для обслуживаемых индексов.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Fragmnetation</b> <!-- -->&gt;<!-- --> - фрагментация должна быть больше определенного процента. Общепринятым правилом считается, что перестроение нужно выполнять, если фрагментация выше 30%.</li><li><b>Page Count</b> - фильтр по размеру индекса. Указывается в количестве страниц. Каждая страница = 8 КБ.</li></ul></li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Базовые настройки именно такие.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Reorganize Index Task</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Компонент реорганизации индексов “Reorganize Index Task”. Позволяет выполнять операции реорганизации, которые требуют меньше ресурсов, чем перестроение. Также этот процесс выполняется без долгосрочных блокировок объекта и минимально влияет на текущую работу запросов. Обычно дефрагментация при таком способе выполняется для страниц конечного уровня, что делает такую операцию не всегда оптимальным вариантом.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/4. Reorganize Index Task.png" alt="Reorganize Index Task" width="100%" class="block"/></div></div></div><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Connection</b> - указываем параметры соединения с базой данных, сервером СУБД. Обычно здесь остается стандартная настройка, останавливаться подробней не будем.</li><li><b>Database(s)</b> - указываем для какой базы (или списка баз) нужно выполнять обслуживание. Обычный фильтр.</li><li><b>Object</b> - здесь мы можем выбрать для каких объектов базы данных нужно выполнять обслуживание.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Tables and Views</b> - все объекты базы.</li><li><b>Tables</b> - таблицы базы, можно указать все или выбрать конкретные.</li><li><b>Views</b> - представления базы, можно указать все или выбрать конкретные.</li></ul></li><li><b>Compact large objects</b> - освобождение пространства для таблиц и индексов, если возможно.</li><li><b>Index Stats Options</b> - параметры анализа индексов перед обслуживанием. Фактически это режимы просмотра для системной DMV sys.dm_db_index_physical_stats, которые влияют на работу некоторых фильтров и точность результатов анализа. Но зато поверхностный анализ позволяет ускорить запросы перед началом обслуживания. Детальный анализ потребует больше времени и создаст дополнительную нагрузку на сервер.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Fast</b></li><li><b>Sampled</b></li><li><b>Detailed</b></li></ul></li><li><b>Oprimize index only if</b> - дополнительные фильтры для обслуживаемых индексов.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Fragmnetation</b> <!-- -->&gt;<!-- --> - фрагментация должна быть больше определенного процента. Общепринятым правилом считается, что перестроение нужно выполнять, если фрагментация выше 30%.</li><li><b>Page Count</b> - фильтр по размеру индекса. Указывается в количестве страниц. Каждая страница = 8 КБ.</li><li><b>Used in last</b> - фильтр по размеру индекса. Указывается в количестве страниц. Каждая страница = 8 КБ.</li></ul></li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Настройки похожи на перестроение. Убраны параметры, которые для реорганизации просто не используются. Например MAXDOP, ведь операция реорганизации не распараллеливается как перестроение.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Update Statistics Task</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Компонент обслуживания статистики “Update Statistics task”. Позволяет настроить обслуживание статистики в базе данных.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/5. Update Statistics Task.png" alt="Update Statistics Task" width="100%" class="block"/></div></div></div><ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Connection</b> - указываем параметры соединения с базой данных, сервером СУБД. Обычно здесь остается стандартная настройка, останавливаться подробней не будем.</li><li><b>Database(s)</b> - указываем для какой базы (или списка баз) нужно выполнять обслуживание. Обычный фильтр.</li><li><b>Object</b> - здесь мы можем выбрать для каких объектов базы данных нужно выполнять обслуживание.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Tables and Views</b> - все объекты базы.</li><li><b>Tables</b> - таблицы базы, можно указать все или выбрать конкретные.</li><li><b>Views</b> - представления базы, можно указать все или выбрать конкретные.</li></ul></li><li><b>Update</b> - режим обновления объектов статистики.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>All existing statistics</b> - будут обновлены все объекты статистики.</li><li><b>Column statistics only</b> - обновление только статистики столбцов.</li><li><b>Index statictis only</b> - только статистику индексов.</li></ul></li><li><b>Scan type</b> - тип сканирования данных таблицы для актуализации гистограммы распределения значений статистики.<ul class="List_list__zLjGi list-disc pl-[30px]"><li><b>Full scan</b> - полное сканирование всех значений.</li><li><b>Sample by</b> - для анализа будет использован только некоторый процент данных из таблицы, что позволит ускорить процесс обновления, но снизит точность.</li></ul></li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">На скриншоте ниже можно увидеть объекты статистики разных типов. Зеленым обведены объекты статистики, которые связаны с индексами. А объекты статистики с именем “WA_Sys*”, обведенные красным, это как раз служебные статистики столбцов, которые СУБД создает автоматически. Конечно, никто не мешает создать свой объект статистики, если в этом есть необходимость.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_xs__E5xhu display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/6. Объекты статистики.png" alt="Объекты статистики" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Чаще всего оставляют обновление всех объектов статистики, а не только тех, которые относятся к индексам. Также в абсолютном большинстве случаев достаточно оставить обновление статистики через анализ ограниченной выборки данных. Полное сканирование конечно хорошо, но на больших базах оно может выполняться много часов. Если база небольшая, то можно оставлять и полное сканирование, но нужно учитывать, что обновление статистики таким образом в некоторых случаях может создавать <b><u><a href="https://www.brentozar.com/archive/2014/01/update-statistics-the-secret-io-explosion/" target="_blank" rel="noopener noreferrer">проблемы ввода-вывода</a></u></b>, но опять же для больших баз.</p><h2 class="font-semibold text-xl md:text-2xl my-[10px] mt-10 md:text" style="text-align:unset">Небольшой итог типичного обслуживания</h2><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Мы пробежались по основным настройкам каждого доступного компонента.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Предположим, что у нас типичная задача - небольшая база на SQL Server, работ ночью не ведется и в качестве технологического окна у нас время с 21:00 до 06:00. Идеально! Тогда настроим запуск обслуживания как на схеме выше, чередуя операции следующим образом:</p><ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Перестроение индексов с указанием нужной базы и выбрав все таблицы и представления. При этом не используем онлайн-перестроение, оставляем отключенной сортировку в TempDB и так далее. В общем все настройки стандартные как на скрине выше, разве что MAXDOP можно поставить максимальный, пусть все ресурсы сервера будут выделены под перестроение.</li><li>Вторым шагом реорганизация индексов. Также оставляем все настройки по умолчанию. Реорганизацию оставляем именно вторым шагом, т.к. в первую очередь нужно выполнить обслуживание индексов, у которых фрагментация выше 30%.</li><li>И последней операцией устанавливаем обновление статистики. Пусть выполняется для всех объектов статистики и методом полного сканирования.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также рекомендую добавить еще один субплан обслуживания для обновления статистики в дневное время, чтобы сгладить изменения в базе и помочь оптимизатору запросов актуальной статистикой. Например, установить запуск операции ежедневно в 13:00 (например, сориентироваться на обеденное время сотрудников). Настройки такие же, как и у обновления статистики в ночное время.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_xs__E5xhu display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/7. Задача обновления статистики.png" alt="Задача обновления статистики" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Так как база небольшая, то, скорее всего, весь процесс обслуживания завершится за 30-60 минут ночью и за 5-15 минут днем, а может и еще быстрее.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Плюсы:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Простота настройки</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Минусы:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Отсутствие контроля выполнения</li><li>Блокирование работы запросов в момент обслуживания</li><li>Нет возможности проанализировать результаты выполнения обслуживания в динамике, нет истории работы обслуживания</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Но если база небольшая, то все перечисленные минусы несущественны. Что такое небольшая база? Понятие относительное <!-- -->:)<!-- -->. Главное, что нужно понять, так это если такое обслуживание Вас полностью устраивает, то делать что-то более сложное нет смысла.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Первые проблемы</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Какое-то время все шло хорошо, но от бизнеса появилось новое требование: в ночное время обслуживание не должно мешать работе информационной системы. Например, могли появиться важные регламентные задания по интеграции, расчетам и так далее.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Выше мы уже говорили, что SQL Server поддерживает онлайн-перестроение индексов и мы можем его использовать для тех объектов, которые это поддерживают. Те объекты, для которых онлайн-перестроение нельзя выполнить из-за использования legacy-типов в полях (text, ntext, image), будут обслужены обычным образом с блокировкой работы с ними. Так что от всех проблем мы не избавимся, но других настроек в стандартном компоненте нет. Поэтому следует выполнить следующие изменения:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>В шаге перестроения индексов, который выполняется в ночное время, установить использование онлайн перестроения. По сравнению с обычной операцией обслуживания онлайн перестроение требует больше ресурсов по CPU и по использованному месту, да и лог транзакций при полной модели восстановления будет заполнен больше. Такова цена беспрерывной работы запросов.<div class="Images_article_image__wrapper__QSTzx my-4 Images_size_small__BEVeh display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/8. Пример настройки онлайн-перестроения индекса.png" alt="Пример настройки онлайн-перестроения индекса" width="100%" class="block"/></div></div></div></li><li>Степень параллелизма желательно установить ограниченным значением, чтобы CPU не был загружен на 100% во время обслуживания. Ведь блокировки не единственная проблема, которая может помешать работе информационной системе. Высокая нагрузка от обслуживания тоже может остановить работу. Общая рекомендация поставить MAXDOP = 30% от общего количества ядер. Например, если на сервере 24 ядра, то под перестроение индексов выделить только 8.</li><li>Остальные настройки оставляем как есть.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Тут также подведем небольшой итог.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Плюсы:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Простота настройки</li><li>Минимальное влияние на работу системы во время обслуживания</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Минусы:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Отсутствие контроля выполнения</li><li>Блокирование работы запросов в момент обслуживания для тех объектов, в которых онлайн перестроение невозможно</li><li>Нет возможности проанализировать результаты выполнения обслуживания в динамике, нет истории работы обслуживания</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Опять же, если последние 3 причины не критичны, то все отлично!</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Большой шаг</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Компания развивается, и информационная база растет. У нас появились большие таблицы и много, а технологическое окно уменьшилось: с 21:00 до 23:00. Появились склады, которые работают 24/7. Кроме этого остается старая проблема с объектами, которые не поддерживают онлайн перестроение. Мы должны их обслуживать так, чтобы они минимально создавали блокировки. Кроме этого, нужно гарантировать, что обслуживание не выйдет за пределы установленного технологического окна с 21:00 до 23:00.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">К сожалению, стандартными компонентами обслуживания, которыми пользовались до этого момента, данную задачу решить уже нельзя. Поэтому мы пойдем другим путем. Мы создадим служебную базу обслуживания и мониторинга с именем “SQLServerMaintenance”, а далее наполним ее <b><u><a href="https://github.com/YPermitin/SQLServerTools/blob/master/SQL-Server-Maintenance/Service-Database/CreateServiceDatabaseScript.sql" target="_blank" rel="noopener noreferrer">объектами следующим скриптом.</a></u></b></p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset"><b><u><a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-Maintenance/Service-Database" target="_blank" rel="noopener noreferrer">Этот скрипт взят отсюда.</a></u></b> Там же есть примеры использования, описания процедур и их параметров, а также другая связанная информация. Для актуальной версии следите за обновлениями. Также никто не мешает Вам дорабатывать эти скрипты для себя.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Инструмент готов, а теперь нужно заменить компоненты обслуживания на свои скрипты. И вот как это будет выглядеть.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_xs__E5xhu display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/9. Продвинутое обслуживание.png" alt="Продвинутое обслуживание" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Вместо трех шагов теперь только 2, в каждом свои скрипты для выполнения операций. На первом шаге используем такой скрипт:</p><div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SQLServerMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_IndexMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token variable" style="color:rgb(156, 220, 254)">@databaseName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;BSL-ORIG&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Разрешаем запуск скрипта с 21:00:00 до 22:30:00</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeFrom</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;21:00:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeTo</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;22:30:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 1 - обслуживать только те объекты, которые поддерживают онлайн-перестроение</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@useOnlineIndexRebuild</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Процент фрагментации, с которого будет выполняться обслуживание</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@fragmentationPercentMinForMaintenance</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Процент фрагментации с которого начинается полное перестроение.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Все, что между 10 и 30 будет обслуживаться операцией реорганизации</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@fragmentationPercentForRebuild</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">30</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Степень параллелизма для операций перестроения оставляем равной 8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@maxDop</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Настраиваем поведение онлайн-перестроения в ситуациях, когда переключение индекса на новый блокируется</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- другими запросами</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 1 - операция обслуживания завершит себя по истечении таймаута ожидания.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@onlineRebuildAbortAfterWaitMode</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Время ожидания операции онлайн перестроения перед прерыванием работы. Ставим 15 минут</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@onlineRebuildWaitMinutes</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">15</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В скрипте мы указываем имя базы, для которой устанавливаем обслуживание и диапазон времени, в который можно выполнять операции обслуживания.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Кроме этого указываем, что нужно обслуживать только те объекты, которые поддерживают онлайн перестроение (параметр @useOnlineIndexRebuild). Также устанавливаем, что обслуживание нужно начинать только с 10% фрагментацией (@fragmentationPercentMinForMaintenance), а полное перестроение только при 30% значении фрагментации индекса (@fragmentationPercentForRebuild). Таким образом, реорганизация индекса будет применяться, если фрагментация находится в диапазоне между 10% и 30%.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Дополнительно к этому установим особые параметры онлайн обслуживания:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>При блокировании обслуживания другими запросами отдаем приоритет именно им. То есть по истечении таймаута операция обслуживания завершит сама себя (@onlineRebuildAbortAfterWaitMode).</li><li>Время ожидания при этом установим в 15 минут (@onlineRebuildAbortAfterWaitMode).</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Это должно решить все перечисленные выше задачи.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для обслуживания статистики будем использовать следующий скрипт.</p><div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SQLServerMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_StatisticMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token variable" style="color:rgb(156, 220, 254)">@databaseName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;BSL-ORIG&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeFrom</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;21:00:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeTo</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;22:30:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 0 устанавливаем режим анализа выборки данных, </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 1 - режим полного сканирования</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@mode</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также указываем время работы скрипта и режим полного сканирования.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">На первом шаге мы обязательно установим таймаут выполнения операции в 2 часа. Это соотносится с указанным в настройках диапазоном времени с 21:00 до 22:30 (1.5 часа). Таймаут в 2 часа это последний рубеж защиты, чтобы процедуры обслуживания не вышли за 23:00. Такое может произойти, если индекс начал операцию перестроения или реорганизации в 22:20 и к 23:00 не завершился, то таймаут выполнения команды ее прервет “насильно”.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">При этом для операции обновления статистики таймаут выполнения мы не ставим, т.к. она не мешает работе других запросов. При этом если обслуживание индексов работало до 23:00 (с таймаутом или без), то обслуживание статистик не будет запущено. Считаем это проблемными ситуациями и они не должны возникать часто.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также добавим дополнительный субплан для обслуживания индексов, которые не поддерживают онлайн перестроение. Считаем, что таких объектов не много и их можно обслуживать раз в неделю. Для этого добавим субплан с запуском раз в неделю, например в субботу в 23:00 и отдаем на работу скрипта 30 минут. Скрипт будет таким. Заменяем параметр “@useOnlineIndexRebuild” и убираем настройки, связанные с онлайн перестроением.</p><div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SQLServerMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_IndexMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token variable" style="color:rgb(156, 220, 254)">@databaseName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;BSL-ORIG&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Разрешаем запуск скрипта с 23:00:00 до 23:30:00</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeFrom</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;23:00:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeTo</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;23:30:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- (2) - обслуживание только тех объектов, в которых онлайн-перестроение не поддерживается.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@useOnlineIndexRebuild</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Процент фрагментации, с корого будет выполняться обслуживание</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@fragmentationPercentMinForMaintenance</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Процент фрагментации с которого начинается полное перестроение.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Все, что между 10 и 30 будет обслуживаться операцией реорганизации</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@fragmentationPercentForRebuild</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">30</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Степень параллелизма для операций перестроения оставляем равной 8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@maxDop</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Таймаут для операции установим в 1 час, то есть в 00:00 операция будет завершена в любом случае.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И последнее изменение - это дополнительные шаги обслуживания статистики. Ранее мы запускали в дневное время отдельное обновление статистики, а теперь будем выполнять это 3 раза (не считая основного ночного обслуживания): в 06:00, 13:00 и в 18:00. Отключаем ограничения времени выполнения и режим обновления теперь выполняем через выборку данных, а не полным сканированием.</p><div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SQLServerMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_StatisticMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token variable" style="color:rgb(156, 220, 254)">@databaseName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;BSL-ORIG&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 0 устанавливаем режим анализа выборки данных, </span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 1 - режим полного сканирования</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@mode</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Так как полное сканирование не используется, то даже для многотеррабайтных баз эта операция будет выполняться за 5-30 минут. Поэтому ограничения выполнения или таймаутов выполнения устанавливать не будем.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Готово! Небольшие итоги:</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Плюсы:</p><ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Минимальное влияние на работу запросов во время обслуживания (как по блокировкам, так и по нагрузке на базу).</li><li>Максимально актуальная статистика во время всего рабочего дня.</li><li>Полный контроль над выполняемыми операциями. Приоритет отдается выполняемым запросам, а не обслуживанию. Работа информационной системы не будет нарушена.</li><li>Практически полное покрытие задач обслуживания баз данных в большинстве мелких, средних и крупных баз данных.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Минусы:</p><ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Более сложная схема настройки, требующая понимания работы процессов обслуживания и их сопровождения.</li><li>Необходимость прочитать инструкции и документацию по SQL Server в нештатных ситуациях.</li><li>Желательны навыки работы с TSQL.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Может ли потребоваться изменять обслуживание еще как-то?</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">А вот и полная модель</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Настает момент, когда для задач отказоустойчивости и надежности базу данных переключают в полную модель восстановления. Это позволяет восстановить базу данных из бэкапа на любой момент времен и не потерять данные в случае внезапного падения.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Рассматривать шаги для безопасного перевода баз в полную модель мы не будем. Основное что отметим - в таком режиме все изменения сохраняются в лог транзакций и остаются там до тех пор, пока он не будет бэкапирован. Важно заметить, что только бэкап лога транзакций помечает их готовыми к удалению из файла лога. Полный бэкап файл лога транзакций не очистит.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Но использование полной модели накладывает особенности в работе обслуживания. Может случиться так, что перестроение индексов может заполнить лог транзакций, что остановит все операции модификации данных в базе. Другими словами, информационная система перестанет работать.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Чтобы этого не случилось - установим ограничения на использование файла логов транзакций. Дополним предыдущий скрипт параметром ограничения. Скрипт тот же, только добавили один параметр в конце.</p><div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SQLServerMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_IndexMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token variable" style="color:rgb(156, 220, 254)">@databaseName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;BSL-ORIG&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Разрешаем запуск скрипта с 21:00:00 до 22:30:00</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeFrom</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;21:00:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeTo</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;22:30:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 1 - обслуживать только те объекты, которые поддерживают онлайн-перестроение</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@useOnlineIndexRebuild</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Процент фрагментации, с которого будет выполняться обслуживание</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@fragmentationPercentMinForMaintenance</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Процент фрагментации с которого начинается полное перестроение.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Все, что между 10 и 30 будет обслуживаться операцией реорганизации</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@fragmentationPercentForRebuild</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">30</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Степень параллелизма для операций перестроения оставляем равной 8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@maxDop</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Настраиваем поведение онлайн-перестроения в ситуациях, когда переключение индекса на новый блокируется</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- другими запросами</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 1 - операция обслуживания завершит себя по истечении таймаута ожидания.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@onlineRebuildAbortAfterWaitMode</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Время ожидания операции онлайн перестроения перед прерываниеем работы. Ставим 15 минут</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@onlineRebuildWaitMinutes</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">15</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- !!!</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Разрешаем использование только 50% файла лога транзакций.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Если лог транзакций заполнен на больший процент, то новые объекты обслуживаться не будут</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@maxTransactionLogSizeUsagePercent</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Можно также установить ограничение явно в мегабайтах</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">--,@maxTransactionLogSizeMB bigint = 0</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- !!!</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Параметры @maxTransactionLogSizeUsagePercent и @maxTransactionLogSizeMB как раз и решают эту задачу. Но нужно учитывать, что проверка выполняется перед началом выполнения операции обслуживания. Если индекс начал перестраиваться, то ограничение на текущий процесс уже не повлияет. Поэтому также рекомендуется спланировать резерв места на диске с файлом лога транзакций. А если, мало ли, размер логов при перестроении может превысить 2 ТБ, то нужно создать несколько файлов логов транзакций, чтобы обойти это ограничение. Да, максимальный размер одного файла лога транзакций равен 2 ТБ.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Разделяй и властвуй</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В некоторых случаях есть смысл большие индексы обслуживать не ежедневно, а раз в неделю и, например, только полным перестроением. Для этого внесем следующие изменения:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>В ежедневном плане обслуживания индексов установим условие на максимальный размер обслуживаемых объектов. Расписание установим с понедельника по субботу. Можно установить нижнюю (@maxIndexSizePages) и верхнюю (@maxIndexSizePages) границу. В примере мы ставим условие только на макс. размер объекта. В скрипте ниже объекты размером 100 ГБ обслуживаться не будут.<div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SQLServerMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_IndexMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token variable" style="color:rgb(156, 220, 254)">@databaseName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;BSL-ORIG&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Разрешаем запуск скрипта с 21:00:00 до 22:30:00</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeFrom</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;21:00:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeTo</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;22:30:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 1 - обслуживать только те объекты, которые поддерживают онлайн-перестроение</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@useOnlineIndexRebuild</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Процент фрагментации, с которого будет выполняться обслуживание</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@fragmentationPercentMinForMaintenance</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Процент фрагментации с которого начинается полное перестроение.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Все, что между 10 и 30 будет обслуживаться операцией реорганизации</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@fragmentationPercentForRebuild</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">30</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Степень параллелизма для операций перестроения оставляем равной 8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@maxDop</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Настраиваем поведение онлайн-перестроения в ситуациях, когда переключение индекса на новый блокируется</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- другими запросами</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 1 - операция обслуживания завершит себя по истечении таймаута ожидания.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@onlineRebuildAbortAfterWaitMode</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Время ожидания операции онлайн перестроения перед прерыванием работы. Ставим 15 минут</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@onlineRebuildWaitMinutes</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">15</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- !!!</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Разрешаем использование только 50% файла лога транзакций.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Если лог транзакций заполнен на больший процент, то новые объекты обслуживаться не будут</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@maxTransactionLogSizeUsagePercent</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Макс. размер обслуживаемых объектов будет равен 50 ГБ.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Размер устанавливается в количестве страниц по 8 КБ.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- 50 ГБ = 6553600 страниц</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@maxIndexSizePages</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">6553600</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span></div></pre></div></div></li><li>Добавим еще один субплан обслуживания с теми же операциями, что и в ежедневном плане обслуживания, но в скрипте обслуживания индексов снимем ограничение на макс. размер индекса.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Это позволит разделить обслуживание и избавится от массивных операций изменения в будние дни. Тут стоит отметить, что нужно понимать последствия таких решений. Предварительно нужно проанализировать что это за таблицы и как изменение стратегии обслуживания повлияет на работу информационной системы.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Есть и более точечный вариант настройки обслуживания, в котором ограничения будут опираться не на размер объектов, а на конкретные объекты. Например, можно добавить такое условие в процедуру обслуживания индексов:</p><div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Отбор по конкретной таблице</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@ConditionTableName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;IN (&#x27;&#x27;_AccumRg1265&#x27;&#x27;,&#x27;&#x27;_AccumRg505&#x27;&#x27;)&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">или даже поставить отбор на конкретный индекс:</p><div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Отбор на конкретный индекс (отбор по таблице в этом случае не обязателен)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@ConditionIndexName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;= &#x27;&#x27;_AccumRg505_1&#x27;&#x27;&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для таких точечных операций обслуживания можно задать свое расписание, свои таймауты выполнения и так далее.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Слишком большие объекты</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Следующая проблема, которая может появиться в больших базах - это обслуживание ооооооочень больших, огромных объектов в пределах окна обслуживания. Например, у нас есть 2 часа на обслуживание индексов. Но что, если для перестроения индекса, размер которого 1 ТБ, нужно 5 часов.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Конечно, в онлайн режиме блокировок это не создаст, но замедление работы с индексом или выделяемые ресурсы для такого перестроения могут косвенно влиять на другие запросы. Кроме этого, файл лога транзакций будет заполняться полностью и даже дополнительные файлы могут не спасти ситуацию.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Тут на помощь приходят возобновляемые операции перестроения индексов, доступных со SQL Server 2017. Работает это так:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Вы запускаете операцию перестроения индекса в онлайн режиме, указав параметр RESUMABLE = ON.<div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INDEX</span><span class="token plain"> PK_1 </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_Acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">REBUILD</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ONLINE </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> RESUMABLE </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">GO</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span></div></pre></div></div></li><li>Процесс перестроения выполняется, пока Вы не прервете его явно командой завершения сессии (например, если таймаут сработал) или не указав остановку явно.<div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INDEX</span><span class="token plain"> PK_1 </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_Acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">  PAUSE</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span></div></pre></div></div></li><li>После остановки операции файл журнала транзакций может быть освобожден после выполнения бэкапа логов. Да, перестроение индекса еще не завершено, но освободить файл журнала транзакций можно.</li><li>Можно проверить список операций перестроения, доступных для продолжения, а также состояние прогресса перестроения<div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  total_execution_time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  percent_complete</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  state_desc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  last_pause_time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  page_count</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_resumable_operations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span></div></pre></div></div></li><li>Возобновляем операцию перестроения при необходимости. Например, в следующем технологическом окне обслуживания.<div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INDEX</span><span class="token plain"> PK_1 </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_Acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">  RESUME</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span></div></pre></div></div></li><li>Или можно прервать операцию окончательно.<div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INDEX</span><span class="token plain"> PK_1 </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_Acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">  ABORT</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span></div></pre></div></div></li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Это позволит выполнять даже самые тяжелые операции в заданное окно обслуживания, хоть и за несколько дней. А также обезопасить себя от переполнения лога транзакций.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">В контексте нашей служебной базы использование возобновляемого перестроения включается через параметр @useResumableIndexRebuildIfAvailable, который может быть задействован только при использовании операций онлайн перестроения индексов. В примере ниже мы поставим отбор для конкретного индекса, по которому нужно выполнять возобновляемое перестроение. Использовать подобное обслуживание для всех объектов в базе не имеет смысла. Последние два параметра тут основные для примера.</p><div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SQLServerMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_IndexMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token variable" style="color:rgb(156, 220, 254)">@databaseName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;BSL-ORIG&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Разрешаем запуск скрипта с 21:00:00 до 22:30:00</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeFrom</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;21:00:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@timeTo</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;22:30:00&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- (2) - обслуживание только тех объектов, в которых онлайн-перестроение не поддерживается.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@useOnlineIndexRebuild</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Процент фрагментации, с которого будет выполняться обслуживание</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@fragmentationPercentMinForMaintenance</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Процент фрагментации с которого начинается полное перестроение.</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Все, что между 10 и 30 будет обслуживаться операцией реорганизации</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@fragmentationPercentForRebuild</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">30</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Степень параллелизма для операций перестроения оставляем равной 8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@maxDop</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Включаем возобновляемое перестроение индексов</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@useResumableIndexRebuildIfAvailable</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">-- И только для конкретного индекса</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@ConditionIndexName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;= &#x27;&#x27;_AccumRg505_1&#x27;&#x27;&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Но есть и подводный камень! Если индекс находится в списке операций возобновляемых операций перестроения, то его нельзя удалить или перестроить другими операциями. Нужно либо завершить перестроение, либо прервать его окончательно.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Если во время работы скрипта из примера операция будет прервана по таймауту (или вручную), то при следующем запуске этого же скрипта будет действовать такой алгоритм:</p><ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Проверяются списки объектов, для которых нужно выполнить возобновление перестроения. При этом учитываются условия по таблицам и индексам.</li><li>Если такая операция есть в списке, то возобновляем ее работу. Если нет, то идем дальше.</li><li>Далее выполняем обычные операции обслуживания. При этом если на прошлом шаге было завершено возобновляемое перестроение индекса, то на следующих шагах обслуживания эти объекты будут пропущены. Это сделано для того, чтобы один и тот же объект не был перестроен дважды.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Этот механизм является спасительным для многих больших баз данных. А некоторые люди еще говорят, что разницы между SQL Server 2012 и SQL Server 2019 нет, вот им пример :)</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Да здравствует AlwaysOn</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">При включении групп высокой доступности AlwaysOn появляется особый нюанс - если реплика становится недоступной для отправки изменений, то записи в файле лога транзакций не будут удалены даже после выполнения бэкапа лога транзакций. Это сделано для того, чтобы при возобновлении передачи данных не потерять транзакции, которые еще не ушли на копии баз, реплики.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Для обслуживания это может означать, что при каких-то авариях с передачей данных в AlwaysOn лучше повременить с обслуживанием, пока передача данных не будет восстановлена и файл лога транзакций не будет освобождён.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Подобная ситуация может возникнуть не только при сбое связи, а, например, если после перестроения 1 ТБ индекса эти изменения будут отправляться на копии. Пока все изменения после перестроения не “уйдут” на копии, то лог транзакций также не сможет быть освобожден.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Но на самом деле решение этой проблемы у нас уже есть. Выше мы уже говорили про параметры ограничения файла лога транзакций в полной модели восстановления, а также кратко прошлись по созданию резерва для логов. Этот же подход нужно использовать и в нашем случае.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также нужно понимать, что операции обслуживания нужно выполнять только в первичном узле (основной базе), а на копиях баз настраивать обслуживание просто нет смысла. Это же копии в режиме “только для чтения”. Перестроение индексов или обновление статистик там недоступно.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Информацию про использование AlwaysOn <b><u><a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-AlwaysOn" target="_blank" rel="noopener noreferrer">Вы можете посмотреть здесь</a></u></b>, в том числе описание некоторых нюансов и настроек.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Комбо!</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">И напоследок - комбо! Все вышеописанные подходы к настройке можно комбинировать как Вам угодно, главное не делать это вслепую! И лучше всего усложнять обслуживание только по необходимости, подтверждая свои шаги через анализ логов обслуживания.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Если Вы будете использовать служебную базу, о конторой идет речь в этой статье, то все операции перестроения индексов или обновления объектов статистики логируются. Например, в таблице “MaintenanceActionsLog” можно посмотреть когда, как и почему объект обслуживался.</p><div class="Images_article_image__wrapper__QSTzx my-4 Images_size_medium__0iTcB display-block mx-auto my-5"><div aria-owns="rmiz-modal-" data-rmiz=""><div data-rmiz-content="not-found" style="visibility:visible"><img src="/imp_assets/SQLServer/2022-05/few-steps-to-serious-maintenance/10. История обслуживания объектов.png" alt="История обслуживания объектов" width="100%" class="block"/></div></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Вы будете знать обслуживался ли он онлайн, было это перестроение или реорганизация, какой процент фрагментации был на момент обслуживания, сколько записей изменилось с момента обновления статистики, какая SQL-команда использовалась, длительность операции и вообще завершилась ли операция. Операция обслуживания будет взята под полный контроль!</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Также может возникнуть необходимость запускать скрипты перестроения индексов параллельно друг другу, для ускорения обслуживания, например. Но тут возникает нюанс! Если есть активная операция перестроения индекса, то DMV sys.dm_db_index_physical_stats не сможет получить текущее состояние индексов, пока перестроение не будет завершено. В итоге операции перестроения параллельно и не будут запущены. Но и тут есть выход!</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Вы можете запустить сбор информации о состоянии объектов базы данных заранее через команду:</p><div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">EXECUTE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">SQLServerMaintenance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">dbo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">sp_FillDatabaseObjectsState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token variable" style="color:rgb(156, 220, 254)">@databaseName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;BSL-ORIG&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Команда вызовет sys.dm_db_index_physical_stats и сохранит результаты в таблицу “DatabaseObjectsState”. А в скриптах перестроения индексов можно указать параметр @usePreparedInformationAboutObjectsStateIfExists, тогда повторного анализа объектов выполнено не будет и обслуживание будет использовать информацию из таблицы “DatabaseObjectsState”.</p><div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- Используем ранее сохраненную информацию о состоянии объектов базы данных</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token variable" style="color:rgb(156, 220, 254)">@usePreparedInformationAboutObjectsStateIfExists</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                </span></div></pre></div></div><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Но есть нюанс! Информация об объектах базы должна быть собрана в последние 12 часов на момент вызова обслуживания. Иначе информация будет считаться устаревшей и запустится обычный анализ объектов.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Таким образом, можно запускать 2 и более процессов обслуживания индексов, не опасаясь их блокировки друг другом на этапе анализа объектов базы.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Как отслеживать качество обслуживания</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Это отдельная тема, но в самом простом виде можно действовать так:</p><ul class="List_list__zLjGi list-disc pl-[30px]"><li>Следить, чтобы статистика была максимально актуальной. Например, таким скриптом. Так вы увидите есть ли объекты, по которым статистика давно не обновлялась, а также объекты, по которым изменения накапливаются очень быстро. Возможно, нужно делать обновление статистики для них чаще нескольких раз в день.<div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">select</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">TableName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">StatName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">rowmodctr </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">RowsChanged</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    STATS_DATE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">stats_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">LastUpdate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_ms_shipped</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_temporary</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sysindexes a</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">inner</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">join</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">objects o</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">on</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">object_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token operator" style="color:rgb(212, 212, 212)">and</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;U&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token operator" style="color:rgb(212, 212, 212)">and</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token operator" style="color:rgb(212, 212, 212)">and</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indid </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">left</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">join</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">stats s</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">on</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">left</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">join</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> total_pages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">SUM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">total_pages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">partitions p </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOLOCK</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">allocation_units a </span><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">NOLOCK</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">partition_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">container_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> p </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">stats_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">order</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">by</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">rowmodctr </span><span class="token keyword" style="color:rgb(86, 156, 214)">desc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    STATS_DATE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">stats_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ASC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span></div></pre></div></div></li><li>Следить за фрагментацией индексов. Можно использовать уровень детализации “DETAILED” для более точных данных.<div class="bg-blue-500 md:p-5 p-2 my-5"><div class="shadow-lg"><pre class="sc-beySPh jEcCTP prism-code language-sql" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> OBJECT_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ips</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">OBJECT_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NAME</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ips</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">index_type_desc</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">avg_fragmentation_in_percent</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">avg_page_space_used_in_percent</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">page_count</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">dm_db_index_physical_stats</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">DB_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;SAMPLED&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> ips</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">JOIN</span><span class="token plain"> sys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">indexes i </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ips</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">object_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ips</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> avg_fragmentation_in_percent </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span></div></pre></div></div></li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Плюс тяжелые запросы с неоптимальными планами могут подсказать, какие таблицы являются проблемными. Скриптами выше проверьте их состояние.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Но в целом это отдельный разговор. Сегодня об этом речь не идет.</p><h1 class="font-bold text-3xl md:text-4xl my-[10px] mt-10 md:text" style="text-align:unset">Это еще не конец</h1><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Мы прошли долгий путь и каждый шаг дался нам не просто:</p><ul class="List_list__zLjGi list-decimal pl-[30px]"><li>Сначала настроили базовое обслуживание с помощью поставляемых компонентов SQL Server.</li><li>Затем усложнили обслуживание для уменьшения влияния на информационную систему.</li><li>После вынужденно отказались от штатных компонентов и использовали свои скрипты и наработки, поставили ограничения на операции обслуживания, повысили надежность работы и пресекли выход за рамки технологического окна. А также улучшили онлайн обслуживание индексов.</li><li>Далее рассмотрели нюансы при работе в полной модели восстановления базы.</li><li>Разбили обслуживание на регулярное и еженедельное для оптимизации работы.</li><li>Изменили стратегию обслуживания для огромных объектов, внедрив возобновляемое перестроение индексов.</li><li>Рассмотрели особенности обслуживания при использовании AlwaysOn.</li><li>И напоследок обсудили логирование и контроль обслуживания.</li></ul><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Но это не конец пути! Все это лишь показывает, что обслуживание баз данных может адаптироваться под любые требования, было бы желание, деньги и время. Ну и знания, конечно же. Надеюсь, в последнем эта статья поможет и даст старт для изучения вопроса.</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">Желаю создать свой идеальный план и стратегию обслуживания!</p><p class="font-regular mb-3 text-lg leading-relaxed" style="text-align:unset">А эта статья должна в этом помочь.</p></article><div class="Seperator_section_seperator_line__gdWIB dark:border-white border-black"></div><div class="PageLayout_author_and_more__wxN3W mx-auto"><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><div class="flex items-center"><div class="flex items-center justify-center shadow-xl rounded-full overflow-hidden bg-blue-500 shrink-0 w-[60px] h-[60px] mr-3 text-xl"><p class="text-center font-medium text-white">Y</p></div><div class="font-semibold"><p class="text-[20px]  mb-0 mt-0">YPermitin</p><p class="text-xs mt-0 mb-0">.NET, TSQL, DevOps, 1C:Enterprise</p></div></div><p class="text-[16px] mt-2">Developer, just developer.</p><div class="flex items-center flex-wrap mt-3"><a href="https://github.com/YPermitin" target="_blank" class="mr-[15px] text-[32px]" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></div><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><p class="border-b border-gray-300 pb-2 mb-3 font-medium w-full">Поделиться</p><div class="flex flex-wrap items-center"><a class="mr-3" aria-label="facebook-share" href="https://www.facebook.com/sharer/sharer.php?u=https://ypermitin.github.io" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-92.4 233.5h-63.9c-50.1 0-59.8 23.8-59.8 58.8v77.1h119.6l-15.6 120.7h-104V912H539.2V602.2H434.9V481.4h104.3v-89c0-103.3 63.1-159.6 155.3-159.6 44.2 0 82.1 3.3 93.2 4.8v107.9z"></path></svg></a><a class="mr-3" aria-label="twitter-share" href="http://twitter.com/share?text=Check out this article!! &amp;url=https://ypermitin.github.io&amp;hashtags=webdevelopment,javacript,javascriptdaily,webdevelopmenttutorial,tutorial" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm215.3 337.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg></a><a class="mr-3" aria-label="linkedin-share" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ypermitin.github.io&amp;title=Check out this article!!&amp;source=LinkedIn" target="popup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[23px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><button class="mr-3" name="copy-link" aria-label="copy-link"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="text-[30px]" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg></button></div><div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed flex transition-all right-[10px] -bottom-20 opacity-0" role="alert"><strong class="font-bold">Link Copied</strong><span class="pl-5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="pt-1 text-[18px] cursor-pointer" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"></path></svg></span></div></div><div class="bg-white dark:bg-slate-800 dark:border-none border-slate-100 shadow-lg border md:rounded-[8px] px-[15px] py-[10px] mb-[30px] overflow-hidden"><p class="border-b border-gray-300 pb-2 mb-3 font-medium w-full">Другие статьи</p><div class="flex flex-wrap"><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/PostgerSQL/2022-12/simple-maintenance-postgesql/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/PostgreSQL/2022-12/simple-maintenance-postgesql/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Настройка обслуживания PostgreSQL. Основное и простое"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Настройка обслуживания PostgreSQL. Основное и простое</div></div></div><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/DevOps/2022-06/windows-perfomance-counter-and-powershell/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/DevOps/2022-06/windows-perfomance-counter-and-powershell/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Счетчики производительности Windows + PowerShell"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Счетчики производительности Windows + PowerShell</div></div></div><div class="mb-3 cursor-pointer lg:w-1/3 md:w-1/2 w-full md:pr-2" href="/DevOps/2022-05/install-valheim-server-ubuntu-20-04/"><div class=" rounded-[3px] dark:bg-slate-800 border border-slate-200 dark:border-slate-900 flex items-center overflow-hidden shadow-lg hover:shadow-md "><div class="object-cover shrink-0"><img src="/imp_assets/DevOps/2022-05/install-valheim-server-ubuntu-20-04/logo.png" class="w-[120px] h-[70px] mr-2 object-cover" alt="Установка и настройка выделенного сервера Valheim на Ubuntu 20.04"/></div><div class="pr-1 text-[16px] hover:text-blue-500 font-semibold">Установка и настройка выделенного сервера Valheim на Ubuntu 20.04</div></div></div><a class="cursor-pointer hover:text-blue-500 block text-sm py-3 px-2 text-center dark:bg-slate-900 bg-blue-500 rounded text-white font-bold hover:!text-blue-900 dark:hover:!text-slate-400 transition-all" href="/blog/?author=YPermitin"><p>Все статьи от автора: <!-- -->YPermitin</p></a></div></div></div></div></section><div class="dark:bg-slate-900 dark:text-white bg-slate-100 text-black"><div class="md:container flex items-center md:justify-center justify-around flex-wrap md:text-[14px] text-[12px] py-5"><p class="my-0 mr-[10px] md:mr-3">Copyright © <!-- -->2024<!-- --> <!-- -->Убежище инженера</p></div></div></div></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{}},"page":"/SQLServer/2022-05/few-steps-to-serious-maintenance","query":{},"buildId":"GvfOuLEDzQB0S8cyeLVOh","nextExport":true,"autoExport":true,"isFallback":false,"dynamicIds":[7167,1465,9179,6806,1974],"scriptLoader":[]}</script></body></html>