---
layout: post
title: Диагностика работы Zabbix
categories: devOooops
background: '/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/logo.png'
---

Диагностика работы сервера и агента Zabbix. Самые простые способы найти причины неработоспособности.

# Проблемы, проблемы, проблемы...

В предыдущей статье мы рассматривали [процесс установки Zabbix](/devoooops/2020/09/04/Немного-о-мониторинге-и-простой-установке-Zabbix.html). Сегодня мы коснемся основных способов диагностики работы сервера и агента Zabbix, а также решение некоторых возникающих проблем.

Ничего сверхестественного. Только базовая информация, которая дает представление о том куда нужно двигаться при наличии проблем в работе мониторинга на базе Zabbix.

# Как себя чувствует сервер

Бывает, что на сервере возникают какие-либо проблемы, связанные как с самой службой Zabbix-сервера, так и с его взаимодействием с агентами или связанными компонентами. Первый источник информации, который может помочь в поиске причин проблем - это логи Zabbix-сервера. Еще одним важным источником данных может быть сама система мониторинга, которая мониторит сама себя.

## Логи наше все

Логи по традиции мира *.nix хранятся в текстовых файлах и располагаются в каталоге '/var/log/zabbix'.

```bash
[ypermitin@zabbix zabbix]$ ls
zabbix_agentd.log              zabbix_agentd.log-20201011  zabbix_server.log-20201004.gz
zabbix_agentd.log-20201004.gz  zabbix_server.log           zabbix_server.log-20201011
```

В этом же каталоге можно увидеть файлы логов Zabbix-агента. Чаще всего на сервере Zabbix для отслеживания работы сервера установлен агент. Да, Zabbix-сервер следит сам за собой.

Прочитать содержимое можно стандартными для Linux способами:

* Смотрим файл логов с возможностью прокрутки.

```bash
less /var/log/zabbix/zabbix_server.log
```

* Просмотр файла логов в реальном времени.

```bash
tail -f /var/log/zabbix/zabbix_server.log
```

* Смотрим первые записи

```bash
head /var/log/zabbix/zabbix_server.log
```

* Смотрим последние события

```bash
tail -n 30 /var/log/zabbix/zabbix_server.log
```

* Получаем только записи с ошибками

```bash
grep -i error /var/log/zabbix/zabbix_server.log
```

В общем, это самые простые способы прочитать содержимое файла логов. Если Вы знаете что нужно искать, то **grep** Вам в помощью. В противном случае в бой вступает **tail**, но можно выполнять анализ и более сложными способами.

Вот, например, вывод последних 10 событий из файла логов.

```bash
[ypermitin@zabbix zabbix]$ tail -n 10 /var/log/zabbix/zabbix_server.log

  1370:20201016:230008.844 housekeeper [deleted 4601 hist/trends, 0 items/triggers, 0 events, 0 problems, 0 sessions, 0 alarms, 0 audit items in 0.047217 sec, idle for 1 hour(s)]
  1370:20201017:000346.901 executing housekeeper
  1370:20201017:000346.958 housekeeper [deleted 4857 hist/trends, 0 items/triggers, 0 events, 0 problems, 0 sessions, 0 alarms, 0 audit items in 0.053027 sec, idle for 1 hour(s)]
  1386:20201017:002028.428 Zabbix agent item "system.swap.size[,free]" on host "YY-COMP" failed: first network error, wait for 15 seconds
  1394:20201017:002043.521 Zabbix agent item "system.uptime" on host "YY-COMP" failed: another network error, wait for 15 seconds
  1394:20201017:002058.554 Zabbix agent item "agent.ping" on host "YY-COMP" failed: another network error, wait for 15 seconds
  1394:20201017:002113.579 temporarily disabling Zabbix agent checks on host "YY-COMP": host unavailable
  1394:20201017:003815.366 enabling Zabbix agent checks on host "YY-COMP": host became available
  1370:20201017:010352.434 executing housekeeper
  1370:20201017:010352.503 housekeeper [deleted 4599 hist/trends, 0 items/triggers, 0 events, 0 problems, 0 sessions, 0 alarms, 0 audit items in 0.063396 sec, idle for 1 hour(s)]
```

Здесь мы видим события процесса **housekeeper**, который отвечает за удаление устаревшей информации из базы данных мониторинга. Далее идут более интересные события об ошибке связи с хостом "YY-COMP", а также события последующего восстановления соединения с агентом этого хоста.

```bash
 1386:20201017:002028.428 Zabbix agent item "system.swap.size[,free]" on host "YY-COMP" failed: first network error, wait for 15 seconds
  1394:20201017:002043.521 Zabbix agent item "system.uptime" on host "YY-COMP" failed: another network error, wait for 15 seconds
  1394:20201017:002058.554 Zabbix agent item "agent.ping" on host "YY-COMP" failed: another network error, wait for 15 seconds
  1394:20201017:002113.579 temporarily disabling Zabbix agent checks on host "YY-COMP": host unavailable
  1394:20201017:003815.366 enabling Zabbix agent checks on host "YY-COMP": host became available
```

В любом случае, основным источником данных о том, что и как делает процесс Zabbix-сервера, есть ли у него проблемы и другую связанную с ним информацию можно найти в его логах. Метод "тыка" тоже работает, но эффективнее просто посмотреть в файл лога событий.

## Мониторинг системы мониторинга

Благодаря тому, что Zabbix позволяет собирает метрики о состоянии самого себя, мы можем отслеживать некоторые проблемы с его помощью. После установки сервера, по умолчанию в списке хостов содержится сам сервер с шаблоном "Template App Zabbix Server". 

<a href="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/1.%20Шаблон%20сервера%20Zabbix.png" target="_blank">
<img 
  src="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/1.%20Шаблон%20сервера%20Zabbix.png" 
  title="Тригеры для сервера Zabbix" 
  class="img-fluid"
/>
</a>

Этот шаблон является ключевым для диагностики работы Zabbix, т.к. содержит множество полезных метрик и триггеров на критичные события.

<a href="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/2.%20Триггеры%20для%20сервера%20Zabbix.png" target="_blank">
<img 
  src="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/2.%20Триггеры%20для%20сервера%20Zabbix.png" 
  title="Триггеры для сервера Zabbix" 
  class="img-fluid"
/>
</a>

Например, если Вы увидите уведомления о проблеме **"Zabbix poller processes more than 75% busy"** от одного из триггеров этого шаблона, то идем в [официальную документацию](https://www.zabbix.com/documentation/4.0/manual/appendix/performance_tuning) и читаем что это. Можно увидеть, что проблему можно решить изменив параметр "StartPollers" в файле конфигурации Zabbix-сервера. 

Вообще, оптимизация настроек этой системы мониторинга отдельная тема, но должно быть понятно, что следить за сервером Zabbix является неотъемлемой частью мониторинга. Иначе как Вы узнаете, что пора актуализировать настройки сервера или проапгрейдить железо?

# Все в очередь

Кроме логов и мониторинга Zabbix-сервера есть еще один важный показатель, демонстрирующий общую картину производительности процессов системы мониторинга. Причем помогает диагностировать проблемы не только в работе сервера, но и агентов Zabbix.

Речь идет про очередь обработки элементов данных, которая отлично [описана в официальной документации](https://www.zabbix.com/documentation/4.0/ru/manual/config/items/queue). На следующем скриншоте показана идеальная картина, когда никаких очередей нет и все элементы обрабатываются за минимальное время.

<a href="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/3.%20Очередь%20обработки%20элементов%20данных.png" target="_blank">
<img 
  src="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/3.%20Очередь%20обработки%20элементов%20данных.png" 
  title="Очередь обработки элементов данных Zabbix" 
  class="img-fluid"
/>
</a>

Самыми распространёнными причинами увеличения очереди являются:

* Агент сбора данных стал недоступен и не присылает данные / не может ответить на запрос.
* У сервера не хватает ресурсов для выполнения обработки присланных элементов данных или опроса хостов (зависит от типа агента - активный или пассивный).

В случаях, когда Вы будете наблюдать большие значения очередей с периодом обработки более 1 минуты, то стоит насторожиться и начать диагностику сервера и агентов.

Вы всегда можете посмотреть элементы очереди детально, чтобы понять, где именно появилась проблема. Плюс ко всему, очередь обработки сообщений можно добавить в метрики сбора данных мониторинга и привязать на них триггеры. Таким образом, очереди позволяют отслеживать общее состояние как сервера Zabbix, так и состояние всего мониторинга с учетом агентов.

# База данных требует внимания

Zabbix хранит данные метрик в одной из поддерживаемых СУБД: MySQL или PostgreSQL. Для оптимальной производительности обязательно нужно выполнить их настройку. Я предпочитаю использовать PostgreSQL, но тут все полностью зависит от задач.

Касательно PostgreSQL нужно обязательно адаптировать ее настройки под ресурсы сервера, т.к. по умолчанию там установлены максимальные ограничения на используемую память и другие ресурсы. Рекомендую зайти на сайт [PGTune](https://pgtune.leopard.in.ua/#/), который поможет подобрать параметры СУБД под Ваш сервер. Просто берете и переносите их в свой файл конфигурации "postgresql.conf".

Конечно, со временем может понадобиться адаптировать эти параметры под свою нагрузку и задачи. Подробнее о настройках Вы можете [прочитать здесь](https://www.postgresql.org/docs/9.3/config-setting.html).

<a href="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/4.%20База%20Zabbix%20на%20PostgreSQL.png" target="_blank">
<img 
  src="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/4.%20База%20Zabbix%20на%20PostgreSQL.png" 
  title="База данных Zabbix на PostgreSQL" 
  class="img-fluid"
/>
</a>

То же самое относится и к MySQL. Вы можете обратиться к официальной документации, [чтобы узнать больше](https://dev.mysql.com/doc/refman/8.0/en/optimization.html).

Главное помнить, что настройки сервера баз данных являются ключевым фактором для достижения высокой производительности всей системы мониторинга.

# Агент еще жив

Основные способы диагностики сервера Zabbix мы рассмотрели. А что на счет агентов на хостах, которые входят в мониторинг?

Выше уже было упомянуто, что у агента есть свои логи. Именно они и являются основным источником данных для диагностики его работы. Если мы говорим о *.nix системах, то обычно файл лога находится в "/var/log/zabbix/zabbix_agent.log". Вот, например, его содержимое при старте процесса агента.

```bash
[ypermitin@zabbix zabbix]$ tail -n 30 /var/log/zabbix/zabbix_agentd.log
 88139:20201017:164146.511 Starting Zabbix Agent [Zabbix server]. Zabbix 4.0.25 (revision 32662425e6).
 88139:20201017:164146.511 **** Enabled features ****
 88139:20201017:164146.511 IPv6 support:          YES
 88139:20201017:164146.511 TLS support:           YES
 88139:20201017:164146.511 **************************
 88139:20201017:164146.511 using configuration file: /etc/zabbix/zabbix_agentd.conf
 88139:20201017:164146.511 agent #0 started [main process]
 88140:20201017:164146.511 agent #1 started [collector]
 88141:20201017:164146.512 agent #2 started [listener #1]
 88144:20201017:164146.513 agent #5 started [active checks #1]
 88143:20201017:164146.515 agent #4 started [listener #3]
 88142:20201017:164146.516 agent #3 started [listener #2]
```

Это идеальный вариант, когда агент был запущен и никаких проблем с его работой не наблюдается. Но там могут быть и ошибки или информация о проблемах связи. Например, вот это событие говорит о том, что что-то блокирует доступ агента к серверу Zabbix.

```bash
  3900:20201017:002349.716 active check configuration update from [192.168.11.149:10051] started to fail (cannot connect to [[192.168.11.149]:10051]: (null))
```

Может не открыт порт на сервере? Или сервер недоступен? Или ошибка в конфигурационном файле агента?

Аналогичный файл лога есть для агентов всех поддерживаемых операционных систем, в том числе и Windows. Его расположение можно уточнить в самом конфигурационном файле агента в параметре "LogFile". Для Windows это может быть каталог самого агента, например:

```bash
### Option: LogFile
#	Log file name for LogType 'file' parameter.
#
# Mandatory: no
# Default:
# LogFile=

LogFile=C:\Program Files\ZabbixAgent\zabbix_agentd.log
```

В любом случае, если у Вас проблемы в работе агента, то первым делом идем в его логи и смотрим что вообще происходит.

# Решение некоторых проблем

Рассмотрим решение некоторых проблем в работе сервера и агента. Это ни в коем случае не полноценный мануал, а скорее пара заметок. Небольшая порция "траблшутинга". Более развернутую информацию Вы можете найти в [официальной Wiki](https://zabbix.org/wiki/Troubleshooting).

## Немного опечатались

Иногда бывает так, что порты и все доступы настроены, агент установлен, ошибок в логах нет, но метрики не приходят или приходят не полностью. В самом Zabbix хост "горит зеленым" и непонятно, что вообще происходит.

<a href="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/6.%20Все%20ли%20в%20порядке%20с%20хостом.png" target="_blank">
<img 
  src="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/6.%20Все%20ли%20в%20порядке%20с%20хостом.png" 
  title="С хостом вроде все в порядке" 
  class="img-fluid"
/>
</a>

Можно потратить много времени на разбор ситуации, а причина окажется очень проста - ошибка в файле конфигурации из-за "копипасты". То есть конфигурацию скопировали, но в файле не поменяли параметр "Hostname". В итоге сервер Zabbix говорит, что агент доступен, но сам агент присылает данные для другого хоста. Вот так выглядит список дисков для проблемной машины. Нет никакой информации о дисках, но при этом общие показатели агент все же передал.

<a href="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/7.%20Нет%20данных%20о%20дисках%20на%20сервере.png" target="_blank">
<img 
  src="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/7.%20Нет%20данных%20о%20дисках%20на%20сервере.png" 
  title="С хостом вроде все в порядке" 
  class="img-fluid"
/>
</a>

Как только мы исправим в файле конфигурации параметр "Hostname" на нужный (в нашем случае это "SRV-SQL-01-VM"), то картина сразу же изменится. В списке появятся все диски сервера.

<a href="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/8.%20После%20исправления%20настроек%20агента.png" target="_blank">
<img 
  src="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/8.%20После%20исправления%20настроек%20агента.png" 
  title="После исправления настроек агента" 
  class="img-fluid"
/>
</a>

Данные могут появиться не сразу, т.к. правила обнаружения выполняются не так часто, как получение обычных метрик, но Вы можете запустить их вручную в настройках хоста.

Копипаст - зло! Будьте осторожны!

## Ребут и агента нет

Бывают случаи, когда агент был успешно установлен и настроен на хосте, мониторинг работает как надо. НО! При очередном запланированном перезапуске сервера (хоста) Zabbix-агент не смог запуститься.

Причин тому может быть несколько:

* Агент запускается от доменной учетной записи, но на момент старта сервера связи с доменом не оказалось.
* В момент запуска агент пытался запуститься, когда еще не "поднялся" доступ к сети.

При этом в файле лога агента может не быть какой-либо полезной информации, но она есть в системных журналах ОС. Чаще всего это поведение встречал в ОС Windows.

Решение достаточно простое: нужно установить для службы Windows режим запуска **"Автоматически (отложенный запуск)"**. В большинстве случаев проблема будет решена.

<a href="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/5.%20Изменим%20режим%20запуска%20службы%20агента%20Zabbix.png" target="_blank">
<img 
  src="/img/posts/2020/2020-10-17-Диагностика%20работы%20Zabbix/5.%20Изменим%20режим%20запуска%20службы%20агента%20Zabbix.png" 
  title="Изменим режим запуска службы агента Zabbix" 
  class="img-fluid"
/>
</a>

Быстро и просто!

## Особые проблемы со счетчиками

Особой проблемой, которая встречается не очень часто, бывают проблемы со счетчиками производительности Windows. После настройки мониторинга на сервере можно увидеть для хоста элементы данных со статусом "Не поддерживается". При этом все они получаются через показатели производительности Windows. Обратившись к логам агента Zabbix можно увидеть следующее.

```bash
zabbix agent log: check_counter_path(): cannot make counterpath
zabbix agent log: A required argument is missing or not correct.... active check "perf_counter[....]" is not supported
```

При этом для хоста у элементов данных будет такая ошибка.

```bash
ZBX_NOTSUPPORTED: Cannot obtain system information.
```

Проблема в некорректном списке доступных счетчиков производительности Windows на хосте с агентом, то есть на машине, которую мы собираемся мониторить. Можно проверить наличие нужного счетчика через "Монитор производительности" (perfmon.exe) или через ветку реестра:

```bash
"HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Perflib\009"

# Ключ "Counter" содержит список всех доступных счетчиков производительности.
```

Если нужного счетчика нет, то можно попытаться перестроить все счетчики ОС командой:

```bash
lodctr /r

# Утилита находится в "C:\WINDOWS\System32"
```

В большинстве случаев это помогает. Если остаются проблемы со счетчиками производительности сторонних приложений, то нужно изучить документацию по этим счетчикам. Например, для Microsoft SQL Server можно отдельно восстановить счетчики из поставляемых настроек. Подробнее можно [узнать здесь](https://blog.sqlauthority.com/2014/11/07/sql-server-performance-counter-missing-how-to-get-them-back/).

Счетчики производительности для мониторинга Windows - отличный инструмент. И его, конечно же, нужно использовать.

## Таймаут выполнения скриптов

Еще небольшой ошибкой может быть ситуация, когда на сервер не поступают данные по каким-либо элементам данных, а в логах агента можно увидеть ошибки вида:

```bash
ZBX_NOTSUPPORTED: Timeout while executing a shell script
```

Так происходит, поскольку выполняемый скрипт не укладывается в заданное время выполнения. Время задается также в конфигурации агента Zabbix и по умолчанию составляет 3 секунды.

```bash
### Option: Timeout
#	Spend no more than Timeout seconds on processing
#
# Mandatory: no
# Range: 1-30
# Default:
# Timeout=3
```

Имеется три основных варианта решения:

* Увеличить таймаут до подходящего значения. Например, до 30 секунд:

```bash
### Option: Timeout
#	Spend no more than Timeout seconds on processing
#
# Mandatory: no
# Range: 1-30
# Default:
# Timeout=3

Timeout=30
```

* Второй вариант - разобраться в причинах долгого выполнения и попытаться их исправить. Конечно, если это возможно.

* Отказаться от сбора этих метрик :)

В любом случае, посмотрите почему скрипт может выполняться дольше, чем запланировано. Только после этого меняйте настройки.

# Продолжение следует

Это была еще одна небольшая публикация по теме мониторинга с помощью Zabbix. В следующих статьях мы поговорим об обновлении Zabbix с версии 4.0 на 5.0, создадим свой шаблон для сбора метрик и рассмотрим некоторые особенности этого процесса, настроим уведомления в Telegram-канал, а также получении данных с Prometheus и визуализации данных в Grafana. И, конечно же, оптимизация производительности сервера мониторинга Zabbix!

Будьте на связи :)

# Будьте в курсе

Создание материалов будет продолжаться. Хотите быть в курсе последних обновлений? [Подписывайтесь на канал](https://t.me/DevQuietPlace).

По любым вопросам пишите на электронную почту. Адрес в самом низу страницы.