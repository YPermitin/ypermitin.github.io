I"֕<p>Небольшая капля информации о мониторинге и простой установке Zabbix.</p>

<h1 id="что-такое-мониторинг">Что такое мониторинг</h1>

<p>Рано или поздно (а лучше рано) возникают вопросы повышения качества сервисов, улучшения стабильности и быстрого реагирования на возникающие проблемы. Их можно решать различными путями, но самым эффективным и стратегически правильным является разворачивание мониторинга.</p>

<p>При этом под мониторить можно как инфраструктуру, так и вспомогательные сервисы, показатели состояния приложений и бизнес-показатели. Главное, чтобы собираемые данные были востребованы, а не хранились “для галочки” в базах данных до лучших времен.</p>

<p>Обычно от мониторинга ждут следующего:</p>

<ul>
  <li>Оповещение о критических событиях в системе на основе собираемых данных</li>
  <li>Отражение текущего актуального состояния компонентов системы</li>
  <li>Удобная визуализация данных, в т.ч. и за большие периоды</li>
  <li>Построение отчетов</li>
</ul>

<p>При этом на самом старте его разворачивания и настройки чаще всего нет четкого понимания какие инструменты использовать, какие метрики собирать, когда нужно рассылать оповещения и так далее. Вместо того, чтобы надолго уходить в изучение этой темы и месяц выбирать всем отделом систему мониторинга и набор метрик - проще всего воспользоваться готовыми рецептами, которые уже после начала использования адаптировать под себя. Главное, чтобы мониторинг был востребованным, а данные им собираемые могли использоваться на практике.</p>

<p>Таким первым шагом может быть установка системы мониторинга <a href="https://www.zabbix.com/ru">Zabbix</a>. Это не единственное решение, но весьма себя зарекомендовавшее. Другими решениями можно назвать:</p>

<ul>
  <li><a href="https://grafana.com/oss/graphite/">Graphite</a></li>
  <li><a href="https://prometheus.io/">Prometheus</a></li>
  <li><a href="https://grafana.com/">Graphana</a> - интерфейс для визуализации</li>
  <li><a href="https://github.com/statsd/statsd">StatsD</a></li>
  <li>И многие другие.</li>
</ul>

<p>Но мы сегодня остановимся именно на Zabbix. Но не обязательно использовать на рабочем окружении только этот продукт, ведь система мониторинга из нескольких частей или компонентов всегда лучше, чем единый монолит на все случаи и времена. Поэтому использовать вместе с Zabbix, например, Prometheus - просто отлично.</p>

<h1 id="совсем-немного-о-zabbix">Совсем немного о Zabbix</h1>

<p>Он может все! Мониторинг сетей, серверов, облачных ресурсов, сервисов и бизнес показателей. Это мощнейшая система мониторинга распределенного архитектуры, да к тому же и OpenSource. Все самое актуальное и необходимое всегда можно узнать в <a href="https://www.zabbix.com/ru/manuals">официальной документации</a>. А пока кратко пробежимся по возможностям.</p>

<p>Сбор данных Zabbix может выполнят на основе:</p>

<ul>
  <li>Логов</li>
  <li>Интерфейсов</li>
  <li>API</li>
  <li>SNMP</li>
  <li>ping</li>
  <li>Запросов к ресурсам</li>
  <li>Открытых портов</li>
  <li>Анализу запущеных процессов</li>
  <li>Счетчиков производительности ОС</li>
  <li>Информации о СУБД (резервные копии, показатели производительности и др.)</li>
</ul>

<p>Все эти данные позволяют в дальнейшем диагностировать приложения и сервисы, делать правильные решения по улучшению стабильности и производительности. Кроме этого есть возможность использовать шаблоны собираемых показателей и автообнаружение новых машин для мониторинга в сети. В общем, все то, что и должна делать система мониторинга.</p>

<p>Пройдем все основные шаги по установке и началу использования Zabbix.</p>

<h1 id="подготовка-у-становке">Подготовка у становке</h1>

<p>На момент создания публикации выпущена версия Zabbix 5.0, в которой есть различные новые фишки, одна из которых это <a href="https://www.zabbix.com/documentation/current/ru/manual/appendix/install/timescaledb">TimescaleDB</a>, через которую выполнена реализация партиционирования данных при организации хранилища логов на базе PostgreSQL. Но мы не будем ее использовать. Мы пойдем по пути использования предыдущих стабильных версий:</p>

<ul>
  <li><a href="https://www.zabbix.com/documentation/4.0/ru/manual/installation/install_from_packages">Zabbix 4</a></li>
  <li><a href="https://www.centos.org/download/">CentOS 7</a></li>
  <li><a href="https://www.postgresql.org/about/news/1894/">PostgreSQL 11</a></li>
  <li><a href="https://httpd.apache.org/">Apache</a></li>
</ul>

<p>Будем считать, что CentOS уже установлена, а также сконфигурирован firewall, сетевые настройки, SELinux и прочее. Мы лишь остановимся на настройках, непосредственно связанных с Zabbix. Единственное, рекомендую обязательно обновить пакеты, компоненты системы до свежих версий командой:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum update
</code></pre></div></div>

<p>Итак, поехали!</p>

<h1 id="подготавливаем-базу-данных">Подготавливаем базу данных</h1>

<p>Прежде чем устанавливать сам Zabbix, установим и настроим PostgreSQL 11, который будет хранилищем данных системы мониторинга. Конечно, можно было бы представить просто список команд в терминале и остановиться на этом, но это было бы некорректно.</p>

<p>Вместо этого рекомендую сначала перейти на <a href="https://www.postgresql.org/download/linux/redhat/">официальную страницу загрузки / установки PostgreSQL</a>, а уже на ней выбрать операционную систему, версию СУБД, платформу и архитектуру. После этого будет выдана актуальная инструкция по установке СУБД для выбранных параметров. Это может пригодиться, если Вам нужна другая версия СУБД или при использовании другой операционной системы.</p>

<p>Мы же продолжим пример для CentOS 7 и PostgreSQL 11. Устанавливать СУБД будем на тот же сервер, где будет находиться и сам Zabbix. В рабочем окрежении это не всегда правильно и для масштабирования хранилища может потребоваться вынести PostgreSQL на отдельный сервер (или даже нескольких серверов). Но в нашем простом примере все будет на одной машине.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Установка репозитория</span>
<span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm

<span class="c"># Устанавливаем PostgreSQL</span>
<span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> postgresql11-server

<span class="c"># Дополнительные настройки</span>
<span class="c">#   Инициализация кластера баз данных</span>
<span class="nb">sudo</span> /usr/pgsql-11/bin/postgresql-11-setup initdb
<span class="c">#   Включаем автоматический запуск PostgreSQL</span>
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>postgresql-11
<span class="c">#   И запускаем его</span>
<span class="nb">sudo </span>systemctl start postgresql-11
</code></pre></div></div>

<p>Проверим успешно ли прошла установка. Запустим утилиту <a href="https://www.postgresql.org/docs/9.3/app-psql.html">psql</a> и выполним запрос на получение версии СУБД.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Запускаем psql от имени пользователя postgres</span>
<span class="nb">sudo</span> <span class="nt">-u</span> postgres <span class="nt">-i</span> psql

<span class="c"># Выполняем запрос получения версии СУБД</span>
<span class="nv">postgres</span><span class="o">=</span><span class="c"># </span>
SELECT VERSION<span class="o">()</span><span class="p">;</span>

<span class="c"># Пример результата:</span>
<span class="c"># PostgreSQL 11.9 on x86_64-pc-linux-gnu, </span>
<span class="c"># compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-39), 64-bit</span>
</code></pre></div></div>

<p>Ошибок нет - значит все прошло отлично. Можно также провести тюнинг настроек PostgreSQL, но это уже другая история. Можете использовать сервис <a href="https://pgtune.leopard.in.ua/#/">PGTune</a>, чтобы подобрать настройки под себя. Подробнее об этом останавливаться сейчас не будем. На этапе установки Zabbix мы еще вернемся к некоторым настройкам СУБД, но это будет позже.</p>

<h1 id="установка-и-конфигурирование-zabbix">Установка и конфигурирование Zabbix</h1>

<p>Как и с PostgreSQL, прежде чем начать идем на <a href="https://www.zabbix.com/ru/download">официальную страницу выбора параметров</a> для загрузки Zabbix, а после выполняем предложенные инструкции. Для выбранной нами конфигурации получилась <a href="https://www.zabbix.com/ru/download?zabbix=4.0&amp;os_distribution=centos&amp;os_version=7&amp;db=postgresql&amp;ws=apache">вот такая настройка</a>.</p>

<p>Теперь начнем установку Zabbix.</p>

<h2 id="установка-пакетов">Установка пакетов</h2>

<p>Первым делом устанавливаем репозитории, пакеты Zabbix-сервера, веб-интерфейс и агент сбора данных.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Установка репозитория</span>
<span class="nb">sudo </span>rpm <span class="nt">-Uvh</span> https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-2.el7.noarch.rpm
<span class="c"># Предварительная очистка</span>
<span class="nb">sudo </span>yum clean all
</code></pre></div></div>

<p>Теперь все готово для установки пакетов сервера, веб-интерфейса и агента.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Установка основных пакетов сервера, веб-интерфейса и агента</span>
<span class="nb">sudo </span>yum <span class="nb">install </span>zabbix-server-pgsql zabbix-web-pgsql zabbix-apache-conf zabbix-agent
</code></pre></div></div>

<p>Грандиозный успех!</p>

<h2 id="настраиваем-базу-данных">Настраиваем базу данных</h2>

<p>Ранее мы установили СУБД, теперь время создать пользователя баз данных для системы мониторинга.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Создаем пользователя баз данных: zabbix</span>
<span class="c"># Будет запрошен пароль для нового пользователя.</span>
<span class="nb">sudo</span> <span class="nt">-u</span> postgres createuser <span class="nt">--pwprompt</span> zabbix
<span class="c"># Создаем базу данных zabbix, у которой владельцем будет пользователь zabbix (последний параметр)</span>
<span class="nb">sudo</span> <span class="nt">-u</span> postgres createdb <span class="nt">-O</span> zabbix zabbix
</code></pre></div></div>

<p>Когда база создана, необходимо импортировать схему данных базы.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>zcat /usr/share/doc/zabbix-server-pgsql<span class="k">*</span>/create.sql.gz | <span class="nb">sudo</span> <span class="nt">-u</span> zabbix psql zabbix
</code></pre></div></div>

<p>Теперь в файле ‘/etc/zabbix/zabbix_server.conf’ изменим параметр пароля базы данных zabbix:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mcedit /etc/zabbix/zabbix_server.conf
<span class="c"># Ищем 'DBPassword=' и подставляем пароль, указанный выше для пользователя zabbix</span>
</code></pre></div></div>

<h2 id="немного-настроек-для-фронта">Немного настроек для фронта</h2>

<p>Осталась еще одна настройка - это настроить часовой пояс для PHP в файле ‘/etc/httpd/conf.d/zabbix.conf’:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mcedit /etc/httpd/conf.d/zabbix.conf
<span class="c"># Пример конфигурации:</span>
<span class="c"># php_value date.timezone Europe/Moscow</span>
</code></pre></div></div>

<p>Готово!</p>

<h2 id="стартуем-процессы">Стартуем процессы</h2>

<p>Теперь все готово для запуска процессов Zabbix.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Перезапускаем процессы</span>
<span class="nb">sudo </span>systemctl restart zabbix-server zabbix-agent httpd
<span class="c"># Устанавливаем автоматический запуск</span>
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>zabbix-server zabbix-agent httpd
</code></pre></div></div>

<p>После этого все необходимые службы будут запускаться автоматически при старте системы.</p>

<h2 id="ох-уж-эта-безопасность">Ох уж эта безопасность</h2>

<p>Если после этого попытаться зайти через браузер со сторонней машины на фронт Zabbix, то, скорее всего, ничего не выйдет. Нужно настроить фаервол так, чтобы был доступ к веб-интерфейсу Zabbix.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>firewall-cmd <span class="nt">--permanent</span> <span class="nt">--zone</span><span class="o">=</span>public <span class="nt">--add-port</span><span class="o">=</span>80/tcp
<span class="nb">sudo </span>firewall-cmd <span class="nt">--reload</span>
</code></pre></div></div>

<p>Но и это еще не все. Нужно настроить возможность подключаться к базе zabbix по логину и паролю, и только локально. Для этого нужно в файле конфигурации ‘/var/lib/pgsql/11/data/pg_hba.conf’ применить вот такие изменения должны там присутствовать:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span>

<span class="c"># "local" is for Unix domain socket connections only</span>
<span class="nb">local   </span>all             all                                     peer
<span class="c"># IPv4 local connections:</span>

<span class="c"># Разрешаем подключение к базе zabbix пользователю zabbix</span>
<span class="c"># по логину и паролю и только локально (для IPv4)</span>
host&lt;<span class="nt">--</span><span class="o">&gt;</span>zabbix&lt;<span class="o">&gt;</span>&lt;<span class="nt">------</span><span class="o">&gt;</span>zabbix&lt;<span class="o">&gt;</span>&lt;<span class="nt">------</span><span class="o">&gt;</span>127.0.0.1/32&lt;<span class="nt">--</span><span class="o">&gt;</span>&lt;<span class="nt">------</span><span class="o">&gt;</span>password

host    all             all             127.0.0.1/32            ident
<span class="c"># IPv6 local connections:</span>

<span class="c"># Разрешаем подключение к базе zabbix пользователю zabbix</span>
<span class="c"># по логину и паролю и только локально (для IPv6)</span>
host&lt;<span class="nt">--</span><span class="o">&gt;</span>zabbix&lt;<span class="o">&gt;</span>&lt;<span class="nt">------</span><span class="o">&gt;</span>zabbix&lt;<span class="o">&gt;</span>&lt;<span class="nt">------</span><span class="o">&gt;</span>::1/128&gt;&lt;<span class="nt">------</span><span class="o">&gt;</span>&lt;<span class="nt">------</span><span class="o">&gt;</span>password

host    all             all             ::1/128                 ident
<span class="c"># Allow replication connections from localhost, by a user with the</span>
<span class="c"># replication privilege.</span>
<span class="c">#local   replication     all                                     peer</span>
<span class="c">#host    replication     all             127.0.0.1/32            ident</span>
<span class="c">#host    replication     all             ::1/128                 ident</span>
</code></pre></div></div>

<p>Проверяем подключение к базе zabbix с помощью psql:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-W</span> <span class="nt">-U</span> zabbix
</code></pre></div></div>

<p>Если после ввода пароля запустилась сессия работы с PostgreSQL, то все в порядке. В противном случае проверьте настройки файла pg_hba.conf и корректность пароля.</p>

<p>Теперь, если зайти по URL “http://<АдресСервера>/zabbix", то мы попадем на страницу начальной настройки Zabbix.</АдресСервера></p>

<h1 id="мастер-настройки-zabbix">Мастер настройки Zabbix</h1>

<p>Мы находимся на начальной странице настройки Zabbix.</p>

<p>!!! Тут страница начальной настройки</p>

<p>Жмем “Next step” и попадаем на страницу с проверкой всех требований к работе системы мониторинга. Везде должно быть ОК. Если нет, то смотрите документацию по ситуации. Обычно необходимо установить совместимую версию PHP с текущей версией Zabbix.</p>

<p>!!! Версия проверки требований</p>

<p>Идем далее и попадаем на страницу настройки подключения к базе данных. Даже если сейчас введем пароль для пользователя zabbix, то ничего не выйдет. Мы получим ошибку “Error connecting to database.” и не будет понятно почему так произошло.</p>

<p>!!! Ошибка подключения</p>

<p>Но мы ведь настроили firewall и возможность подключаться к zabbix по логину и паролю выше. И все работало! В чем же дело? Ответ не лежит на поверхности и кроется под страшным названием <a href="https://ru.wikipedia.org/wiki/SELinux">SElinux</a> - это система принудительного контроля доступа. Если посмотреть связанные с ней логи в файле ‘/var/log/audit/audit.log’ сразу после возникновения ошибки подключения на фроне Zabbix:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Читаем последние 25 строк из файла логов</span>
<span class="nb">sudo tail</span> <span class="nt">-n</span> 25 /var/log/audit/audit.log
</code></pre></div></div>

<p>то можем увидеть такое сообщение:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type=AVC msg=audit(1599285909.278:1682): avc:  denied  { name_connect } for  pid=9610 comm="httpd" dest=5432 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:postgresql_port_t:s0 tclass=tcp_socket permissive=0
</code></pre></div></div>

<p>Именно SELinux блокирует подключение Apache (https) к PostgreSQL. Интуитивно это понять никак не получится, нужно просто знать :) (а возможно и гуглить). Исправить это можно добавив правило, разрешающее такое подключение:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Включаем правило, разрешающее Apache подключаться к PostgreSQL</span>
setsebool <span class="nt">-P</span> httpd_can_network_connect_db 1

<span class="c"># Проверяем настройку</span>
getsebool httpd_can_network_connect_db
<span class="c"># Должно вернуться: httpd_can_network_connect_db --&gt; on</span>
</code></pre></div></div>

<p>Теперь подключение успешно пройдет и ошибки подключения к базе данных не будет. Переходим к настройке сервера:</p>

<p>!!! Настройка сервера</p>

<p>Здесь нам нужно ввести имя сервера (или IP-адрес), а также имя установки (не обязательно). В нашем простом случае оставлю это без изменений, т.к. ни на что в данном примере не влияет. Перейдя на следующий шаг мы увидим итоговые параметры.</p>

<p>!!! Итоговые настройки</p>

<p>Проверяем их и идем на финальный шаг.</p>

<p>!!! Установка завершена</p>

<p>Ура! Все эти настройки можно будет изменить в конфигурационном файле ‘/etc/zabbix/web/zabbix.conf.php’ по необходимости.</p>

<h1 id="первый-поход-на-фронт">Первый поход на фронт</h1>

<p>Снова идем по адресу ‘http://<АдресСервера>/zabbix' и попадаем на форму аутентификации.</АдресСервера></p>

<p>!!! Форма аутентификации</p>

<p>Для входа используем учетную запись по умолчанию: Admin с паролем zabbix. Не зубудьте потом поменять эти настройки. Далее мы попадаем на главную страницу веб-интерфейса, откуда можем перейти куда угодно.</p>

<p>!!! Пробегаемся по разделам веб-интерфейса</p>

<p>А также уже есть собранные данные для анализа. Это информация о самом сервер Zabbix.</p>

<p>!!! Последние данные</p>

<p>Все готово для использования.</p>

<h1 id="и-снова-проблема">И снова проблема</h1>

<p>Мы рано радовались. Снова появилась проблема - сервер Zabbix не запускается, хотя на этапе настройки веб-интерфейса все могло быть хорошо. В логах ‘/var/log/zabbix/zabbix_server.log’ можно увидеть такую информацию:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>29435:20200905:094034.449 cannot start preprocessing service: Cannot bind socket to "/var/run/zabbix/zabbix_server_preprocessing.sock": [98] Address already in use.

29400:20200905:094034.450 One child process died (PID:29435,exitcode/signal:1). Exiting ...
</code></pre></div></div>
<p>На самом деле все это есть в документации и мы специально пришли к этой проблеме, чтобы разобрать как бороться с ошибками. В официальной документации сказано, что если используется SELinux, то <a href="https://www.zabbix.com/documentation/4.0/ru/manual/installation/install_from_packages/rhel_centos#настройка_selinux">нужно выполнить дополнительные настройки</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># разрешаем соединение веб-сервера с Zabbix</span>
<span class="nb">sudo </span>setsebool <span class="nt">-P</span> httpd_can_connect_zabbix on

<span class="c"># Следующий пункт мы уже сделали ранее</span>
<span class="c"># Если база данных доступна через сеть (включая 'localhost' в случае PostgreSQL) вам также потребуется разрешить соединение между Zabbix веб-интерфейсом и базой данных:</span>
<span class="c"># setsebool -P httpd_can_network_connect_db on</span>

<span class="c"># Перезапускаем Apache</span>
<span class="nb">sudo </span>service httpd restart

</code></pre></div></div>

<p>Но пока и этого недостаточно. Нужно настроить политики SELinux, чтобы разблокировать заблокированные операции Zabbix’а. Для быстрой настройки установим пакет ‘policycoreutils-python’:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum <span class="nb">install </span>policycoreutils-python
</code></pre></div></div>

<p>Теперь мы можем создать правила SELinux на основании событий в логах:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep </span>AVC /var/log/audit/audit.log<span class="k">*</span> | audit2allow <span class="nt">-M</span> systemd-allow<span class="p">;</span> semodule <span class="nt">-i</span> systemd-allow.pp
</code></pre></div></div>

<p>Перезапускаем Zabbix и теперь все готово:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Перезапускаем</span>
<span class="nb">sudo </span>systemctl restart zabbix-server

<span class="c"># Проверяем статус</span>
<span class="nb">sudo </span>systemctl status zabbix-server
</code></pre></div></div>

<p>Конечно, можно было бы просто взять и отключить SELinux и это бы решило проблемы. Но отключать систему безопасности для работы одного приложения считаю неправильным. Хотя бывают ситуации, когда использование SELinux не имеет смысла, но это не наш случай. В любом случае ошибок нет, можно идти дальше.</p>

<h1 id="настраиваем-агента-linux">Настраиваем агента Linux</h1>

<p>Теперь рассмотрим процесс подключения новой машины к мониторингу. Установим агента Zabbix на сервер под управлением CentOS 7.</p>

<p>На самом деле мы это уже в какой-то мере уже сделали, т.к. на сервер Zabbix мы уже станавливали пакет “zabbix-agent”. А в веб-интерфейсе мы уже видели собираемые данные о сервере.</p>

<p>Установку и конфигурирование начнем с самого главного - перейдем на <a href="https://www.zabbix.com/ru/download_agents?version=4.0+LTS&amp;release=4.0.24&amp;os=Linux&amp;os_version=3.0&amp;hardware=amd64&amp;encryption=No+encryption&amp;packaging=Archive">страницу с выбором необходимой версии агента</a>:</p>

<ul>
  <li>Linux</li>
  <li>Версия 3.0</li>
  <li>Платформа AMD64</li>
  <li>Для версии Zabbix 4.0</li>
</ul>

<p>На этой же странице будет ссылка с инструкцией по установке агента. В нашем случае она <a href="hhttps://www.zabbix.com/documentation/4.0/ru/manual/installation/install_from_packages/rhel_centos">находится здесь</a>.</p>

<p>Как и с установкой сервера, сначала рекомендую обновить компоненты системы, пакеты:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum update
</code></pre></div></div>

<p>Далее как и с сервером нужно добавить репозиторий.</p>

<pre><code class="language-basg"># Добавляем репозиторий
sudo rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm
</code></pre>

<p>Установим и сам пакет агента Zabbix, а после запустим его.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Установка пакета агента</span>
<span class="nb">sudo </span>yum <span class="nb">install </span>zabbix-agent

<span class="c"># Запускаем агент</span>
<span class="nb">sudo </span>systemctl start zabbix-agent

<span class="c"># Проверяем состояние</span>
<span class="nb">sudo </span>systemctl status zabbix-agent
</code></pre></div></div>

<p>Запустили мы конечно рано, нужно еще сконфигурировать работу агента. Идем в файл ‘/etc/zabbix/zabbix_agentd.conf’ и изменяем три параметра:</p>

<ul>
  <li>Hostname=<Имя хоста="" для="" Zabbix=""></Имя></li>
  <li>Server=<Имя или="" адрес="" Zabbix-сервера=""></Имя></li>
  <li>ServerActive=<Имя или="" адрес="" Zabbix-сервера=""></Имя></li>
</ul>

<p>После этого перезапускаем агента:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Перезапускаем агента</span>
<span class="nb">sudo </span>systemctl restart zabbix-agent

<span class="c"># Проверяем состояние</span>
<span class="nb">sudo </span>systemctl status zabbix-agent
</code></pre></div></div>

<p>И проверяем логи работы агента. Возьмем последине 30 строк для анализа:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo tail</span> <span class="nt">-n</span> 30 /var/log/zabbix/zabbix_agentd.log
</code></pre></div></div>

<p>Мы получим все что происходило при запуске агента. В нашем примере вывод был таким:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 42693:20200905:172314.572 Starting Zabbix Agent [Zabbix server]. Zabbix 4.0.24 (revision 95be642769).
 42693:20200905:172314.572 **** Enabled features ****
 42693:20200905:172314.572 IPv6 support:          YES
 42693:20200905:172314.572 TLS support:           YES
 42693:20200905:172314.572 **************************
 42693:20200905:172314.572 using configuration file: /etc/zabbix/zabbix_agentd.conf
 42693:20200905:172314.572 agent #0 started [main process]
 42695:20200905:172314.573 agent #2 started [listener #1]
 42694:20200905:172314.574 agent #1 started [collector]
 42696:20200905:172314.574 agent #3 started [listener #2]
 42697:20200905:172314.575 agent #4 started [listener #3]
 42698:20200905:172314.576 agent #5 started [active checks #1]
 42698:20200905:172314.578 active check configuration update from [192.168.11.144:10051] started to fail (cannot connect to [[192.168.11.144]:10051]: [113] No route to host)
</code></pre></div></div>

<p>Мы сразу видим, что при запуске активных проверок появилась ошибка подключения (для моего окружения 192.168.11.144 - это адрес сервера Zabbix). Эта тема выходит за рамки этого материала, но Вы можете <a href="https://www.zabbix.com/documentation/2.0/ru/manual/appendix/items/activepassive">прочитать о пассивных и активных проверках самостоятельно</a>.</p>

<h1 id="настраиваем-агента-windows">Настраиваем агента Windows</h1>

<h1 id="продолжение-следует">Продолжение следует</h1>

:ET